<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="base:app_id" content="6957083ec63ad876c9081cd6" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="fc:miniapp" content="hosted" />
    <meta property="og:title" content="TRANIUM VERSE - Strategy Hub" />
    <meta property="og:description" content="Collect resources and refine Tranium to dominate the Verse. A strategic mining game on Farcaster."
    />
    
    <title>TRANIUM VERSE - Strategy Hub</title>
    <style>
      :root {
        --gold: #ffcc00;
        --neon: #00ffcc;
        --dark: #0a0a00;
        --panel: rgba(255, 255, 255, 0.05);
        --red: #ff4444;
        --disease-red: #ff2222;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: var(--dark);
        overflow: hidden; /* T√ºm sayfa kaydƒ±rmasƒ±nƒ± engelle */
        touch-action: none;
        font-family: "Segoe UI", sans-serif;
        color: white;
        height: 100vh;
        width: 100vw;
      }
      #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
        touch-action: none;
        image-rendering: pixelated;
      }

      /* INTRO SCREEN */
      #introOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #000000 0%, #1a0000 50%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        overflow: hidden;
      }

      .intro-container {
        text-align: center;
        position: relative;
        z-index: 2;
        animation: introFadeIn 1.5s ease-out;
      }

      .disease-logo {
        font-size: min(60px, 12vw);
        font-weight: 900;
        color: var(--disease-red);
        text-transform: uppercase;
        letter-spacing: 8px;
        margin-bottom: 10px;
        text-shadow:
          0 0 20px rgba(255, 34, 34, 0.7),
          0 0 40px rgba(255, 34, 34, 0.5);
        position: relative;
      }

      .disease-logo::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 4px;
        background: linear-gradient(90deg, transparent, var(--disease-red), transparent);
      }

      .presents-text {
        font-size: min(18px, 4vw);
        color: rgba(255, 255, 255, 0.7);
        margin: 20px 0;
        font-weight: 300;
        letter-spacing: 4px;
        animation: pulse 2s infinite;
      }

      .game-title-intro {
        font-size: min(48px, 10vw);
        font-weight: 900;
        color: var(--gold);
        text-transform: uppercase;
        margin: 30px 0;
        text-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
        letter-spacing: 4px;
      }

      .game-subtitle {
        font-size: min(16px, 3.5vw);
        color: rgba(255, 255, 255, 0.6);
        margin-top: 10px;
        font-weight: 300;
        letter-spacing: 2px;
      }

      /* LOADING SCREEN */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a00 0%, #001a00 100%);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .loading-container {
        text-align: center;
        width: 90%;
        max-width: 400px;
        animation: loadingFadeIn 1s ease;
      }

      .loading-logo {
        font-size: min(32px, 7vw);
        font-weight: 900;
        color: var(--neon);
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 3px;
        position: relative;
      }

      .loading-logo::before {
        content: "‚õèÔ∏è";
        margin-right: 10px;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid rgba(0, 255, 204, 0.1);
        border-top-color: var(--neon);
        border-radius: 50%;
        margin: 0 auto 30px;
        animation: spin 1s linear infinite;
      }

      .loading-progress-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .loading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--neon), #00ff88);
        border-radius: 3px;
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      }

      .loading-text {
        font-size: min(18px, 4vw);
        color: var(--neon);
        margin-bottom: 20px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .loading-percentage {
        font-size: min(24px, 5vw);
        font-weight: 900;
        color: var(--gold);
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
      }

      .loading-tip {
        font-size: min(12px, 2.5vw);
        color: rgba(255, 255, 255, 0.5);
        margin-top: 30px;
        font-style: italic;
        max-width: 300px;
        line-height: 1.4;
      }

      /* MAIN OVERLAY - PC DEFAULT */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, #000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        padding: 20px;
        justify-content: space-evenly;
        /* MOBƒ∞LDE KAYDIRMAYI ENGELLEMEK ƒ∞√áƒ∞N: */
        overflow: hidden;
        gap: 0;
        display: none;
      }

      /* HOW TO PLAY SCREEN (FULL OVERLAY) */
      #howToPlayScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.98);
        z-index: 300;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: max(env(safe-area-inset-top), 20px) 20px max(env(safe-area-inset-bottom), 30px) 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overscroll-behavior: contain;
      }

      .close-btn {
        position: absolute;
        top: max(env(safe-area-inset-top), 15px);
        right: 20px;
        font-size: 40px;
        color: var(--red);
        background: none;
        border: none;
        cursor: pointer;
        z-index: 301;
        font-weight: bold;
        line-height: 1;
      }

      .btn-help-open {
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 10px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
      }
      .btn-help-open:before {
        content: "?";
        display: inline-block;
        width: 16px;
        height: 16px;
        background: var(--gold);
        color: black;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 10px;
      }

      /* How to Play Styles */
      .help-container {
        width: 100%;
        max-width: 500px;
        margin-top: 40px;
      }

      .help-card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        width: 100%;
        text-align: left;
        margin-bottom: 20px;
      }
      .help-title {
        color: var(--gold);
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 10px;
        display: block;
        border-bottom: 1px solid rgba(255, 204, 0, 0.3);
        padding-bottom: 8px;
      }
      .help-text {
        color: #ccc;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 15px;
      }
      .help-icon {
        margin-right: 5px;
      }
      .warning-text {
        color: var(--disease-red);
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        padding: 10px;
        border: 1px solid var(--disease-red);
        background: rgba(255, 34, 34, 0.1);
        border-radius: 8px;
        margin-top: 20px;
      }

      /* Modal responsive d√ºzenlemeleri */
      .custom-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        max-height: 80vh;
        overflow-y: auto;
        background: #000;
        border: 2px solid var(--gold);
        border-radius: 20px;
        padding: 20px;
        z-index: 200;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 204, 0, 0.2);
        touch-action: pan-y;
      }
      #endGameModal {
        border-color: var(--neon);
        box-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
      }
      #upgradeModal {
        border-color: var(--neon);
      }

      .modal-input {
        width: 100%;
        padding: 15px;
        margin: 15px 0;
        background: #111;
        border: 1px solid #333;
        color: white;
        text-align: center;
        border-radius: 8px;
        font-size: 16px;
        min-height: 50px;
      }

      .percentage-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }
      .pct-btn {
        background: #222;
        border: 1px solid #444;
        color: var(--gold);
        padding: 12px 0;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        min-height: 44px;
      }
      .pct-btn:active {
        background: var(--gold);
        color: #000;
      }

      .modal-btn-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .modal-btn {
        flex: 1;
        padding: 15px;
        border-radius: 10px;
        border: none;
        font-weight: 900;
        cursor: pointer;
        text-transform: uppercase;
        min-height: 50px;
      }

      /* UI ELEMENTS - PC DEFAULT */
      .header {
        text-align: center;
        margin-top: env(safe-area-inset-top);
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
      }
      .game-title {
        color: var(--gold);
        font-size: 22px;
        font-weight: 900;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin: 10px 0;
      }
      .tranium-circle {
        margin: 15px auto 10px auto;
        width: 85px;
        height: 85px;
        border: 3px solid var(--gold);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255, 204, 0, 0.1);
        box-shadow: 0 0 15px rgba(255, 204, 0, 0.3);
        flex-shrink: 0;
      }
      .tranium-val {
        font-size: 28px;
        font-weight: 900;
        color: var(--gold);
      }
      .tranium-lbl {
        font-size: 9px;
        font-weight: bold;
      }

      .resource-section {
        width: 100%;
        max-width: 380px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 0 10px;
        flex-shrink: 1;
        /* K√º√ß√ºlmesine izin ver */
      }
      .res-card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .res-name {
        font-size: 11px;
        color: var(--gold);
        font-weight: bold;
        display: block;
      }
      .res-amount {
        font-size: 20px;
        font-weight: 800;
        display: block;
        margin: 5px 0;
      }
      .res-info {
        font-size: 10px;
        color: var(--neon);
        opacity: 0.9;
      }

      .btn-refine {
        width: 100%;
        max-width: 380px;
        background: var(--gold);
        color: #000;
        border: none;
        padding: 18px;
        border-radius: 12px;
        font-weight: 900;
        cursor: pointer;
        text-transform: uppercase;
        box-shadow: 0 4px 0 #b89600;
        font-size: 14px;
        min-height: 60px;
        margin: 10px 0;
        flex-shrink: 0;
      }
      .btn-refine:disabled {
        background: #333;
        color: #666;
        box-shadow: none;
        transform: translateY(4px);
      }

      .btn-upgrade-menu {
        background: var(--neon);
        color: #000;
        box-shadow: 0 4px 0 #00b894;
        margin-top: 10px;
      }

      .factory-modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        width: 100%;
      }
      .fac-card {
        background: rgba(0, 255, 204, 0.03);
        border: 1px solid rgba(0, 255, 204, 0.3);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        min-height: 120px;
      }
      .fac-header {
        font-size: 10px;
        font-weight: bold;
        color: var(--neon);
        text-align: center;
        margin-bottom: 8px;
      }
      .btn-upgrade {
        background: var(--neon);
        color: #000;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 10px;
        cursor: pointer;
        min-height: 44px;
        margin-top: auto;
      }

      /* FOOTER */
      .footer {
        width: 100%;
        max-width: 380px;
        text-align: center;
        padding: 15px 10px;
        margin-top: auto;
        margin-bottom: max(env(safe-area-inset-bottom), 20px);
        flex-shrink: 0;
      }
      .energy-info {
        font-size: 16px;
        font-weight: bold;
        color: var(--gold);
        margin-bottom: 15px;
        display: block;
      }
      .btn-start {
        width: 100%;
        background: var(--gold);
        color: #000;
        padding: 20px;
        border-radius: 40px;
        border: none;
        font-size: 20px;
        font-weight: 900;
        cursor: pointer;
        min-height: 70px;
        box-shadow: 0 6px 0 #b89600;
      }

      /* Oyun i√ßi UI */
      #ui {
        position: absolute;
        top: max(env(safe-area-inset-top), 15px);
        left: 15px;
        right: 15px;
        pointer-events: none;
        display: flex;
        justify-content: space-between;
        z-index: 10;
        opacity: 0;
        font-weight: bold;
        text-shadow: 2px 2px 4px black;
        font-size: min(14px, 3.5vw);
      }

      .reset-link {
        color: var(--neon);
        font-size: 12px;
        text-decoration: none;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--neon);
        border-radius: 8px;
        display: block;
        width: 100%;
        max-width: 250px;
        font-weight: bold;
        margin: 10px 0;
        padding: 10px;
        min-height: 44px;
        flex-shrink: 0;
      }

      /* Joystick Stilleri */
      #joystickContainer {
        position: fixed;
        left: 25px;
        bottom: 25px;
        width: 120px;
        height: 120px;
        z-index: 20;
        display: none;
        pointer-events: auto;
      }

      #joystickBase {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      }

      #joystickHandle {
        position: absolute;
        width: 60px;
        height: 60px;
        background: rgba(255, 204, 0, 0.9);
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
      }

      /* ANIMATIONS */
      @keyframes introFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      @keyframes loadingFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      /* --- KRƒ∞Tƒ∞K MOBƒ∞L OPTƒ∞Mƒ∞ZASYON (FIT TO SCREEN) --- */
      /* √ñzellikle kƒ±sa ekranlƒ± telefonlar (iPhone 6/7/8 gibi 667px y√ºksekliƒüinde) i√ßin */
      @media (max-width: 600px) and (max-height: 850px) {
        /* ANA MEN√ú OPTƒ∞Mƒ∞ZASYONU */
        #overlay {
          justify-content: space-evenly;
          /* √ñƒüeleri dikeyde e≈üit daƒüƒ±t */
          padding: 10px;
          gap: 0;
          /* Gap yerine space-evenly kullan */
          padding-bottom: max(env(safe-area-inset-bottom), 10px);
        }

        .header {
          margin-top: 0;
          margin-bottom: 0;
        }

        .game-title {
          font-size: 18px;
          margin: 2px 0;
        }

        .tranium-circle {
          width: 65px;
          height: 65px;
          margin: 5px auto;
          border-width: 2px;
        }
        .tranium-val {
          font-size: 20px;
        }
        .tranium-lbl {
          font-size: 8px;
        }

        .btn-help-open {
          padding: 4px 12px;
          font-size: 10px;
          margin-bottom: 2px;
          min-height: 25px;
        }

        .reset-link {
          padding: 5px;
          min-height: 30px;
          font-size: 10px;
          margin: 2px 0;
          max-width: 200px;
        }

        .resource-section {
          gap: 8px;
          margin: 2px 0;
        }

        .res-card {
          padding: 8px;
          min-height: 60px; /* Kart y√ºksekliƒüini d√º≈ü√ºr */
        }
        .res-name {
          font-size: 10px;
        }
        .res-amount {
          font-size: 16px;
          margin: 2px 0;
        }
        .res-info {
          font-size: 9px;
        }

        .btn-refine {
          padding: 10px;
          min-height: 45px; /* Butonlarƒ± k√º√ß√ºlt */
          font-size: 12px;
          margin: 8px 0;
        }

        .footer {
          padding: 5px;
          margin-bottom: 5px;
        }
        .energy-info {
          font-size: 12px;
          margin-bottom: 5px;
        }
        .btn-start {
          padding: 10px;
          min-height: 50px;
          font-size: 16px;
        }

        /* HOW TO PLAY EKRANI OPTƒ∞Mƒ∞ZASYONU (NO SCROLL) */
        #howToPlayScreen {
          justify-content: center;
          /* Ortala */
          padding: 10px;
          overflow: hidden;
          /* Kaydƒ±rmayƒ± kapat */
        }

        #howToPlayScreen .header {
          margin-top: 0;
          margin-bottom: 5px;
        }

        #howToPlayScreen .game-title {
          font-size: 16px;
          /* Ba≈ülƒ±ƒüƒ± k√º√ß√ºlt */
          margin: 0;
        }

        #howToPlayScreen .close-btn {
          font-size: 30px;
          top: 10px;
          right: 15px;
          z-index: 302;
        }

        .help-container {
          margin-top: 5px;
          width: 100%;
        }

        .help-card {
          padding: 10px;
          display: flex;
          flex-direction: column;
          gap: 5px; /* √ñƒüeler arasƒ± bo≈üluk */
        }

        .warning-text {
          font-size: 11px;
          padding: 5px;
          margin-top: 0;
          margin-bottom: 5px;
        }

        .help-title {
          font-size: 11px;
          margin-bottom: 2px;
          padding-bottom: 2px;
          border-bottom-width: 1px;
        }

        .help-text {
          font-size: 10px;
          line-height: 1.2;
          margin-bottom: 4px; /* Paragraf bo≈üluƒüunu azalt */
        }
        /* Son elemanƒ±n marginini sƒ±fƒ±rla */
        .help-text:last-child {
          margin-bottom: 0;
        }

        /* Joystick mobilde biraz daha k√º√ß√ºk olsun */
        #joystickContainer {
          width: 90px;
          height: 90px;
          left: 15px;
          bottom: 15px;
        }
        #joystickHandle {
          width: 45px;
          height: 45px;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@0.0.26/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

    <script>
      (async function() {
        console.log("üöÄ SDK Ba≈ülatƒ±cƒ± Tetiklendi (HEAD)");
        const start = Date.now();
        // 5 saniye boyunca her 50ms'de bir SDK'yƒ± kontrol et
        while (Date.now() - start < 5000) {
          const sdk = window.sdk || window.FarcasterFrameSDK || window.Farcaster;
          if (sdk && sdk.actions) {
            // SDK bulundu, anƒ±nda Ready sinyalini g√∂nder
            sdk.actions.ready();
            console.log("‚úÖ Farcaster READY sinyali g√∂nderildi! (HEAD)");
            
            // Context bilgisini de arka planda al
            if (sdk.context) {
                sdk.context.then(ctx => {
                    window.farcasterContext = ctx;
                    console.log("Context alƒ±ndƒ±:", ctx);
                }).catch(e => console.log(e));
            }
            return; // ƒ∞≈ülem tamam, d√∂ng√ºden √ßƒ±k
          }
          // Bulamazsan 50ms bekle
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        console.log("‚ö†Ô∏è SDK zaman a≈üƒ±mƒ±na uƒüradƒ± (HEAD)");
      })();
    </script>

  </head>
  <body>
    <div id="introOverlay">
      <div class="intro-container">
        <div class="disease-logo">DISEASES GAMES</div>
        <div class="presents-text">PRESENTS</div>
        <div class="game-title-intro">TRANIUM VERSE</div>
        <div class="game-subtitle">TRANIUM VERSE</div>
    
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="loading-container">
        <div class="loading-logo">TRANIUM VERSE</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Systems</div>
        <div class="loading-percentage">0%</div>
        <div class="loading-progress-container">
          <div class="loading-progress-bar"></div>
        </div>
        <div class="loading-tip">Tip: Collect miners to increase resource production.
      Avoid infected enemies!</div>
      </div>
    </div>

    <div id="ui">
      <div id="resUI">‚öôÔ∏è: 0 |
      üíé: 0</div>
      <div id="healthUI" style="color: #ff4444">‚ù§Ô∏è: 3</div>
      <div id="energyUI">‚ö°: 10/10</div>
    </div>

    <div id="joystickContainer">
      <div id="joystickBase"></div>
      <div id="joystickHandle"></div>
    </div>

    <div id="endGameModal" class="custom-modal">
      <h2 style="color: var(--neon); margin: 0">FINISH & SUBMIT</h2>
      <p style="font-size: 13px; margin: 15px 0; color: #ddd">
        Your current Tranium will be submitted as your score.
      You can start again with energy.
      </p>
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333; color: white" onclick="closeEndGameConfirmation()">
          CANCEL
        </button>
        <button class="modal-btn" style="background: var(--neon); color: black" onclick="triggerManualEndGame()">
          SUBMIT
        </button>
      </div>
    </div>

    <div id="upgradeModal" class="custom-modal">
      <h2 
      style="color: var(--neon); margin: 0 0 10px 0">FACTORY UPGRADES</h2>
      <p style="font-size: 10px; color: #888; margin: 0 0 15px 0">üíé Payment: Base Network ETH</p>
      <div class="factory-modal-grid">
        <div class="fac-card">
          <span class="fac-header">METAL FACTORY</span>
          <span id="metalFacLevel" style="font-size: 9px; text-align: center; margin-bottom: 3px">Lvl 1</span>
          <span id="metalBuildTime" style="font-size: 8px; text-align: center; margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
        
        <button id="upMetalFac" class="btn-upgrade" onclick="upgradeFactory('metal')">
            UPGRADE <span id="costMetalFac"></span>
          </button>
        </div>
        <div class="fac-card">
          <span class="fac-header">CRYSTAL FACTORY</span>
          <span id="kristalFacLevel" style="font-size: 9px;
      text-align: center; margin-bottom: 3px">Lvl 1</span>
          <span id="kristalBuildTime" style="font-size: 8px; text-align: center;
      margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
          <button id="upKristalFac" class="btn-upgrade" onclick="upgradeFactory('kristal')">
            UPGRADE <span id="costKristalFac"></span>
          </button>
        </div>
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333;
      color: white" onclick="closeUpgradeModal()">CLOSE</button>
      </div>
    </div>

    <div id="swapModal" class="custom-modal">
      <h2 style="color: var(--gold);
      margin: 0; font-size: 18px">TRANIUM REFINERY</h2>
      <p style="font-size: 11px; margin: 10px 0;
      color: #aaa">Refine Metal & Crystal into Tranium (1:1)</p>

      <div class="percentage-row">
        <button class="pct-btn" onclick="setSwapPct(0.25)">25%</button>
        <button class="pct-btn" onclick="setSwapPct(0.50)">50%</button>
        <button class="pct-btn" onclick="setSwapPct(0.75)">75%</button>
        <button class="pct-btn" onclick="setSwapPct(1.00)">100%</button>
      </div>

      <input type="number" id="swapAmountInput" class="modal-input" placeholder="Enter amount..." min="1" />

      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333;
      color: white" onclick="closeSwapModal()">BACK</button>
        <button class="modal-btn" style="background: var(--gold);
      color: black" onclick="executeSwap()">REFINE</button>
      </div>
    </div>

    <div id="howToPlayScreen">
      <button class="close-btn" onclick="closeHowToPlay()">&times;</button>

      <div class="header">
        <h1 class="game-title">HOW TO PLAY</h1>
      </div>

      <div class="help-container">
        <div class="help-card">
          <div class="warning-text">‚ö†Ô∏è DON'T FORGET:<br />TRANIUM = SCORE</div>

          <span class="help-title">üéØ MISSION OBJECTIVE</span>
      
          <p class="help-text">
            Collect resources and refine Tranium to dominate the Verse. Survive against the infected swarm.
          </p>

          <span class="help-title">‚õèÔ∏è RESOURCES</span>
          <p class="help-text">
            <span class="help-icon">‚öôÔ∏è</span> <b>Metal & Crystal:</b> Produced automatically by miners. Find miners in
            the world 
      to increase production.<br />
            <span class="help-icon">üü°</span> <b>Tranium:</b> The ultimate currency.
      Use the "REFINE" button to convert
            Metal and Crystal into Tranium.
      </p>

          <span class="help-title">üè≠ FACTORIES</span>
          <p class="help-text">
            Upgrade your Metal and Crystal factories to boost miner efficiency.
      Higher levels mean faster production
            speeds per miner.
      </p>

          <span class="help-title">‚ö†Ô∏è ENEMIES</span>
          <p class="help-text">
            Avoid the infected (Red Circles).
      They will chase you. If they touch you 3 times, the mission fails.
      </p>

          <span class="help-title">‚ö° ENERGY SYSTEM</span>
          <p class="help-text">
            Every mission costs 1 Energy.
      Energy regenerates over time (1 per hour) even when you are offline.
      </p>
        </div>
      </div>
    </div>

    <div id="overlay">
      <div class="header">
        <h1 class="game-title">TRANIUM VERSE</h1>
        <div class="tranium-circle">
          <span id="traniumCount" class="tranium-val">0</span>
          <span class="tranium-lbl">TRANIUM</span>
        </div>
        <button class="btn-help-open" onclick="openHowToPlay()">HOW TO PLAY</button>
      </div>

  
      <div class="resource-section">
        <div class="res-card">
          <span class="res-name">‚öôÔ∏è METAL</span>
          <span id="metalCount" class="res-amount">0</span>
          <span id="metalWorkers" class="res-info">0 Miners</span>
        </div>
        <div class="res-card">
          <span class="res-name">üíé CRYSTAL</span>
          <span id="kristalCount" class="res-amount">0</span>
        
        <span id="kristalWorkers" class="res-info">0 Miners</span>
        </div>
      </div>

      <button id="swapBtn" class="btn-refine" onclick="openSwapModal()">Refine Tranium (1:1)</button>

      <div style="height: 40px;"></div>

      <button class="btn-refine btn-upgrade-menu" onclick="openUpgradeModal()">üè≠ FACTORY UPGRADES</button>

      <div class="footer">
        <span id="energyStatus" class="energy-info">‚ö° ENERGY: 10/10</span>
        <button class="btn-start" onclick="attemptStart()">START MISSION</button>
      </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
      // Ana oyun deƒüi≈ükenleri
      let farcasterSDK = null; // Head script'ten doldurulacak
      let isMiniApp = false;
      
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const WORLD_SIZE = 2500;

      let metal = 0,
        kristal = 0,
        tranium = 0,
        metalWorkers = 0,
        kristalWorkers = 0;
      let metalFacLvl = 1,
        kristalFacLvl = 1,
        energy = 10,
        lastTime = Date.now();
      // CHANGED: Speed reduced from 0.005 to 0.001 (5x slower)
      const BASE_WORKER_SPEED = 0.001;
      let health = 3,
        isStarted = false,
        isTouching = false;
      let walkCycle = 0,
        camera = { x: 0, y: 0 };
      let player = {
        x: WORLD_SIZE / 2,
        y: WORLD_SIZE / 2,
        speed: 7.5,
        targetX: WORLD_SIZE / 2,
        targetY: WORLD_SIZE / 2,
        flipX: false,
        isMoving: false,
      };
      let lastUpdate = Date.now();
      let workers = [],
        enemies = [];
      // Joystick deƒüi≈ükenleri
      let joystickActive = false;
      let joystickCenterX = 0;
      let joystickCenterY = 0;
      let joystickHandleX = 0;
      let joystickHandleY = 0;
      let joystickDirection = { x: 0, y: 0 };
      const JOYSTICK_RADIUS = 60;
      const JOYSTICK_HANDLE_RADIUS = 30;

      // Enerji geri sayƒ±m deƒüi≈ükenleri
      let nextEnergyTime = 0;
      let energyTimer = null;
      let energyRegenerationStartTime = 0;

      // Loading deƒüi≈ükenleri
      let totalAssets = 0;
      let loadedAssets = 0;
      let loadingInterval = null;

      // Factory y√ºkseltme deƒüi≈ükenleri
      let metalFacUpgradeEndTime = 0;
      let kristalFacUpgradeEndTime = 0;

      const imgBG = new Image();
      imgBG.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/bg-H8I42XFyjR45PCLXsG4fQp7B323kKw.webp?37vf";
      const imgDayi = new Image();
      imgDayi.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69";
      const imgMiner1 = new Image();
      imgMiner1.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner1-removebg-preview-49BIGjfxcrYSez39WOvCLyIxeY56q2.webp?pMVT";
      const imgMiner2 = new Image();
      imgMiner2.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner2-removebg-preview-d2bFviiOsn7cXyHcptbNJtKdHoMuvp.webp?1b6n";
      const imgInfected = new Image();
      imgInfected.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/infect-removebg-preview-5HhmhH4V5DqNbYNXhiFg3o9Z0RkEIj.webp?uN63";
      // How to Play Logic
      function openHowToPlay() {
        document.getElementById("howToPlayScreen").style.display = "flex";
      }
      function closeHowToPlay() {
        document.getElementById("howToPlayScreen").style.display = "none";
      }

      // Upgrade Modal Logic
      function openUpgradeModal() {
        document.getElementById("upgradeModal").style.display = "block";
      }
      function closeUpgradeModal() {
        document.getElementById("upgradeModal").style.display = "none";
      }

      // End Game Logic (Replaces Hard Reset)
      function openEndGameConfirmation() {
        document.getElementById("endGameModal").style.display = "block";
      }
      function closeEndGameConfirmation() {
        document.getElementById("endGameModal").style.display = "none";
      }
      function triggerManualEndGame() {
        closeEndGameConfirmation();
      // Use Farcaster SDK if available, otherwise fallback
        // SDK'yƒ± pencereden al (head script'ten gelmi≈ü olabilir)
        const sdk = window.sdk || window.FarcasterFrameSDK || window.Farcaster;
        if (sdk) {
          console.log("Game Over! Score: " + Math.floor(tranium));
          alert("Game Over! Your score: " + Math.floor(tranium) + " TRANIUM");
          if (sdk.actions && sdk.actions.close) {
            sdk.actions.close();
          }
        } else {
          alert("Game Over Triggered! Score sent: " + Math.floor(tranium));
      location.reload();
        }
      }

      function openSwapModal() {
        document.getElementById("swapModal").style.display = "block";
      document.getElementById("swapAmountInput").value = "";
      }
      function closeSwapModal() {
        document.getElementById("swapModal").style.display = "none";
      }
      function setSwapPct(pct) {
        let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));
      document.getElementById("swapAmountInput").value = Math.floor(maxRefine * pct);
      }
      function executeSwap() {
        let amount = parseInt(document.getElementById("swapAmountInput").value);
      let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));
        if (amount > 0 && amount <= maxRefine) {
          tranium += amount;
      metal -= amount;
          kristal -= amount;
          updateUI();
          saveData();
          closeSwapModal();
        } else {
          alert("Invalid amount or insufficient resources!");
      }
      }

      // Load Data
      if (localStorage.getItem("w_last_time")) {
        metal = parseFloat(localStorage.getItem("w_metal")) ||
      0;
        kristal = parseFloat(localStorage.getItem("w_kristal")) || 0;
        tranium = parseInt(localStorage.getItem("w_tranium")) || 0;
        metalWorkers = parseInt(localStorage.getItem("w_mw")) || 0;
        kristalWorkers = parseInt(localStorage.getItem("w_kw")) ||
      0;
        metalFacLvl = parseInt(localStorage.getItem("w_mfl")) || 1;
        kristalFacLvl = parseInt(localStorage.getItem("w_kfl")) || 1;

        let savedEnergy = localStorage.getItem("w_energy");
      if (savedEnergy !== null) {
          energy = parseInt(savedEnergy);
      } else {
          energy = 10;
      }

        lastTime = parseInt(localStorage.getItem("w_last_time")) || Date.now();
      // Enerji sistemini y√ºkle
        nextEnergyTime = parseInt(localStorage.getItem("w_next_energy_time")) || 0;
        energyRegenerationStartTime = parseInt(localStorage.getItem("w_energy_reg_start")) ||
      0;

        // Factory y√ºkseltme zamanlarƒ±nƒ± y√ºkle
        metalFacUpgradeEndTime = parseInt(localStorage.getItem("w_mfue")) || 0;
      kristalFacUpgradeEndTime = parseInt(localStorage.getItem("w_kfue")) || 0;

        // Offline enerji yenilenmesini kontrol et
        updateOfflineEnergyRegeneration();
      }

      // INTRO VE LOADING Sƒ∞STEMƒ∞
      async function startIntro() {
        // SDK ba≈ülatma kodu buradaydƒ±, artƒ±k HEAD kƒ±smƒ±nda.
        // Sadece intro animasyonunu ba≈ülatƒ±yoruz.
        const introOverlay = document.getElementById("introOverlay");
        introOverlay.style.display = "flex";

        setTimeout(() => {
          introOverlay.style.display = "none";
          startLoading();
        }, 3000);
      }

      function startLoading() {
        const loadingOverlay = document.getElementById("loadingOverlay");
      const progressBar = document.querySelector(".loading-progress-bar");
        const percentageText = document.querySelector(".loading-percentage");
        const loadingText = document.querySelector(".loading-text");

        loadingOverlay.style.display = "flex";

        let progress = 0;
      const loadingMessages = [
          "Initializing Systems",
          "Loading Resources",
          "Preparing Miners",
          "Setting Up Factories",
          "Calibrating Energy Grid",
          "Ready to Mine!",
        ];
      let messageIndex = 0;

        loadingInterval = setInterval(() => {
          if (progress < 100) {
            progress += Math.random() * 10 + 5;
            if (progress > 100) progress = 100;

            if (progress % 15 < 5 && messageIndex < loadingMessages.length - 1) {
              messageIndex = Math.min(Math.floor(progress / 
      15), loadingMessages.length - 1);
              loadingText.textContent = loadingMessages[messageIndex];
            }

            progressBar.style.width = progress + "%";
            percentageText.textContent = Math.floor(progress) + "%";
          }
        }, 150);
      loadAssets();
      }

      function loadAssets() {
        totalAssets = 5;
      const images = [imgBG, imgDayi, imgMiner1, imgMiner2, imgInfected];

        images.forEach((img) => {
          if (img.complete) {
            assetLoaded();
          } else {
            img.onload = assetLoaded;
            img.onerror = assetLoaded;
          }
        });
      }

      function assetLoaded() {
        loadedAssets++;
      if (loadedAssets >= totalAssets) {
          setTimeout(completeLoading, 500);
      }
      }

      function completeLoading() {
        clearInterval(loadingInterval);
      const progressBar = document.querySelector(".loading-progress-bar");
        const percentageText = document.querySelector(".loading-percentage");
        const loadingText = document.querySelector(".loading-text");

        progressBar.style.width = "100%";
        percentageText.textContent = "100%";
      loadingText.textContent = "Ready to Mine!";

        setTimeout(() => {
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("overlay").style.display = "flex";
          initHub();
        }, 1000);
      }

      // ENERJƒ∞ Sƒ∞STEMƒ∞
      function updateOfflineEnergyRegeneration() {
        const now = Date.now();
      // Eƒüer enerji 10'dan azsa ve yenilenme ba≈ülamƒ±≈üsa
        if (energy < 10 && energyRegenerationStartTime > 0) {
          const timePassed = now - energyRegenerationStartTime;
      const energyToAdd = Math.floor(timePassed / 3600000); // Her 1 saat (3600000 ms) i√ßin 1 enerji

          if (energyToAdd > 0) {
            // Enerji ekle (maksimum 10'a kadar)
            const newEnergy = Math.min(10, energy + energyToAdd);
      const addedEnergy = newEnergy - energy;

            if (addedEnergy > 0) {
              energy = newEnergy;
      // Enerji yenilenme ba≈ülangƒ±√ß zamanƒ±nƒ± g√ºncelle
              // Kalan s√ºre i√ßin ba≈ülangƒ±cƒ± ayarla
              energyRegenerationStartTime = now - (timePassed % 3600000);
      // Eƒüer enerji 10 olduysa, sƒ±fƒ±rla
              if (energy >= 10) {
                energyRegenerationStartTime = 0;
      nextEnergyTime = 0;
              } else {
                // Bir sonraki enerji zamanƒ±nƒ± hesapla
                nextEnergyTime = energyRegenerationStartTime + 3600000;
      }

              saveData();
              updateUI();
      }
          } else if (nextEnergyTime > 0 && nextEnergyTime <= now) {
            // Zaman dolduysa 1 enerji ekle
            if (energy < 10) {
              energy++;
      updateEnergyTimers();
              saveData();
              updateUI();
            }
          }
        } else if (energy < 10 && energyRegenerationStartTime === 0) {
          // Enerji yenilenmesi hi√ß ba≈ülamamƒ±≈ü, ≈üimdi ba≈ülat
          updateEnergyTimers();
      }
      }

      function updateEnergyTimers() {
        const now = Date.now();
      if (energy < 10) {
          if (energyRegenerationStartTime === 0) {
            // ƒ∞lk kez enerji yenilenmesi ba≈ülatƒ±lƒ±yor
            energyRegenerationStartTime = now;
      }

          // Bir sonraki enerji zamanƒ±nƒ± hesapla
          const timeSinceStart = now - energyRegenerationStartTime;
      const energyGained = Math.floor(timeSinceStart / 3600000);
          const nextEnergyIn = 3600000 - (timeSinceStart % 3600000);
          nextEnergyTime = now + nextEnergyIn;
      // Eƒüer enerji 10 olduysa sƒ±fƒ±rla
          if (energy >= 10) {
            energyRegenerationStartTime = 0;
      nextEnergyTime = 0;
          }
        } else {
          // Enerji full
          energyRegenerationStartTime = 0;
      nextEnergyTime = 0;
        }

        saveData();
      }

      function updateEnergyCountdown() {
        const energyStatus = document.getElementById("energyStatus");
      const energyUI = document.getElementById("energyUI");
        if (!energyStatus || !energyUI) return;

        const now = Date.now();
      // Enerji tam ise
        if (energy >= 10) {
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (FULL)`;
      energyUI.innerHTML = `‚ö°: ${energy}/10`;
          energyRegenerationStartTime = 0;
          nextEnergyTime = 0;
          return;
      }

        // Enerji yenilenme ba≈ülamamƒ±≈üsa ba≈ülat
        if (energyRegenerationStartTime === 0) {
          updateEnergyTimers();
      }

        // Zaman dolmu≈ü mu kontrol et
        if (nextEnergyTime > 0 && now >= nextEnergyTime) {
          // 1 enerji ekle
          if (energy < 10) {
            energy++;
      updateEnergyTimers();
            saveData();
            updateUI();
          }
        }

        // Kalan s√ºreyi hesapla ve g√∂ster
        if (nextEnergyTime > now) {
          const timeLeft = nextEnergyTime - now;
      const minutesLeft = Math.floor(timeLeft / 60000);
          const secondsLeft = Math.floor((timeLeft % 60000) / 1000);

          const formattedMinutes = minutesLeft.toString().padStart(2, "0");
      const formattedSeconds = secondsLeft.toString().padStart(2, "0");

          // Hangi enerjiyi beklediƒüimizi g√∂ster
          const currentEnergyBeingRegenerated = energy + 1;
      energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Next ${currentEnergyBeingRegenerated}/10 in ${formattedMinutes}:${formattedSeconds})`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
      } else {
          // Hemen enerji eklenmesi gerekiyor
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Next energy ready!)`;
      energyUI.innerHTML = `‚ö°: ${energy}/10`;
        }
      }

      function startEnergyCountdown() {
        if (energyTimer) {
          clearInterval(energyTimer);
      }

        // √ñnce offline s√ºredeki enerji kazanƒ±mƒ±nƒ± kontrol et
        updateOfflineEnergyRegeneration();
      // Sonra geri sayƒ±mƒ± ba≈ülat
        updateEnergyCountdown();
        energyTimer = setInterval(updateEnergyCountdown, 1000);
      }

      // FACTORY Y√úKSELTME Sƒ∞STEMƒ∞
      function checkUpgradeProgress() {
        const now = Date.now();
      // Metal fabrikasƒ± y√ºkseltme kontrol√º
        if (metalFacUpgradeEndTime > 0 && now >= metalFacUpgradeEndTime) {
          metalFacLvl++;
      metalFacUpgradeEndTime = 0;
          updateUI();
          saveData();
        }

        // Kristal fabrikasƒ± y√ºkseltme kontrol√º
        if (kristalFacUpgradeEndTime > 0 && now >= kristalFacUpgradeEndTime) {
          kristalFacLvl++;
      kristalFacUpgradeEndTime = 0;
          updateUI();
          saveData();
        }
      }

      // ============================================
      // ETH PAYMENT SYSTEM (Base Network)
      // ============================================
      const PAYMENT_ADDRESS = "0x3cCAF6612D0e134c14aa148f7F668a717DA645Fe";
      const BASE_ETH_COST = 0.0005; // Starting cost in ETH
      const BASE_UPGRADE_TIME = 2 * 60 * 60 * 1000;
      // 2 hours in milliseconds
      const BASE_CHAIN_ID = 8453;
      // Base Mainnet Chain ID

      // Calculate ETH cost for upgrade (doubles each level)
      function getUpgradeCost(level) {
        return BASE_ETH_COST * Math.pow(2, level - 1);
      }

      // Calculate upgrade time (doubles each level)
      function getUpgradeTime(level) {
        return BASE_UPGRADE_TIME * Math.pow(2, level - 1);
      }

      // Format time for hours display
      function formatTimeHours(ms) {
        const hours = Math.floor(ms / 3600000);
      const minutes = Math.floor((ms % 3600000) / 60000);
        return `${hours}h ${minutes}m`;
      }

      // Connect wallet and send ETH payment
      async function sendETHPayment(amountETH) {
        if (typeof window.ethereum === "undefined") {
          alert("Please install MetaMask or use a Web3 wallet!");
      return false;
        }

        try {
          // Request wallet connection
          await window.ethereum.request({ method: "eth_requestAccounts" });
      const provider = new ethers.BrowserProvider(window.ethereum);
          const network = await provider.getNetwork();
      // Check if on Base network
          if (Number(network.chainId) !== BASE_CHAIN_ID) {
            try {
              await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: "0x2105" }], // Base Mainnet hex
            
              });
            } catch (switchError) {
              if (switchError.code === 4902) {
                await window.ethereum.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: 
      "0x2105",
                    chainName: "Base",
                    nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 },
                    rpcUrls: ["https://mainnet.base.org"],
                    blockExplorerUrls: ["https://basescan.org"]
         
               }]
                });
      } else {
                throw switchError;
      }
            }
          }

          const signer = await provider.getSigner();
      const amountWei = ethers.parseEther(amountETH.toString());

          const tx = await signer.sendTransaction({
            to: PAYMENT_ADDRESS,
            value: amountWei
          });
      // Wait for confirmation
          await tx.wait();
          return true;
      } catch (error) {
          console.error("Payment error:", error);
      alert("Payment failed: " + (error.message || "Unknown error"));
          return false;
      }
      }

      async function upgradeFactory(type) {
        let currentLevel;
      if (type === "metal") {
          if (metalFacUpgradeEndTime > Date.now()) {
            alert("Upgrade already in progress!");
      return;
          }
          currentLevel = metalFacLvl;
      } else if (type === "kristal") {
          if (kristalFacUpgradeEndTime > Date.now()) {
            alert("Upgrade already in progress!");
      return;
          }
          currentLevel = kristalFacLvl;
      }

        const ethCost = getUpgradeCost(currentLevel);
        const upgradeTime = getUpgradeTime(currentLevel);
      // Confirm payment
        const confirmMsg = `üè≠ Upgrade to Level ${currentLevel + 1}\n\nüí∞ Cost: ${ethCost} ETH (Base Network)\n‚è±Ô∏è Build Time: ${formatTimeHours(upgradeTime)}\n\nüí≥ Proceed with payment?`;
      if (!confirm(confirmMsg)) {
          return;
      }

        // Process ETH payment
        const paymentSuccess = await sendETHPayment(ethCost);
      if (!paymentSuccess) {
          return;
      }

        // Set upgrade end time
        if (type === "metal") {
          metalFacUpgradeEndTime = Date.now() + upgradeTime;
      } else if (type === "kristal") {
          kristalFacUpgradeEndTime = Date.now() + upgradeTime;
      }

        alert("‚úÖ Payment successful! Upgrade started.");
        updateUI();
        saveData();
      }

      function formatTime(ms) {
        if (ms <= 0) return "00:00";
      const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        return `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      }

      function initHub() {
        canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
        canvas.style.imageRendering = "pixelated";

        const now = Date.now();
        const secondsPassed = Math.floor((now - lastTime) / 1000);
      // OFFLINE MADENCƒ∞Lƒ∞K
        processMining(secondsPassed);
      // Y√ºkseltme ilerlemesini kontrol et
        checkUpgradeProgress();

        updateUI();
      // ENERJƒ∞ GERƒ∞ SAYIMINI BA≈ûLAT
        startEnergyCountdown();
      for (let i = 0; i < 40; i++) spawnWorker();
        for (let i = 0; i < 15; i++) spawnEnemy();
      requestAnimationFrame(gameLoop);
        setInterval(saveData, 3000);

        // Y√ºkseltme kontrol√º i√ßin interval
        setInterval(checkUpgradeProgress, 1000);
      // Joystick pozisyonunu ayarla
        initJoystick();
      }

      // Joystick ba≈ülatma
      function initJoystick() {
        const joystickContainer = document.getElementById("joystickContainer");
      const rect = joystickContainer.getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
        joystickCenterY = rect.top + rect.height / 2;
      joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;

        joystickContainer.addEventListener("touchstart", handleJoystickStart, { passive: false });
        joystickContainer.addEventListener("touchmove", handleJoystickMove, { passive: false });
      joystickContainer.addEventListener("touchend", handleJoystickEnd, { passive: false });

        joystickContainer.addEventListener("mousedown", handleJoystickStart);
        document.addEventListener("mousemove", handleJoystickMove);
        document.addEventListener("mouseup", handleJoystickEnd);
      }

      // Joystick fonksiyonlarƒ±
      function handleJoystickStart(e) {
        e.preventDefault();
      joystickActive = true;
        const joystickContainer = document.getElementById("joystickContainer");
        const rect = joystickContainer.getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
      joystickCenterY = rect.top + rect.height / 2;

        updateJoystickPosition(e);
      }

      function handleJoystickMove(e) {
        if (!joystickActive) return;
      e.preventDefault();
        updateJoystickPosition(e);
      }

      function handleJoystickEnd(e) {
        if (!joystickActive) return;
      e.preventDefault();
        joystickActive = false;

        joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;
        joystickDirection = { x: 0, y: 0 };

        updateJoystickVisual();
      player.isMoving = false;
      }

      function updateJoystickPosition(e) {
        let clientX, clientY;
      if (e.type.includes("touch")) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
      } else {
          clientX = e.clientX;
          clientY = e.clientY;
      }

        const dx = clientX - joystickCenterX;
        const dy = clientY - joystickCenterY;
      const distance = Math.sqrt(dx * dx + dy * dy);

        const limitedDistance = Math.min(distance, JOYSTICK_RADIUS);
        const angle = Math.atan2(dy, dx);
      joystickHandleX = joystickCenterX + Math.cos(angle) * limitedDistance;
        joystickHandleY = joystickCenterY + Math.sin(angle) * limitedDistance;

        joystickDirection.x = limitedDistance > 0 ?
      dx / distance : 0;
        joystickDirection.y = limitedDistance > 0 ? dy / distance : 0;

        updateJoystickVisual();
        player.isMoving = true;
      }

      function updateJoystickVisual() {
        const joystickHandle = document.getElementById("joystickHandle");
      if (joystickHandle) {
          const joystickContainer = document.getElementById("joystickContainer");
          const rect = joystickContainer.getBoundingClientRect();
      const x = joystickHandleX - rect.left - JOYSTICK_HANDLE_RADIUS;
          const y = joystickHandleY - rect.top - JOYSTICK_HANDLE_RADIUS;

          joystickHandle.style.transform = `translate(${x}px, ${y}px)`;
      if (joystickActive) {
            joystickHandle.style.background = "rgba(255, 204, 0, 1)";
      joystickHandle.style.boxShadow = "0 0 20px rgba(255, 204, 0, 0.8)";
          } else {
            joystickHandle.style.background = "rgba(255, 204, 0, 0.9)";
      joystickHandle.style.boxShadow = "0 0 15px rgba(255, 204, 0, 0.5)";
          }
        }
      }

      function updateUI() {
        const setText = (id, text) => {
          const el = document.getElementById(id);
      if (el) el.innerText = text;
        };
        const setDisabled = (id, value) => {
          const el = document.getElementById(id);
      if (el) el.disabled = value;
        };
        // Update Inner HTML for buttons with icons
        const setHTML = (id, html) => {
          const el = document.getElementById(id);
      if (el) el.innerHTML = html;
        };

        setText("traniumCount", tranium);
        setText("metalCount", Math.floor(metal));
        setText("kristalCount", Math.floor(kristal));
      setText(
          "metalWorkers",
          `${metalWorkers} Miners (${(metalWorkers * BASE_WORKER_SPEED * metalFacLvl).toFixed(3)}/s)`,
        );
      setText(
          "kristalWorkers",
          `${kristalWorkers} Miners (${(kristalWorkers * BASE_WORKER_SPEED * kristalFacLvl).toFixed(3)}/s)`,
        );
      setText("metalFacLevel", `Lvl ${metalFacLvl}`);
        setText("kristalFacLevel", `Lvl ${kristalFacLvl}`);
        
        // ETH costs and build times for upgrades
        const metalEthCost = getUpgradeCost(metalFacLvl);
      const kristalEthCost = getUpgradeCost(kristalFacLvl);
        const metalBuildTime = getUpgradeTime(metalFacLvl);
        const kristalBuildTime = getUpgradeTime(kristalFacLvl);
        
        setText("costMetalFac", `Œû${metalEthCost} ETH`);
        setText("costKristalFac", `Œû${kristalEthCost} ETH`);
      setText("metalBuildTime", `‚è±Ô∏è ${formatTimeHours(metalBuildTime)}`);
        setText("kristalBuildTime", `‚è±Ô∏è ${formatTimeHours(kristalBuildTime)}`);
        setText("resUI", `‚öôÔ∏è: ${Math.floor(metal)} | üíé: ${Math.floor(kristal)}`);
        setText("healthUI", "‚ù§Ô∏è: " + health);

        updateEnergyCountdown();
      // Metal fabrikasƒ± buton g√ºncelleme
        const upMetalFacBtn = document.getElementById("upMetalFac");
        const now = Date.now();
      if (metalFacUpgradeEndTime > now) {
          // Y√ºkseltme devam ediyor
          const remainingTime = metalFacUpgradeEndTime - now;
      upMetalFacBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(remainingTime)}`;
          upMetalFacBtn.disabled = true;
        } else {
          // Y√ºkseltme yapƒ±labilir
          upMetalFacBtn.innerHTML = `UPGRADE <span id="costMetalFac">Œû${metalEthCost} ETH</span>`;
      upMetalFacBtn.disabled = false;
        }

        // Kristal fabrikasƒ± buton g√ºncelleme
        const upKristalFacBtn = document.getElementById("upKristalFac");
      if (kristalFacUpgradeEndTime > now) {
          // Y√ºkseltme devam ediyor
          const remainingTime = kristalFacUpgradeEndTime - now;
      upKristalFacBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(remainingTime)}`;
          upKristalFacBtn.disabled = true;
        } else {
          // Y√ºkseltme yapƒ±labilir
          upKristalFacBtn.innerHTML = `UPGRADE <span id="costKristalFac">Œû${kristalEthCost} ETH</span>`;
      upKristalFacBtn.disabled = false;
        }

        setDisabled("swapBtn", Math.min(Math.floor(metal), Math.floor(kristal)) <= 0);
      }

      function saveData() {
        localStorage.setItem("w_metal", metal);
        localStorage.setItem("w_kristal", kristal);
      localStorage.setItem("w_tranium", tranium);
        localStorage.setItem("w_mw", metalWorkers);
        localStorage.setItem("w_kw", kristalWorkers);
        localStorage.setItem("w_mfl", metalFacLvl);
        localStorage.setItem("w_kfl", kristalFacLvl);
        localStorage.setItem("w_energy", energy);
        localStorage.setItem("w_last_time", Date.now());
        localStorage.setItem("w_next_energy_time", nextEnergyTime);
        localStorage.setItem("w_energy_reg_start", energyRegenerationStartTime);
        localStorage.setItem("w_mfue", metalFacUpgradeEndTime);
      localStorage.setItem("w_kfue", kristalFacUpgradeEndTime);
      }

      function spawnWorker() {
        const isM = Math.random() > 0.5;
      workers.push({
          x: 100 + Math.random() * (WORLD_SIZE - 200),
          y: 100 + Math.random() * (WORLD_SIZE - 200),
          img: isM ? imgMiner1 : imgMiner2,
          type: isM ? "metal" : "kristal",
        });
      }

      function spawnEnemy() {
        enemies.push({
          x: Math.random() * WORLD_SIZE,
          y: Math.random() * WORLD_SIZE,
          isChasing: false,
          spawnTime: Date.now(),
          currentSpeed: 3.8,
        });
      }

      function attemptStart() {
        if (energy > 0) {
          energy--;
      health = 3;

          // Enerji azaldƒ±, zamanlayƒ±cƒ±larƒ± g√ºncelle
          updateEnergyTimers();

          saveData();
          updateUI();
      document.getElementById("overlay").style.display = "none";
          document.getElementById("ui").style.opacity = "1";
          document.getElementById("joystickContainer").style.display = "block";
          isStarted = true;
      } else {
          alert("Not enough energy! Wait for energy to regenerate.");
      }
      }

      function processMining(dtSec) {
        const metalGain = dtSec * (metalWorkers * BASE_WORKER_SPEED * metalFacLvl);
      const kristalGain = dtSec * (kristalWorkers * BASE_WORKER_SPEED * kristalFacLvl);

        metal += metalGain;
        kristal += kristalGain;

        if (!isStarted) updateUI();
      }

      function update(dt) {
        processMining(dt);
      // Y√ºkseltme ilerlemesini kontrol et
        checkUpgradeProgress();

        if (!isStarted) return;
      if (joystickActive) {
          const moveSpeed = player.speed;
      player.x += joystickDirection.x * moveSpeed;
          player.y += joystickDirection.y * moveSpeed;
          player.flipX = joystickDirection.x < 0;
          player.isMoving = true;
      walkCycle += 0.35;
        } else {
          if (isTouching) {
            let dx = player.targetX - player.x,
              dy = player.targetY - player.y,
              dist = Math.hypot(dx, dy);
      if (dist > 5) {
              player.x += (dx / dist) * player.speed;
      player.y += (dy / dist) * player.speed;
              player.flipX = dx < 0;
              player.isMoving = true;
              walkCycle += 0.35;
      } else player.isMoving = false;
          }
        }

        player.x = Math.max(50, Math.min(WORLD_SIZE - 50, player.x));
      player.y = Math.max(50, Math.min(WORLD_SIZE - 50, player.y));
        camera.x = Math.max(0, Math.min(WORLD_SIZE - canvas.width, player.x - canvas.width / 2));
      camera.y = Math.max(0, Math.min(WORLD_SIZE - canvas.height, player.y - canvas.height / 2));
      workers.forEach((w, i) => {
          if (Math.hypot(player.x - w.x, player.y - w.y) < 70) {
            if (w.type === "metal") metalWorkers++;
            else kristalWorkers++;
            workers.splice(i, 1);
            updateUI();
            spawnWorker();
          }
  
      });

        const now = Date.now();
      enemies.forEach((en, i) => {
          if (en.isChasing && now - en.chaseStartTime > 5000) {
            enemies.splice(i, 1);
            spawnEnemy();
            return;
          }
          let d = Math.hypot(player.x - en.x, player.y - en.y);
          if (d < 400 
      && !en.isChasing) {
            en.isChasing = true;
            en.chaseStartTime = now;
          }
          if (en.isChasing) {
            en.currentSpeed += 0.005;
            en.x += ((player.x - en.x) / d) * en.currentSpeed;
            en.y += 
      ((player.y - en.y) / d) * en.currentSpeed;
          }
          if (d < 50) {
            health--;
            updateUI();
            enemies.splice(i, 1);
            spawnEnemy();
            if (health <= 0) {
     
         isStarted = false;
              saveData();
              endGame();
            }
          }
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
        ctx.translate(-camera.x, -camera.y);
        if (imgBG.complete) ctx.drawImage(imgBG, 0, 0, WORLD_SIZE, WORLD_SIZE);
      workers.forEach((w) => {
          ctx.save();
          ctx.shadowBlur = 10;
          ctx.shadowColor = w.type === "metal" ? "#ffcc00" : "#00ffff";
          ctx.drawImage(w.img, w.x - 40, w.y - 40, 80, 80);
          ctx.restore();
        });
      enemies.forEach((en) => {
          ctx.save();
          ctx.shadowBlur = 20;
          ctx.shadowColor = "red";
          ctx.fillStyle = "rgba(255, 0, 0, 0.25)";
          ctx.beginPath();
          ctx.arc(en.x, en.y, 45, 0, Math.PI * 2);
          ctx.fill();
          if (en.isChasing) {
 
           let tr = 5000 - (Date.now() - en.chaseStartTime);
            if (tr < 1000) ctx.globalAlpha = tr / 1000;
          }
          ctx.drawImage(imgInfected, en.x - 40, en.y - 50, 80, 100);
          ctx.restore();
        });
      ctx.save();
        let bounce = player.isMoving ? Math.abs(Math.sin(walkCycle)) * 14 : 0;
        ctx.translate(player.x, player.y - bounce);
        if (player.flipX) ctx.scale(-1, 1);
      ctx.drawImage(imgDayi, -50, -60, 100, 120);
        ctx.restore();
        ctx.restore();
      }

      function gameLoop() {
        let now = Date.now();
      let dt = (now - lastUpdate) / 1000;
        lastUpdate = now;
        update(dt);
        draw();
        requestAnimationFrame(gameLoop);
      }

      const setTarget = (e) => {
        if (joystickActive) return;
      const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
      const cy = e.touches ? e.touches[0].clientY - rect.top : e.clientY - rect.top;

        const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

        player.targetX = cx * scaleX + camera.x;
        player.targetY = cy * scaleY + camera.y;
      player.isMoving = true;
      };

      window.addEventListener("mousedown", (e) => {
        const joystickRect = document.getElementById("joystickContainer").getBoundingClientRect();
        if (
          e.clientX >= joystickRect.left &&
          e.clientX <= joystickRect.right &&
          e.clientY >= joystickRect.top &&
          e.clientY <= joystickRect.bottom
        ) {
          return;
   
      }

        isTouching = true;
        setTarget(e);
      });
      window.addEventListener("mousemove", (e) => {
        if (isTouching && !joystickActive) setTarget(e);
      });
      window.addEventListener("mouseup", () => {
        isTouching = false;
        if (!joystickActive) player.isMoving = false;
      });
      window.addEventListener(
        "touchstart",
        (e) => {
          const joystickRect = document.getElementById("joystickContainer").getBoundingClientRect();
          const touchX = e.touches[0].clientX;
          const touchY = e.touches[0].clientY;

          if (
            touchX >= joystickRect.left &&
            touchX <= joystickRect.right &&
  
            touchY >= joystickRect.top &&
            touchY <= joystickRect.bottom
          ) {
            return;
          }

          isTouching = true;
          setTarget(e);
        },
        { passive: 
      false },
      );
      window.addEventListener(
        "touchmove",
        (e) => {
          e.preventDefault();
          if (isTouching && !joystickActive) setTarget(e);
        },
        { passive: false },
      );
      window.addEventListener("touchend", () => {
        isTouching = false;
        if (!joystickActive) player.isMoving = false;
      });
      // End game function
      function endGame() {
        document.getElementById("overlay").style.display = "flex";
      document.getElementById("ui").style.opacity = "0";
        document.getElementById("joystickContainer").style.display = "none";
        if (energyTimer) {
          clearInterval(energyTimer);
      energyTimer = null;
        }

        // Enerji geri sayƒ±mƒ±nƒ± tekrar ba≈ülat
        startEnergyCountdown();
      // Log score for Farcaster Mini App
        console.log("Game Over! Score: " + Math.floor(tranium));
      }

      // Oyunu y√ºkle (Resimler bitince)
      window.onload = startIntro;
    </script>
    <script>
      /**
       * FINAL SYSTEM PATCH V4.0 (TURBO MODE)
       * - FPS Lock: 60 FPS
       * - Player Speed: 7.0 (2x Faster)
       * - Enemy Speed: Max 6.6 (2x Faster)
       * - Camera: Wide Angle (Fixed)
       * - Control: Touch Joystick (Mobile) / Mouse Click (PC)
       */
   
       (function () {
        // 1. FPS G√ñSTERGESƒ∞
        const fpsBox = document.createElement("div");
        fpsBox.id = "pc-fps-counter";
        fpsBox.style.cssText =
          "position:fixed; top:60px; left:10px; color:#00ffcc; font-family:monospace; font-size:11px; font-weight:bold; z-index:2147483647; background:rgba(0,0,0,0.6); padding:4px 8px; border:1px solid #00ffcc; border-radius:4px; pointer-events:none; display:none;";
        fpsBox.innerHTML = "FPS: ...";
        document.body.appendChild(fpsBox);

        // 
      2. OYUNCU HIZINI Kƒ∞Lƒ∞TLEME (7.0 - TURBO)
        function lockPlayerSpeed() {
          try {
            // Hƒ±zƒ± 7.0 yapƒ±yoruz (Eskisi 3.5 idi)
            if (typeof player !== "undefined" && player.speed !== 7.0) {
              player.speed = 7.0;
      Object.defineProperty(player, "speed", {
                value: 7.0,
                writable: false,
                configurable: true,
              });
      }
          } catch (e) {}
        }

        // 3. BA≈ûLATICIYI G√úVENLƒ∞ HALE GETƒ∞RME
        const originalInitHub = window.initHub;
      window.initHub = function () {
          if (originalInitHub) originalInitHub();
      const cvs = document.getElementById("gameCanvas");
          if (cvs) {
            // KAMERA AYARI (Geni≈ü A√ßƒ± Koruma)
            let targetWidth = window.innerWidth;
      let targetHeight = window.innerHeight;

            if (targetWidth > 1920) {
              const ratio = window.innerHeight / window.innerWidth;
      targetWidth = 1920;
              targetHeight = 1920 * ratio;
            }

            cvs.width = targetWidth;
      cvs.height = targetHeight;
            cvs.style.width = "100vw";
            cvs.style.height = "100vh";
            cvs.style.transform = "translate3d(0,0,0)";
            cvs.style.imageRendering = "pixelated";
      }

          // PC'de Joystick Gizle
          if (!("ontouchstart" in window) && navigator.maxTouchPoints === 0) {
            const joyContainer = document.getElementById("joystickContainer");
      if (joyContainer) joyContainer.style.display = "none";
            const style = document.createElement("style");
            style.innerHTML = "#joystickContainer { display: none !important; }";
            document.head.appendChild(style);
      }

          lockPlayerSpeed();
          fpsBox.style.display = "block";
      console.log("‚úÖ TURBO MODE: Player 7.0 | Enemy Max 6.6");
        };
      // 4. OYUN D√ñNG√úS√ú + D√ú≈ûMAN HIZ KONTROL√ú
        let lastTime = performance.now();
      let frameCount = 0;
        let lastFpsTime = performance.now();
        const targetFPS = 60;
        const frameDelay = 1000 / targetFPS;
      const originalRAF = window.requestAnimationFrame;

        function secureGameLoop() {
          originalRAF(secureGameLoop);
      const now = performance.now();
          const elapsed = now - lastTime;

          if (elapsed < frameDelay) return;
      lastTime = now - (elapsed % frameDelay);

          // --- HIZ KONTROLLERƒ∞ ---

          // A) OYUNCU HIZI (7.0'da Tut)
          if (typeof player !== "undefined") {
            // Eƒüer hƒ±z deƒüi≈üirse tekrar 7.0'a √ßek
            if (player.speed !== 7.0) player.speed = 7.0;
      }

          // B) D√ú≈ûMAN HIZI (2x Arttƒ±rƒ±lmƒ±≈ü)
          if (typeof enemies !== "undefined" && Array.isArray(enemies)) {
            enemies.forEach((en) => {
              // Ba≈ülangƒ±√ß hƒ±zƒ±nƒ± d√º≈ü√ºrm√ºyoruz (Orijinal 3.8 kalsƒ±n)

              // Maksimum hƒ±zƒ± sƒ±nƒ±rla (6.6)
              // Oyuncu 
      7.0 olduƒüu i√ßin 6.6 adil bir kovalamaca hƒ±zƒ±dƒ±r.
              if (en.currentSpeed > 6.6) {
                en.currentSpeed = 6.6;
              }
            });
      }

          // FPS Sayacƒ±
          frameCount++;
      if (now - lastFpsTime >= 1000) {
            fpsBox.innerHTML = "FPS: " + frameCount;
      frameCount = 0;
            lastFpsTime = now;
          }

          // Oyun G√ºncelleme
          if (typeof window.update === "function" && typeof window.draw === "function") {
            window.update(0.016);
      window.draw();
          }
        }

        window.gameLoop = function () {};
      secureGameLoop();
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="base:app_id" content="6957083ec63ad876c9081cd6" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="theme-color" content="#000000" />
    
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69" />
    <meta property="fc:frame:button:1" content="Start Mining" />
    <meta property="fc:frame:button:1:action" content="post" />
    
    <meta name="fc:miniapp" content="hosted" />
    <meta property="fc:miniapp:version" content="0.0.1" />
    <meta property="fc:miniapp:name" content="Tranium Verse" />
    <meta property="fc:miniapp:icon" content="https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69" />

    <meta property="og:title" content="TRANIUM VERSE" />
    <meta property="og:description" content="Collect resources and refine Tranium to dominate the Verse." />
    <meta property="og:image" content="https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69" />
    
    <title>TRANIUM VERSE - Strategy Hub</title>
    
    <style>
      :root {
        --gold: #ffcc00;
        --neon: #00ffcc;
        --dark: #0a0a00;
        --panel: rgba(255, 255, 255, 0.05);
        --red: #ff4444;
        --disease-red: #ff2222;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: var(--dark);
        overflow: hidden;
        touch-action: none;
        font-family: "Segoe UI", sans-serif;
        color: white;
        height: 100vh;
        width: 100vw;
      }
      #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
        touch-action: none;
        image-rendering: pixelated;
      }

      /* FPS COUNTER */
      #fps-counter {
        position: fixed;
        top: 60px;
        left: 10px;
        color: var(--neon);
        font-family: monospace;
        font-size: 11px;
        font-weight: bold;
        z-index: 9999;
        background: rgba(0,0,0,0.6);
        padding: 4px 8px;
        border: 1px solid var(--neon);
        border-radius: 4px;
        pointer-events: none;
        display: none;
      }

      /* INTRO SCREEN */
      #introOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #000000 0%, #1a0000 50%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        overflow: hidden;
      }

      .intro-container {
        text-align: center;
        position: relative;
        z-index: 2;
        animation: introFadeIn 1.5s ease-out;
      }

      .disease-logo {
        font-size: min(60px, 12vw);
        font-weight: 900;
        color: var(--disease-red);
        text-transform: uppercase;
        letter-spacing: 8px;
        margin-bottom: 10px;
        text-shadow: 0 0 20px rgba(255, 34, 34, 0.7), 0 0 40px rgba(255, 34, 34, 0.5);
        position: relative;
      }

      .disease-logo::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 4px;
        background: linear-gradient(90deg, transparent, var(--disease-red), transparent);
      }

      .presents-text {
        font-size: min(18px, 4vw);
        color: rgba(255, 255, 255, 0.7);
        margin: 20px 0;
        font-weight: 300;
        letter-spacing: 4px;
        animation: pulse 2s infinite;
      }

      .game-title-intro {
        font-size: min(48px, 10vw);
        font-weight: 900;
        color: var(--gold);
        text-transform: uppercase;
        margin: 30px 0;
        text-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
        letter-spacing: 4px;
      }
      
      .game-subtitle {
        font-size: min(16px, 3.5vw);
        color: rgba(255, 255, 255, 0.6);
        margin-top: 10px;
        font-weight: 300;
        letter-spacing: 2px;
      }

      /* LOADING SCREEN */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a00 0%, #001a00 100%);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .loading-container {
        text-align: center;
        width: 90%;
        max-width: 400px;
        animation: loadingFadeIn 1s ease;
      }

      .loading-logo {
        font-size: min(32px, 7vw);
        font-weight: 900;
        color: var(--neon);
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 3px;
        position: relative;
      }

      .loading-logo::before {
        content: "‚õèÔ∏è";
        margin-right: 10px;
      }

      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid rgba(0, 255, 204, 0.1);
        border-top-color: var(--neon);
        border-radius: 50%;
        margin: 0 auto 30px;
        animation: spin 1s linear infinite;
      }

      .loading-progress-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .loading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--neon), #00ff88);
        border-radius: 3px;
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      }

      .loading-text {
        font-size: min(18px, 4vw);
        color: var(--neon);
        margin-bottom: 20px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .loading-percentage {
        font-size: min(24px, 5vw);
        font-weight: 900;
        color: var(--gold);
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
      }

      .loading-tip {
        font-size: min(12px, 2.5vw);
        color: rgba(255, 255, 255, 0.5);
        margin-top: 30px;
        font-style: italic;
        max-width: 300px;
        line-height: 1.4;
      }

      /* MAIN OVERLAY */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, #000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        padding: 20px;
        justify-content: space-evenly;
        overflow: hidden;
        gap: 0;
        display: none;
      }

      /* HOW TO PLAY SCREEN */
      #howToPlayScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.98);
        z-index: 300;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: max(env(safe-area-inset-top), 20px) 20px max(env(safe-area-inset-bottom), 30px) 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overscroll-behavior: contain;
      }

      .close-btn {
        position: absolute;
        top: max(env(safe-area-inset-top), 15px);
        right: 20px;
        font-size: 40px;
        color: var(--red);
        background: none;
        border: none;
        cursor: pointer;
        z-index: 301;
        font-weight: bold;
        line-height: 1;
      }

      .btn-help-open {
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 10px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
      }

      .btn-help-open:before {
        content: "?";
        display: inline-block;
        width: 16px;
        height: 16px;
        background: var(--gold);
        color: black;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 10px;
      }

      .help-container {
        width: 100%;
        max-width: 500px;
        margin-top: 40px;
      }

      .help-card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        width: 100%;
        text-align: left;
        margin-bottom: 20px;
      }
      .help-title {
        color: var(--gold);
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 10px;
        display: block;
        border-bottom: 1px solid rgba(255, 204, 0, 0.3);
        padding-bottom: 8px;
      }
      .help-text {
        color: #ccc;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 15px;
      }
      .help-icon {
        margin-right: 5px;
      }
      .warning-text {
        color: var(--disease-red);
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        padding: 10px;
        border: 1px solid var(--disease-red);
        background: rgba(255, 34, 34, 0.1);
        border-radius: 8px;
        margin-top: 20px;
      }

      /* Modals */
      .custom-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        max-height: 80vh;
        overflow-y: auto;
        background: #000;
        border: 2px solid var(--gold);
        border-radius: 20px;
        padding: 20px;
        z-index: 200;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 204, 0, 0.2);
        touch-action: pan-y;
      }
      #endGameModal { border-color: var(--neon); box-shadow: 0 0 30px rgba(0, 255, 204, 0.4); }
      #upgradeModal { border-color: var(--neon); }

      .modal-input {
        width: 100%; padding: 15px; margin: 15px 0; background: #111;
        border: 1px solid #333; color: white; text-align: center; border-radius: 8px; font-size: 16px; min-height: 50px;
      }

      .percentage-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
      .pct-btn {
        background: #222; border: 1px solid #444; color: var(--gold); padding: 12px 0;
        border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; min-height: 44px;
      }
      .pct-btn:active { background: var(--gold); color: #000; }

      .modal-btn-row { display: flex; gap: 10px; margin-top: 15px; }
      .modal-btn {
        flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: 900;
        cursor: pointer; text-transform: uppercase; min-height: 50px;
      }

      /* UI Elements */
      .header {
        text-align: center; margin-top: env(safe-area-inset-top); width: 100%;
        display: flex; flex-direction: column; align-items: center; flex-shrink: 0;
      }
      .game-title {
        color: var(--gold); font-size: 22px; font-weight: 900; letter-spacing: 1px;
        text-transform: uppercase; margin: 10px 0;
      }
      .tranium-circle {
        margin: 15px auto 10px auto; width: 85px; height: 85px; border: 3px solid var(--gold);
        border-radius: 50%; display: flex; flex-direction: column; align-items: center;
        justify-content: center; background: rgba(255, 204, 0, 0.1); box-shadow: 0 0 15px rgba(255, 204, 0, 0.3); flex-shrink: 0;
      }
      .tranium-val { font-size: 28px; font-weight: 900; color: var(--gold); }
      .tranium-lbl { font-size: 9px; font-weight: bold; }

      .resource-section {
        width: 100%; max-width: 380px; display: grid; grid-template-columns: 1fr 1fr;
        gap: 12px; padding: 0 10px; flex-shrink: 1;
      }
      .res-card {
        background: var(--panel); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;
        padding: 15px; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center;
      }
      .res-name { font-size: 11px; color: var(--gold); font-weight: bold; display: block; }
      .res-amount { font-size: 20px; font-weight: 800; display: block; margin: 5px 0; }
      .res-info { font-size: 10px; color: var(--neon); opacity: 0.9; }

      .btn-refine {
        width: 100%; max-width: 380px; background: var(--gold); color: #000; border: none;
        padding: 18px; border-radius: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase;
        box-shadow: 0 4px 0 #b89600; font-size: 14px; min-height: 60px; margin: 10px 0; flex-shrink: 0;
      }
      .btn-refine:disabled { background: #333; color: #666; box-shadow: none; transform: translateY(4px); }
      .btn-upgrade-menu { background: var(--neon); color: #000; box-shadow: 0 4px 0 #00b894; margin-top: 10px; }

      .factory-modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
      .fac-card {
        background: rgba(0, 255, 204, 0.03); border: 1px solid rgba(0, 255, 204, 0.3);
        border-radius: 12px; padding: 12px; display: flex; flex-direction: column; min-height: 120px;
      }
      .fac-header { font-size: 10px; font-weight: bold; color: var(--neon); text-align: center; margin-bottom: 8px; }
      .btn-upgrade {
        background: var(--neon); color: #000; border: none; padding: 12px; border-radius: 8px;
        font-weight: 800; font-size: 10px; cursor: pointer; min-height: 44px; margin-top: auto;
      }

      .footer {
        width: 100%; max-width: 380px; text-align: center; padding: 15px 10px;
        margin-top: auto; margin-bottom: max(env(safe-area-inset-bottom), 20px); flex-shrink: 0;
      }
      .energy-info { font-size: 16px; font-weight: bold; color: var(--gold); margin-bottom: 15px; display: block; }
      .btn-start {
        width: 100%; background: var(--gold); color: #000; padding: 20px; border-radius: 40px;
        border: none; font-size: 20px; font-weight: 900; cursor: pointer; min-height: 70px; box-shadow: 0 6px 0 #b89600;
      }

      /* In-Game UI */
      #ui {
        position: absolute; top: max(env(safe-area-inset-top), 15px); left: 15px; right: 15px;
        pointer-events: none; display: flex; justify-content: space-between; z-index: 10; opacity: 0;
        font-weight: bold; text-shadow: 2px 2px 4px black; font-size: min(14px, 3.5vw);
      }

      .reset-link {
        color: var(--neon); font-size: 12px; text-decoration: none; cursor: pointer;
        background: rgba(0, 0, 0, 0.5); border: 1px solid var(--neon); border-radius: 8px;
        display: block; width: 100%; max-width: 250px; font-weight: bold; margin: 10px 0; padding: 10px; min-height: 44px; flex-shrink: 0;
      }

      /* Joystick */
      #joystickContainer {
        position: fixed; left: 25px; bottom: 25px; width: 120px; height: 120px;
        z-index: 20; display: none; pointer-events: auto;
      }
      #joystickBase {
        position: absolute; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
      }
      #joystickHandle {
        position: absolute; width: 60px; height: 60px; background: rgba(255, 204, 0, 0.9);
        border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%; top: 50%; left: 50%;
        transform: translate(-50%, -50%); box-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
      }

      /* Animations */
      @keyframes introFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
      @keyframes loadingFadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }

      /* Mobile Optimizations */
      @media (max-width: 600px) and (max-height: 850px) {
        #overlay { justify-content: space-evenly; padding: 10px; gap: 0; padding-bottom: max(env(safe-area-inset-bottom), 10px); }
        .header { margin-top: 0; margin-bottom: 0; }
        .game-title { font-size: 18px; margin: 2px 0; }
        .tranium-circle { width: 65px; height: 65px; margin: 5px auto; border-width: 2px; }
        .tranium-val { font-size: 20px; }
        .tranium-lbl { font-size: 8px; }
        .btn-help-open { padding: 4px 12px; font-size: 10px; margin-bottom: 2px; min-height: 25px; }
        .reset-link { padding: 5px; min-height: 30px; font-size: 10px; margin: 2px 0; max-width: 200px; }
        .resource-section { gap: 8px; margin: 2px 0; }
        .res-card { padding: 8px; min-height: 60px; }
        .res-name { font-size: 10px; }
        .res-amount { font-size: 16px; margin: 2px 0; }
        .res-info { font-size: 9px; }
        .btn-refine { padding: 10px; min-height: 45px; font-size: 12px; margin: 8px 0; }
        .footer { padding: 5px; margin-bottom: 5px; }
        .energy-info { font-size: 12px; margin-bottom: 5px; }
        .btn-start { padding: 10px; min-height: 50px; font-size: 16px; }
        
        #howToPlayScreen { justify-content: center; padding: 10px; overflow: hidden; }
        #howToPlayScreen .header { margin-top: 0; margin-bottom: 5px; }
        #howToPlayScreen .game-title { font-size: 16px; margin: 0; }
        #howToPlayScreen .close-btn { font-size: 30px; top: 10px; right: 15px; z-index: 302; }
        .help-container { margin-top: 5px; width: 100%; }
        .help-card { padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .warning-text { font-size: 11px; padding: 5px; margin-top: 0; margin-bottom: 5px; }
        .help-title { font-size: 11px; margin-bottom: 2px; padding-bottom: 2px; border-bottom-width: 1px; }
        .help-text { font-size: 10px; line-height: 1.2; margin-bottom: 4px; }
        .help-text:last-child { margin-bottom: 0; }
        
        #joystickContainer { width: 90px; height: 90px; left: 15px; bottom: 15px; }
        #joystickHandle { width: 45px; height: 45px; }
      }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@farcaster/frame-sdk@0.0.26/dist/index.min.js"></script>
    <script>
      // ==========================================
      // ROBUST SDK INITIALIZATION (FIXED)
      // ==========================================
      window.isSDKReady = false;
      window.farcasterContext = null;

      // Bu fonksiyonu birden √ßok kez √ßaƒüƒ±racaƒüƒ±z
      const signalReady = async () => {
        if (window.isSDKReady) return;

        const sdk = window.sdk || window.FarcasterFrameSDK || window.Farcaster;
        if (sdk) {
          try {
            // Sinyal g√∂nder: v2 (actions) veya v1
            if (sdk.actions && sdk.actions.ready) {
              await sdk.actions.ready();
              console.log("‚úÖ SDK Ready sent (actions)");
            } else if (sdk.ready) {
              await sdk.ready();
              console.log("‚úÖ SDK Ready sent (legacy)");
            }
            
            // Context y√ºkle (Arkaplanda)
            if (sdk.context && !window.farcasterContext) {
              sdk.context.then(ctx => {
                 window.farcasterContext = ctx;
                 console.log("üë§ Context Loaded");
              });
            }
            
            window.isSDKReady = true;
          } catch(e) {
            console.warn("SDK signal attempt failed:", e);
          }
        }
      };

      // 1. Hemen dene
      signalReady();

      // 2. DOM y√ºklendiƒüinde dene (En g√ºvenli an)
      document.addEventListener("DOMContentLoaded", () => {
        signalReady();
        // Fallback: 500ms sonra tekrar dene
        setTimeout(signalReady, 500);
      });

      // 3. Her ≈üey y√ºklendiƒüinde son kez dene
      window.addEventListener("load", () => {
        signalReady();
      });
      
      // 4. FAILSAFE: Eƒüer SDK yanƒ±t vermezse oyunu manuel a√ß (3 saniye sonra)
      setTimeout(() => {
        if (!window.isSDKReady) {
            console.log("‚ö†Ô∏è SDK timeout - Forcing game start");
            // Intro ekranƒ± varsa kaldƒ±rƒ±labilir veya oyun ba≈ülatƒ±labilir
            // (A≈üaƒüƒ±daki startIntro fonksiyonu bunu halledecek)
        }
      }, 3000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div id="fps-counter">FPS: ...</div>

    <div id="introOverlay">
      <div class="intro-container">
        <div class="disease-logo">DISEASES GAMES</div>
        <div class="presents-text">PRESENTS</div>
        <div class="game-title-intro">TRANIUM VERSE</div>
        <div class="game-subtitle">Mobile Strategy Mining</div>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="loading-container">
        <div class="loading-logo">TRANIUM VERSE</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Systems</div>
        <div class="loading-percentage">0%</div>
        <div class="loading-progress-container">
          <div class="loading-progress-bar"></div>
        </div>
        <div class="loading-tip">Tip: Collect miners to increase resource production. Avoid infected enemies!</div>
      </div>
    </div>

    <div id="ui">
      <div id="resUI">‚öôÔ∏è: 0 | üíé: 0</div>
      <div id="healthUI" style="color: #ff4444">‚ù§Ô∏è: 3</div>
      <div id="energyUI">‚ö°: 10/10</div>
    </div>

    <div id="joystickContainer">
      <div id="joystickBase"></div>
      <div id="joystickHandle"></div>
    </div>

    <div id="endGameModal" class="custom-modal">
      <h2 style="color: var(--neon); margin: 0">FINISH & SUBMIT</h2>
      <p style="font-size: 13px; margin: 15px 0; color: #ddd">
        Your current Tranium will be submitted as your score. You can start again with energy.
      </p>
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333; color: white" onclick="closeEndGameConfirmation()">CANCEL</button>
        <button class="modal-btn" style="background: var(--neon); color: black" onclick="triggerManualEndGame()">SUBMIT</button>
      </div>
    </div>

    <div id="upgradeModal" class="custom-modal">
      <h2 style="color: var(--neon); margin: 0 0 10px 0">FACTORY UPGRADES</h2>
      <p style="font-size: 10px; color: #888; margin: 0 0 15px 0">üíé Payment: Base Network ETH</p>
      <div class="factory-modal-grid">
        <div class="fac-card">
          <span class="fac-header">METAL FACTORY</span>
          <span id="metalFacLevel" style="font-size: 9px; text-align: center; margin-bottom: 3px">Lvl 1</span>
          <span id="metalBuildTime" style="font-size: 8px; text-align: center; margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
          <button id="upMetalFac" class="btn-upgrade" onclick="upgradeFactory('metal')">
            UPGRADE <span id="costMetalFac"></span>
          </button>
        </div>
        <div class="fac-card">
          <span class="fac-header">CRYSTAL FACTORY</span>
          <span id="kristalFacLevel" style="font-size: 9px; text-align: center; margin-bottom: 3px">Lvl 1</span>
          <span id="kristalBuildTime" style="font-size: 8px; text-align: center; margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
          <button id="upKristalFac" class="btn-upgrade" onclick="upgradeFactory('kristal')">
            UPGRADE <span id="costKristalFac"></span>
          </button>
        </div>
      </div>
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333; color: white" onclick="closeUpgradeModal()">CLOSE</button>
      </div>
    </div>

    <div id="swapModal" class="custom-modal">
      <h2 style="color: var(--gold); margin: 0; font-size: 18px">TRANIUM REFINERY</h2>
      <p style="font-size: 11px; margin: 10px 0; color: #aaa">Refine Metal & Crystal into Tranium (1:1)</p>
      <div class="percentage-row">
        <button class="pct-btn" onclick="setSwapPct(0.25)">25%</button>
        <button class="pct-btn" onclick="setSwapPct(0.50)">50%</button>
        <button class="pct-btn" onclick="setSwapPct(0.75)">75%</button>
        <button class="pct-btn" onclick="setSwapPct(1.00)">100%</button>
      </div>
      <input type="number" id="swapAmountInput" class="modal-input" placeholder="Enter amount..." min="1" />
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333; color: white" onclick="closeSwapModal()">BACK</button>
        <button class="modal-btn" style="background: var(--gold); color: black" onclick="executeSwap()">REFINE</button>
      </div>
    </div>

    <div id="howToPlayScreen">
      <button class="close-btn" onclick="closeHowToPlay()">&times;</button>
      <div class="header">
        <h1 class="game-title">HOW TO PLAY</h1>
      </div>
      <div class="help-container">
        <div class="help-card">
          <div class="warning-text">‚ö†Ô∏è DON'T FORGET:<br />TRANIUM = SCORE</div>
          <span class="help-title">üéØ MISSION OBJECTIVE</span>
          <p class="help-text">Collect resources and refine Tranium to dominate the Verse. Survive against the infected swarm.</p>
          <span class="help-title">‚õèÔ∏è RESOURCES</span>
          <p class="help-text"><span class="help-icon">‚öôÔ∏è</span> <b>Metal & Crystal:</b> Produced automatically by miners. Find miners in the world to increase production.<br /><span class="help-icon">üü°</span> <b>Tranium:</b> The ultimate currency. Use the "REFINE" button to convert Metal and Crystal into Tranium.</p>
          <span class="help-title">üè≠ FACTORIES</span>
          <p class="help-text">Upgrade your Metal and Crystal factories to boost miner efficiency. Higher levels mean faster production speeds per miner.</p>
          <span class="help-title">‚ö†Ô∏è ENEMIES</span>
          <p class="help-text">Avoid the infected (Red Circles). They will chase you. If they touch you 3 times, the mission fails.</p>
          <span class="help-title">‚ö° ENERGY SYSTEM</span>
          <p class="help-text">Every mission costs 1 Energy. Energy regenerates over time (1 per hour) even when you are offline.</p>
        </div>
      </div>
    </div>

    <div id="overlay">
      <div class="header">
        <h1 class="game-title">TRANIUM VERSE</h1>
        <div class="tranium-circle">
          <span id="traniumCount" class="tranium-val">0</span>
          <span class="tranium-lbl">TRANIUM</span>
        </div>
        <button class="btn-help-open" onclick="openHowToPlay()">HOW TO PLAY</button>
      </div>
      <div class="resource-section">
        <div class="res-card">
          <span class="res-name">‚öôÔ∏è METAL</span>
          <span id="metalCount" class="res-amount">0</span>
          <span id="metalWorkers" class="res-info">0 Miners</span>
        </div>
        <div class="res-card">
          <span class="res-name">üíé CRYSTAL</span>
          <span id="kristalCount" class="res-amount">0</span>
          <span id="kristalWorkers" class="res-info">0 Miners</span>
        </div>
      </div>
      <div style="height: 50px;"></div>
      <button id="swapBtn" class="btn-refine" onclick="openSwapModal()">Refine Tranium (1:1)</button>
      <div style="height: 50px;"></div>
      <button class="btn-refine btn-upgrade-menu" onclick="openUpgradeModal()">üè≠ FACTORY UPGRADES</button>
      <div class="footer">
        <span id="energyStatus" class="energy-info">‚ö° ENERGY: 10/10</span>
        <button class="btn-start" onclick="attemptStart()">START MISSION</button>
      </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
      // ============================================
      // CORE VARIABLES & CONSTANTS
      // ============================================
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const WORLD_SIZE = 2500;
      const JOYSTICK_RADIUS = 60;
      const JOYSTICK_HANDLE_RADIUS = 30;
      
      // TURBO MODE SETTINGS MERGED HERE
      const PLAYER_SPEED = 7.0; // Increased from 3.5 to 7.0
      const ENEMY_MAX_SPEED = 6.6; // Capped for balance
      const BASE_WORKER_SPEED = 0.001; // Mining speed

      let metal = 0, kristal = 0, tranium = 0;
      let metalWorkers = 0, kristalWorkers = 0;
      let metalFacLvl = 1, kristalFacLvl = 1;
      let energy = 10;
      let lastTime = Date.now();
      let health = 3, isStarted = false, isTouching = false;
      let walkCycle = 0, camera = { x: 0, y: 0 };
      
      let player = {
        x: WORLD_SIZE / 2,
        y: WORLD_SIZE / 2,
        speed: PLAYER_SPEED,
        targetX: WORLD_SIZE / 2,
        targetY: WORLD_SIZE / 2,
        flipX: false,
        isMoving: false,
      };
      
      let lastUpdate = Date.now();
      let workers = [], enemies = [];
      let joystickActive = false;
      let joystickCenterX = 0, joystickCenterY = 0;
      let joystickHandleX = 0, joystickHandleY = 0;
      let joystickDirection = { x: 0, y: 0 };

      // Timers & Loading
      let nextEnergyTime = 0, energyTimer = null, energyRegenerationStartTime = 0;
      let totalAssets = 0, loadedAssets = 0, loadingInterval = null;
      let metalFacUpgradeEndTime = 0, kristalFacUpgradeEndTime = 0;

      // Assets
      const imgBG = new Image();
      imgBG.src = "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/bg-H8I42XFyjR45PCLXsG4fQp7B323kKw.webp?37vf";
      const imgDayi = new Image();
      imgDayi.src = "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69";
      const imgMiner1 = new Image();
      imgMiner1.src = "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner1-removebg-preview-49BIGjfxcrYSez39WOvCLyIxeY56q2.webp?pMVT";
      const imgMiner2 = new Image();
      imgMiner2.src = "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner2-removebg-preview-d2bFviiOsn7cXyHcptbNJtKdHoMuvp.webp?1b6n";
      const imgInfected = new Image();
      imgInfected.src = "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/infect-removebg-preview-5HhmhH4V5DqNbYNXhiFg3o9Z0RkEIj.webp?uN63";

      // ============================================
      // INTRO & LOADING LOGIC
      // ============================================
      async function startIntro() {
        // SDK logic handled in HEAD for speed.
        // We focus on visuals here.
        const introOverlay = document.getElementById("introOverlay");
        introOverlay.style.display = "flex";
        
        // Auto transition to loading after 3s
        setTimeout(() => {
          introOverlay.style.display = "none";
          startLoading();
        }, 3000);
      }

      // ============================================
      // UI LOGIC (Modals, Panels)
      // ============================================
      function openHowToPlay() { document.getElementById("howToPlayScreen").style.display = "flex"; }
      function closeHowToPlay() { document.getElementById("howToPlayScreen").style.display = "none"; }
      function openUpgradeModal() { document.getElementById("upgradeModal").style.display = "block"; }
      function closeUpgradeModal() { document.getElementById("upgradeModal").style.display = "none"; }
      function openEndGameConfirmation() { document.getElementById("endGameModal").style.display = "block"; }
      function closeEndGameConfirmation() { document.getElementById("endGameModal").style.display = "none"; }
      
      function triggerManualEndGame() {
        closeEndGameConfirmation();
        const sdk = window.sdk || window.FarcasterFrameSDK || window.Farcaster;
        
        if (sdk) {
          alert("Game Over! Score submitted: " + Math.floor(tranium));
          try {
            if (sdk.actions && sdk.actions.close) sdk.actions.close();
            else if (sdk.close) sdk.close();
          } catch(e) { console.warn("Close failed", e); }
        } else {
          alert("Game Over! Score: " + Math.floor(tranium));
          location.reload();
        }
      }

      function openSwapModal() {
        document.getElementById("swapModal").style.display = "block";
        document.getElementById("swapAmountInput").value = "";
      }
      function closeSwapModal() { document.getElementById("swapModal").style.display = "none"; }
      function setSwapPct(pct) {
        let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));
        document.getElementById("swapAmountInput").value = Math.floor(maxRefine * pct);
      }
      function executeSwap() {
        let amount = parseInt(document.getElementById("swapAmountInput").value);
        let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));
        if (amount > 0 && amount <= maxRefine) {
          tranium += amount;
          metal -= amount;
          kristal -= amount;
          updateUI();
          saveData();
          closeSwapModal();
        } else {
          alert("Invalid amount or insufficient resources!");
        }
      }

      // ============================================
      // SAVE / LOAD SYSTEM
      // ============================================
      if (localStorage.getItem("w_last_time")) {
        metal = parseFloat(localStorage.getItem("w_metal")) || 0;
        kristal = parseFloat(localStorage.getItem("w_kristal")) || 0;
        tranium = parseInt(localStorage.getItem("w_tranium")) || 0;
        metalWorkers = parseInt(localStorage.getItem("w_mw")) || 0;
        kristalWorkers = parseInt(localStorage.getItem("w_kw")) || 0;
        metalFacLvl = parseInt(localStorage.getItem("w_mfl")) || 1;
        kristalFacLvl = parseInt(localStorage.getItem("w_kfl")) || 1;
        energy = parseInt(localStorage.getItem("w_energy") || "10");
        lastTime = parseInt(localStorage.getItem("w_last_time")) || Date.now();
        nextEnergyTime = parseInt(localStorage.getItem("w_next_energy_time")) || 0;
        energyRegenerationStartTime = parseInt(localStorage.getItem("w_energy_reg_start")) || 0;
        metalFacUpgradeEndTime = parseInt(localStorage.getItem("w_mfue")) || 0;
        kristalFacUpgradeEndTime = parseInt(localStorage.getItem("w_kfue")) || 0;
        updateOfflineEnergyRegeneration();
      }

      function saveData() {
        localStorage.setItem("w_metal", metal);
        localStorage.setItem("w_kristal", kristal);
        localStorage.setItem("w_tranium", tranium);
        localStorage.setItem("w_mw", metalWorkers);
        localStorage.setItem("w_kw", kristalWorkers);
        localStorage.setItem("w_mfl", metalFacLvl);
        localStorage.setItem("w_kfl", kristalFacLvl);
        localStorage.setItem("w_energy", energy);
        localStorage.setItem("w_last_time", Date.now());
        localStorage.setItem("w_next_energy_time", nextEnergyTime);
        localStorage.setItem("w_energy_reg_start", energyRegenerationStartTime);
        localStorage.setItem("w_mfue", metalFacUpgradeEndTime);
        localStorage.setItem("w_kfue", kristalFacUpgradeEndTime);
      }

      // ============================================
      // LOADING ASSETS
      // ============================================
      function startLoading() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        const progressBar = document.querySelector(".loading-progress-bar");
        const percentageText = document.querySelector(".loading-percentage");
        const loadingText = document.querySelector(".loading-text");

        loadingOverlay.style.display = "flex";
        let progress = 0;
        const loadingMessages = ["Initializing Systems", "Loading Resources", "Preparing Miners", "Setting Up Factories", "Calibrating Energy Grid", "Ready to Mine!"];
        let messageIndex = 0;

        loadingInterval = setInterval(() => {
          if (progress < 100) {
            progress += Math.random() * 10 + 5;
            if (progress > 100) progress = 100;
            if (progress % 15 < 5 && messageIndex < loadingMessages.length - 1) {
              messageIndex = Math.min(Math.floor(progress / 15), loadingMessages.length - 1);
              loadingText.textContent = loadingMessages[messageIndex];
            }
            progressBar.style.width = progress + "%";
            percentageText.textContent = Math.floor(progress) + "%";
          }
        }, 150);
        loadAssets();
      }

      function loadAssets() {
        totalAssets = 5;
        const images = [imgBG, imgDayi, imgMiner1, imgMiner2, imgInfected];
        images.forEach((img) => {
          if (img.complete) assetLoaded();
          else { img.onload = assetLoaded; img.onerror = assetLoaded; }
        });
      }

      function assetLoaded() {
        loadedAssets++;
        if (loadedAssets >= totalAssets) setTimeout(completeLoading, 500);
      }

      function completeLoading() {
        clearInterval(loadingInterval);
        document.querySelector(".loading-progress-bar").style.width = "100%";
        document.querySelector(".loading-percentage").textContent = "100%";
        document.querySelector(".loading-text").textContent = "Ready to Mine!";

        setTimeout(() => {
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("overlay").style.display = "flex";
          initHub();
        }, 1000);
      }

      // ============================================
      // ENERGY SYSTEM
      // ============================================
      function updateOfflineEnergyRegeneration() {
        const now = Date.now();
        if (energy < 10 && energyRegenerationStartTime > 0) {
          const timePassed = now - energyRegenerationStartTime;
          const energyToAdd = Math.floor(timePassed / 3600000);
          if (energyToAdd > 0) {
            const newEnergy = Math.min(10, energy + energyToAdd);
            energy = newEnergy;
            energyRegenerationStartTime = now - (timePassed % 3600000);
            if (energy >= 10) { energyRegenerationStartTime = 0; nextEnergyTime = 0; }
            else { nextEnergyTime = energyRegenerationStartTime + 3600000; }
            saveData(); updateUI();
          } else if (nextEnergyTime > 0 && nextEnergyTime <= now && energy < 10) {
             energy++; updateEnergyTimers(); saveData(); updateUI();
          }
        } else if (energy < 10 && energyRegenerationStartTime === 0) {
          updateEnergyTimers();
        }
      }

      function updateEnergyTimers() {
        const now = Date.now();
        if (energy < 10) {
          if (energyRegenerationStartTime === 0) energyRegenerationStartTime = now;
          const timeSinceStart = now - energyRegenerationStartTime;
          const nextEnergyIn = 3600000 - (timeSinceStart % 3600000);
          nextEnergyTime = now + nextEnergyIn;
          if (energy >= 10) { energyRegenerationStartTime = 0; nextEnergyTime = 0; }
        } else { energyRegenerationStartTime = 0; nextEnergyTime = 0; }
        saveData();
      }

      function updateEnergyCountdown() {
        const energyStatus = document.getElementById("energyStatus");
        const energyUI = document.getElementById("energyUI");
        if (!energyStatus || !energyUI) return;
        const now = Date.now();
        
        if (energy >= 10) {
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (FULL)`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
          return;
        }
        if (energyRegenerationStartTime === 0) updateEnergyTimers();
        if (nextEnergyTime > 0 && now >= nextEnergyTime) {
          if (energy < 10) { energy++; updateEnergyTimers(); saveData(); updateUI(); }
        }
        if (nextEnergyTime > now) {
          const timeLeft = nextEnergyTime - now;
          const minutesLeft = Math.floor(timeLeft / 60000).toString().padStart(2, "0");
          const secondsLeft = Math.floor((timeLeft % 60000) / 1000).toString().padStart(2, "0");
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Next in ${minutesLeft}:${secondsLeft})`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
        } else {
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Ready!)`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
        }
      }

      function startEnergyCountdown() {
        if (energyTimer) clearInterval(energyTimer);
        updateOfflineEnergyRegeneration();
        updateEnergyCountdown();
        energyTimer = setInterval(updateEnergyCountdown, 1000);
      }

      // ============================================
      // FACTORY UPGRADE SYSTEM
      // ============================================
      function checkUpgradeProgress() {
        const now = Date.now();
        if (metalFacUpgradeEndTime > 0 && now >= metalFacUpgradeEndTime) {
          metalFacLvl++; metalFacUpgradeEndTime = 0; updateUI(); saveData();
        }
        if (kristalFacUpgradeEndTime > 0 && now >= kristalFacUpgradeEndTime) {
          kristalFacLvl++; kristalFacUpgradeEndTime = 0; updateUI(); saveData();
        }
      }

      const PAYMENT_ADDRESS = "0x3cCAF6612D0e134c14aa148f7F668a717DA645Fe";
      const BASE_ETH_COST = 0.0005; 
      const BASE_UPGRADE_TIME = 2 * 60 * 60 * 1000;
      const BASE_CHAIN_ID = 8453;

      function getUpgradeCost(level) { return BASE_ETH_COST * Math.pow(2, level - 1); }
      function getUpgradeTime(level) { return BASE_UPGRADE_TIME * Math.pow(2, level - 1); }
      function formatTimeHours(ms) {
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        return `${hours}h ${minutes}m`;
      }
      function formatTime(ms) {
        if (ms <= 0) return "00:00";
        const m = Math.floor(ms / 60000).toString().padStart(2, "0");
        const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, "0");
        return `${m}:${s}`;
      }

      async function sendETHPayment(amountETH) {
        if (typeof window.ethereum === "undefined") {
          alert("Please install MetaMask or use a Web3 wallet!"); return false;
        }
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          const provider = new ethers.BrowserProvider(window.ethereum);
          const network = await provider.getNetwork();
          if (Number(network.chainId) !== BASE_CHAIN_ID) {
            try { await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x2105" }] }); } 
            catch (err) {
              if (err.code === 4902) {
                await window.ethereum.request({ method: "wallet_addEthereumChain", params: [{ chainId: "0x2105", chainName: "Base", nativeCurrency: { name: "ETH", symbol: "ETH", decimals: 18 }, rpcUrls: ["https://mainnet.base.org"], blockExplorerUrls: ["https://basescan.org"] }] });
              } else throw err;
            }
          }
          const signer = await provider.getSigner();
          const tx = await signer.sendTransaction({ to: PAYMENT_ADDRESS, value: ethers.parseEther(amountETH.toString()) });
          await tx.wait();
          return true;
        } catch (error) {
          console.error("Payment error:", error);
          alert("Payment failed: " + (error.message || "Unknown error"));
          return false;
        }
      }

      async function upgradeFactory(type) {
        let currentLevel;
        if (type === "metal") {
          if (metalFacUpgradeEndTime > Date.now()) { alert("Upgrade in progress!"); return; }
          currentLevel = metalFacLvl;
        } else {
          if (kristalFacUpgradeEndTime > Date.now()) { alert("Upgrade in progress!"); return; }
          currentLevel = kristalFacLvl;
        }
        const ethCost = getUpgradeCost(currentLevel);
        const uTime = getUpgradeTime(currentLevel);
        if (!confirm(`üè≠ Upgrade Level ${currentLevel+1}\nüí∞ Cost: ${ethCost} ETH\n‚è±Ô∏è Time: ${formatTimeHours(uTime)}\n\nProceed?`)) return;
        
        const success = await sendETHPayment(ethCost);
        if (!success) return;

        if (type === "metal") metalFacUpgradeEndTime = Date.now() + uTime;
        else kristalFacUpgradeEndTime = Date.now() + uTime;
        alert("‚úÖ Upgrade started!");
        updateUI(); saveData();
      }

      // ============================================
      // GAME INITIALIZATION (Hub)
      // ============================================
      function initHub() {
        // Safe Canvas Resize
        let targetWidth = window.innerWidth;
        let targetHeight = window.innerHeight;
        // Limit aspect ratio for ultra-wide monitors if on PC
        if (targetWidth > 1920) {
          const ratio = window.innerHeight / window.innerWidth;
          targetWidth = 1920;
          targetHeight = 1920 * ratio;
        }
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        canvas.style.width = "100vw";
        canvas.style.height = "100vh";

        const now = Date.now();
        const secondsPassed = Math.floor((now - lastTime) / 1000);
        processMining(secondsPassed);
        checkUpgradeProgress();
        updateUI();
        startEnergyCountdown();

        // Spawn Entities
        if (workers.length === 0) for (let i = 0; i < 40; i++) spawnWorker();
        if (enemies.length === 0) for (let i = 0; i < 15; i++) spawnEnemy();

        // Start Loop
        requestAnimationFrame(gameLoop);
        
        // Intervals
        setInterval(saveData, 3000);
        setInterval(checkUpgradeProgress, 1000);
        
        // Joystick Init
        initJoystick();

        // Show FPS if configured
        document.getElementById("fps-counter").style.display = "block";

        // Hide Joystick on PC (non-touch)
        if (!('ontouchstart' in window) && navigator.maxTouchPoints === 0) {
           document.getElementById("joystickContainer").style.display = "none";
        }
      }

      // ============================================
      // JOYSTICK LOGIC
      // ============================================
      function initJoystick() {
        const jC = document.getElementById("joystickContainer");
        const rect = jC.getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
        joystickCenterY = rect.top + rect.height / 2;
        joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;

        jC.addEventListener("touchstart", handleJStart, { passive: false });
        jC.addEventListener("touchmove", handleJMove, { passive: false });
        jC.addEventListener("touchend", handleJEnd, { passive: false });
        jC.addEventListener("mousedown", handleJStart);
        document.addEventListener("mousemove", handleJMove);
        document.addEventListener("mouseup", handleJEnd);
      }

      function handleJStart(e) {
        e.preventDefault();
        joystickActive = true;
        updateJPos(e);
      }
      function handleJMove(e) {
        if (!joystickActive) return;
        e.preventDefault();
        updateJPos(e);
      }
      function handleJEnd(e) {
        if (!joystickActive) return;
        e.preventDefault();
        joystickActive = false;
        joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;
        joystickDirection = { x: 0, y: 0 };
        updateJVisual();
        player.isMoving = false;
      }

      function updateJPos(e) {
        let cx, cy;
        if (e.type.includes("touch")) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        else { cx = e.clientX; cy = e.clientY; }

        const dx = cx - joystickCenterX;
        const dy = cy - joystickCenterY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const limitedDist = Math.min(dist, JOYSTICK_RADIUS);
        const angle = Math.atan2(dy, dx);
        
        joystickHandleX = joystickCenterX + Math.cos(angle) * limitedDist;
        joystickHandleY = joystickCenterY + Math.sin(angle) * limitedDist;
        
        joystickDirection.x = limitedDist > 0 ? dx / dist : 0;
        joystickDirection.y = limitedDist > 0 ? dy / dist : 0;
        
        updateJVisual();
        player.isMoving = true;
      }

      function updateJVisual() {
        const handle = document.getElementById("joystickHandle");
        if (handle) {
           const jC = document.getElementById("joystickContainer");
           const rect = jC.getBoundingClientRect();
           const x = joystickHandleX - rect.left - JOYSTICK_HANDLE_RADIUS;
           const y = joystickHandleY - rect.top - JOYSTICK_HANDLE_RADIUS;
           handle.style.transform = `translate(${x}px, ${y}px)`;
        }
      }

      // ============================================
      // GAME LOGIC
      // ============================================
      function updateUI() {
        const el = (id) => document.getElementById(id);
        if(el("traniumCount")) el("traniumCount").innerText = Math.floor(tranium);
        if(el("metalCount")) el("metalCount").innerText = Math.floor(metal);
        if(el("kristalCount")) el("kristalCount").innerText = Math.floor(kristal);
        if(el("metalWorkers")) el("metalWorkers").innerText = `${metalWorkers} Miners (${(metalWorkers * BASE_WORKER_SPEED * metalFacLvl).toFixed(3)}/s)`;
        if(el("kristalWorkers")) el("kristalWorkers").innerText = `${kristalWorkers} Miners (${(kristalWorkers * BASE_WORKER_SPEED * kristalFacLvl).toFixed(3)}/s)`;
        
        el("metalFacLevel").innerText = `Lvl ${metalFacLvl}`;
        el("kristalFacLevel").innerText = `Lvl ${kristalFacLvl}`;
        
        const mCost = getUpgradeCost(metalFacLvl), kCost = getUpgradeCost(kristalFacLvl);
        const mTime = getUpgradeTime(metalFacLvl), kTime = getUpgradeTime(kristalFacLvl);
        
        el("costMetalFac").innerText = `Œû${mCost} ETH`;
        el("costKristalFac").innerText = `Œû${kCost} ETH`;
        el("metalBuildTime").innerText = `‚è±Ô∏è ${formatTimeHours(mTime)}`;
        el("kristalBuildTime").innerText = `‚è±Ô∏è ${formatTimeHours(kTime)}`;
        
        el("resUI").innerText = `‚öôÔ∏è: ${Math.floor(metal)} | üíé: ${Math.floor(kristal)}`;
        el("healthUI").innerText = "‚ù§Ô∏è: " + health;
        
        updateEnergyCountdown();
        
        const now = Date.now();
        const mBtn = el("upMetalFac");
        if (metalFacUpgradeEndTime > now) {
           mBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(metalFacUpgradeEndTime - now)}`;
           mBtn.disabled = true;
        } else {
           mBtn.innerHTML = `UPGRADE <span id="costMetalFac">Œû${mCost} ETH</span>`;
           mBtn.disabled = false;
        }

        const kBtn = el("upKristalFac");
        if (kristalFacUpgradeEndTime > now) {
           kBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(kristalFacUpgradeEndTime - now)}`;
           kBtn.disabled = true;
        } else {
           kBtn.innerHTML = `UPGRADE <span id="costKristalFac">Œû${kCost} ETH</span>`;
           kBtn.disabled = false;
        }
        
        el("swapBtn").disabled = Math.min(Math.floor(metal), Math.floor(kristal)) <= 0;
      }

      function spawnWorker() {
        const isM = Math.random() > 0.5;
        workers.push({
          x: 100 + Math.random() * (WORLD_SIZE - 200),
          y: 100 + Math.random() * (WORLD_SIZE - 200),
          img: isM ? imgMiner1 : imgMiner2,
          type: isM ? "metal" : "kristal",
        });
      }

      function spawnEnemy() {
        enemies.push({
          x: Math.random() * WORLD_SIZE,
          y: Math.random() * WORLD_SIZE,
          isChasing: false,
          spawnTime: Date.now(),
          currentSpeed: 3.8, // Base Speed
        });
      }

      function attemptStart() {
        if (energy > 0) {
          energy--;
          health = 3;
          updateEnergyTimers();
          saveData();
          updateUI();
          document.getElementById("overlay").style.display = "none";
          document.getElementById("ui").style.opacity = "1";
          document.getElementById("joystickContainer").style.display = "block";
          isStarted = true;
        } else {
          alert("Not enough energy! Wait for energy to regenerate.");
        }
      }

      function processMining(dtSec) {
        const metalGain = dtSec * (metalWorkers * BASE_WORKER_SPEED * metalFacLvl);
        const kristalGain = dtSec * (kristalWorkers * BASE_WORKER_SPEED * kristalFacLvl);
        metal += metalGain;
        kristal += kristalGain;
        if (!isStarted) updateUI();
      }

      function update(dt) {
        processMining(dt);
        checkUpgradeProgress();
        if (!isStarted) return;

        // Player Movement
        if (joystickActive) {
          player.x += joystickDirection.x * player.speed;
          player.y += joystickDirection.y * player.speed;
          player.flipX = joystickDirection.x < 0;
          player.isMoving = true;
          walkCycle += 0.35;
        } else {
          if (isTouching) {
            let dx = player.targetX - player.x;
            let dy = player.targetY - player.y;
            let dist = Math.hypot(dx, dy);
            if (dist > 5) {
              player.x += (dx / dist) * player.speed;
              player.y += (dy / dist) * player.speed;
              player.flipX = dx < 0;
              player.isMoving = true;
              walkCycle += 0.35;
            } else player.isMoving = false;
          } else player.isMoving = false;
        }
        
        // Boundaries
        player.x = Math.max(50, Math.min(WORLD_SIZE - 50, player.x));
        player.y = Math.max(50, Math.min(WORLD_SIZE - 50, player.y));
        camera.x = Math.max(0, Math.min(WORLD_SIZE - canvas.width, player.x - canvas.width / 2));
        camera.y = Math.max(0, Math.min(WORLD_SIZE - canvas.height, player.y - canvas.height / 2));

        // Collect Workers
        for (let i = workers.length - 1; i >= 0; i--) {
          let w = workers[i];
          if (Math.hypot(player.x - w.x, player.y - w.y) < 70) {
             if (w.type === "metal") metalWorkers++; else kristalWorkers++;
             workers.splice(i, 1);
             updateUI();
             spawnWorker();
          }
        }

        // Enemies
        const now = Date.now();
        for (let i = enemies.length - 1; i >= 0; i--) {
          let en = enemies[i];
          // Stop chasing after 5s
          if (en.isChasing && now - en.chaseStartTime > 5000) {
            enemies.splice(i, 1); spawnEnemy(); continue;
          }
          
          let d = Math.hypot(player.x - en.x, player.y - en.y);
          if (d < 400 && !en.isChasing) {
            en.isChasing = true;
            en.chaseStartTime = now;
          }
          
          if (en.isChasing) {
            en.currentSpeed += 0.005;
            // Apply Speed Cap (Turbo Mode logic integrated)
            if (en.currentSpeed > ENEMY_MAX_SPEED) en.currentSpeed = ENEMY_MAX_SPEED;
            
            en.x += ((player.x - en.x) / d) * en.currentSpeed;
            en.y += ((player.y - en.y) / d) * en.currentSpeed;
          }
          
          if (d < 50) {
            health--;
            updateUI();
            enemies.splice(i, 1);
            spawnEnemy();
            if (health <= 0) {
              isStarted = false;
              saveData();
              endGame();
            }
          }
        }
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(-camera.x, -camera.y);
        
        if (imgBG.complete) ctx.drawImage(imgBG, 0, 0, WORLD_SIZE, WORLD_SIZE);
        else { ctx.fillStyle = "#111"; ctx.fillRect(0,0,WORLD_SIZE,WORLD_SIZE); }

        workers.forEach((w) => {
          ctx.save();
          ctx.shadowBlur = 10;
          ctx.shadowColor = w.type === "metal" ? "#ffcc00" : "#00ffff";
          ctx.drawImage(w.img, w.x - 40, w.y - 40, 80, 80);
          ctx.restore();
        });

        enemies.forEach((en) => {
          ctx.save();
          ctx.shadowBlur = 20;
          ctx.shadowColor = "red";
          ctx.fillStyle = "rgba(255, 0, 0, 0.25)";
          ctx.beginPath();
          ctx.arc(en.x, en.y, 45, 0, Math.PI * 2);
          ctx.fill();
          if (en.isChasing) {
            let tr = 5000 - (Date.now() - en.chaseStartTime);
            if (tr < 1000) ctx.globalAlpha = tr / 1000;
          }
          ctx.drawImage(imgInfected, en.x - 40, en.y - 50, 80, 100);
          ctx.restore();
        });

        // Player
        ctx.save();
        let bounce = player.isMoving ? Math.abs(Math.sin(walkCycle)) * 14 : 0;
        ctx.translate(player.x, player.y - bounce);
        if (player.flipX) ctx.scale(-1, 1);
        ctx.drawImage(imgDayi, -50, -60, 100, 120);
        ctx.restore();
        
        ctx.restore();
      }

      // FPS Control
      let fpsLastTime = performance.now();
      let frameCount = 0;
      let lastFpsCheck = performance.now();
      
      function gameLoop(timestamp) {
        // Calculate DT
        const dt = (timestamp - fpsLastTime) / 1000;
        fpsLastTime = timestamp;

        // Update
        update(dt);
        draw();

        // FPS Counter
        frameCount++;
        if (timestamp - lastFpsCheck >= 1000) {
          document.getElementById("fps-counter").innerText = "FPS: " + frameCount;
          frameCount = 0;
          lastFpsCheck = timestamp;
        }

        requestAnimationFrame(gameLoop);
      }

      // ============================================
      // INPUT HANDLING (Touch/Mouse)
      // ============================================
      const setTarget = (e) => {
        if (joystickActive) return;
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
        const cy = e.touches ? e.touches[0].clientY - rect.top : e.clientY - rect.top;
        // Fix scaling if canvas css width differs from internal width
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        player.targetX = cx * scaleX + camera.x;
        player.targetY = cy * scaleY + camera.y;
        player.isMoving = true;
      };

      // Mouse
      window.addEventListener("mousedown", (e) => {
        const jr = document.getElementById("joystickContainer").getBoundingClientRect();
        if (e.clientX >= jr.left && e.clientX <= jr.right && e.clientY >= jr.top && e.clientY <= jr.bottom) return;
        isTouching = true; setTarget(e);
      });
      window.addEventListener("mousemove", (e) => { if (isTouching && !joystickActive) setTarget(e); });
      window.addEventListener("mouseup", () => { isTouching = false; if(!joystickActive) player.isMoving = false; });

      // Touch
      window.addEventListener("touchstart", (e) => {
        const jr = document.getElementById("joystickContainer").getBoundingClientRect();
        const tx = e.touches[0].clientX; const ty = e.touches[0].clientY;
        if (tx >= jr.left && tx <= jr.right && ty >= jr.top && ty <= jr.bottom) return;
        isTouching = true; setTarget(e);
      }, { passive: false });
      window.addEventListener("touchmove", (e) => {
        e.preventDefault(); 
        if (isTouching && !joystickActive) setTarget(e);
      }, { passive: false });
      window.addEventListener("touchend", () => { isTouching = false; if(!joystickActive) player.isMoving = false; });

      function endGame() {
        document.getElementById("overlay").style.display = "flex";
        document.getElementById("ui").style.opacity = "0";
        document.getElementById("joystickContainer").style.display = "none";
        if (energyTimer) clearInterval(energyTimer);
        startEnergyCountdown();
      }

      // Start Entry Point (SDK logic handles itself above, visuals triggered here)
      window.onload = startIntro;
    </script>
  </body>
</html>

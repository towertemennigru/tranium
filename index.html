<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="base:app_id" content="6957083ec63ad876c9081cd6" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />   
    <meta property="og:title" content="TRANIUM VERSE - Strategy Hub" />
    <meta property="og:description" content="Collect resources and refine Tranium to dominate the Verse. A strategic mining game on Farcaster." />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://tranium-xi.vercel.app/preview.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    
    <meta property="fc:frame" content='{"version": "next", "imageUrl": "https://tranium-xi.vercel.app/preview.jpg", "button": {"title": "Start Mining", "action": {"type": "launch_frame", "name": "Tranium Verse", "url": "https://tranium-xi.vercel.app", "splashImageUrl": "https://tranium-xi.vercel.app/preview.jpg", "splashBackgroundColor": "#0a0a00"}}}' />
    <meta name="fc:miniapp" content="hosted" />
    
    
    <title>TRANIUM VERSE - Strategy Hub</title>
    
   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      // BURAYA 'onSnapshot' EKLENDƒ∞ Dƒ∞KKAT ET:
      import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";

      // SENƒ∞N YENƒ∞ PROJE AYARLARIN (tranium-6f126)
      const firebaseConfig = {
        apiKey: "AIzaSyD5ozuYZ7YWoHz6qC4zXO-hDwVEnHCa-6g",
        authDomain: "tranium-6f126.firebaseapp.com",
        projectId: "tranium-6f126",
        storageBucket: "tranium-6f126.firebasestorage.app",
        messagingSenderId: "570304399178",
        appId: "1:570304399178:web:d83ce14dc3fc91b958e3b3",
        measurementId: "G-6Q23R774CL"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const analytics = getAnalytics(app);

      window.firebaseDB = db;
      // onSnapshot'ƒ± buraya da ekledik ki a≈üaƒüƒ±dan eri≈üebilelim
      window.firebaseFunctions = { doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, getDocs };
      
      console.log("üî• Firebase (Firestore) Realtime Listener ile hazƒ±r!");
    </script>
    <script type="module">
    // En g√ºncel Frame SDK'sƒ±nƒ± √ßekiyoruz
    import { sdk } from 'https://esm.sh/@farcaster/frame-sdk';

    // SDK'yƒ± global deƒüi≈ükene atƒ±yoruz ki her yerden eri≈üelim
    window.farcasterSDK = sdk;
    window.isMiniApp = true;

    const triggerReady = async () => {
    try {
        // SDK'nƒ±n context (baƒülam) bilgisini bekle
        const context = await sdk.context;

        // Eƒüer context gelirse (yani Farcaster i√ßindeysek)
        if (context) {
            console.log("‚úÖ Farcaster Environment Detected");
            
            // Engelleyici ekranƒ± kaldƒ±r
            document.getElementById("desktop-blocker").style.display = "none";
            
            // SDK'ya hazƒ±r olduƒüumuzu bildir
            sdk.actions.ready();

            // Varsa intro'yu ba≈ülat
            if(window.startIntro) window.startIntro();
        } else {
            // Context yoksa (Normal tarayƒ±cƒ±)
            console.warn("‚ùå Not in Farcaster");
            // Engelleyici ekran kalmaya devam eder
        }
    } catch (e) {
        console.error("SDK Init Error:", e);
        // Hata olursa da engelleyici ekran kalƒ±r
    }
};

    document.addEventListener('DOMContentLoaded', triggerReady);
</script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>

<script type="module">
    import { createAppKit } from 'https://esm.sh/@reown/appkit@1.6.0';
    import { EthersAdapter } from 'https://esm.sh/@reown/appkit-adapter-ethers@1.6.0';
    import { base } from 'https://esm.sh/@reown/appkit/networks@1.6.0';

    // Global eri≈üim i√ßin window'a atƒ±yoruz
    window.AppKitLib = {
        createAppKit,
        EthersAdapter,
        networks: [base]
    };
    console.log("AppKit K√ºt√ºphaneleri Y√ºklendi");
</script>

    <style>
      #transactionOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85); /* Arkasƒ± g√∂r√ºn√ºr ama tƒ±klanamaz */
  z-index: 999999; /* Her ≈üeyin √ºst√ºnde */
  display: none; /* Varsayƒ±lan gizli */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(5px); /* Arkasƒ± bulanƒ±kla≈üƒ±r */
}
.tx-spinner {
  width: 60px;
  height: 60px;
  border: 6px solid #333;
  border-top: 6px solid #ffcc00; /* Sarƒ± renk */
  border-radius: 50%;
  animation: spin 1s infinite linear;
  margin-bottom: 20px;
}
.tx-text {
  color: #ffcc00;
  font-weight: 900;
  letter-spacing: 2px;
  font-size: 18px;
  animation: pulse 1.5s infinite;
}
      :root {
        --gold: #ffcc00;
        --neon: #00ffcc;
        --dark: #0a0a00;
        --panel: rgba(255, 255, 255, 0.05);
        --red: #ff4444;
        --disease-red: #ff2222;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        margin: 0;
        padding: 0;
        background-color: var(--dark);
        overflow: hidden;
        touch-action: none;
        font-family: "Segoe UI", sans-serif;
        color: white;
        height: 100vh;
        width: 100vw;
        -webkit-user-select: none; 
        user-select: none;
      }
      #gameCanvas {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
        touch-action: none;
        image-rendering: pixelated;
      }

      /* --- YENƒ∞ EKLENEN LOADER STƒ∞LLERƒ∞ --- */
      #loader {
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%;
        background: #0a0a00; 
        z-index: 9999;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
      }
      .spinner { 
        width: 50px; 
        height: 50px; 
        border: 5px solid #333; 
        border-top: 5px solid #ffcc00; 
        border-radius: 50%; 
        animation: spin 1s infinite linear; 
      }
      .text { 
        margin-top: 20px; 
        color: #00ffcc; 
        font-weight: bold; 
        letter-spacing: 2px; 
      }

      /* --- MEVCUT INTRO/OVERLAY STƒ∞LLERƒ∞ --- */
      #introOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #000000 0%, #1a0000 50%, #000000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        overflow: hidden;
      }
      .intro-container {
        text-align: center;
        position: relative;
        z-index: 2;
        animation: introFadeIn 1.5s ease-out;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .disease-logo {
        font-size: min(60px, 12vw);
        font-weight: 900;
        color: var(--disease-red);
        text-transform: uppercase;
        letter-spacing: 8px;
        margin-bottom: 10px;
        text-shadow:
          0 0 20px rgba(255, 34, 34, 0.7),
          0 0 40px rgba(255, 34, 34, 0.5);
        position: relative;
      }
      .disease-logo::after {
        content: "";
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 4px;
        background: linear-gradient(90deg, transparent, var(--disease-red), transparent);
      }
      .presents-text {
        font-size: min(18px, 4vw);
        color: rgba(255, 255, 255, 0.7);
        margin: 20px 0;
        font-weight: 300;
        letter-spacing: 4px;
        animation: pulse 2s infinite;
      }
      .game-title-intro {
        font-size: min(48px, 10vw);
        font-weight: 900;
        color: var(--gold);
        text-transform: uppercase;
        margin: 30px 0;
        text-shadow: 0 0 15px rgba(255, 204, 0, 0.5);
        letter-spacing: 4px;
      }
      .game-subtitle {
        font-size: min(16px, 3.5vw);
        color: rgba(255, 255, 255, 0.6);
        margin-top: 10px;
        font-weight: 300;
        letter-spacing: 2px;
      }
      #enterBtn {
        margin-top: 40px;
        background: transparent;
        color: var(--neon);
        border: 2px solid var(--neon);
        padding: 15px 40px;
        font-size: 18px;
        font-weight: 900;
        letter-spacing: 3px;
        cursor: pointer;
        text-transform: uppercase;
        box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
        transition: all 0.3s ease;
        animation: btnPulse 2s infinite;
        display: none; 
      }
      #enterBtn:active {
        background: var(--neon);
        color: #000;
        transform: scale(0.95);
      }
      @keyframes btnPulse {
        0% { box-shadow: 0 0 15px rgba(0, 255, 204, 0.3); opacity: 0.8; }
        50% { box-shadow: 0 0 30px rgba(0, 255, 204, 0.6); opacity: 1; }
        100% { box-shadow: 0 0 15px rgba(0, 255, 204, 0.3); opacity: 0.8; }
      }

      /* --- MEVCUT LOADING STƒ∞LLERƒ∞ (Yedek) --- */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a00 0%, #001a00 100%);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .loading-container {
        text-align: center;
        width: 90%;
        max-width: 400px;
        animation: loadingFadeIn 1s ease;
      }
      .loading-logo {
        font-size: min(32px, 7vw);
        font-weight: 900;
        color: var(--neon);
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 3px;
        position: relative;
      }
      .loading-logo::before {
        content: "‚õèÔ∏è";
        margin-right: 10px;
      }
      .loading-spinner {
        width: 80px;
        height: 80px;
        border: 4px solid rgba(0, 255, 204, 0.1);
        border-top-color: var(--neon);
        border-radius: 50%;
        margin: 0 auto 30px;
        animation: spin 1s linear infinite;
      }
      .loading-progress-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 15px;
      }
      .loading-progress-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--neon), #00ff88);
        border-radius: 3px;
        transition: width 0.3s ease;
        box-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
      }
      .loading-text {
        font-size: min(18px, 4vw);
        color: var(--neon);
        margin-bottom: 20px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .loading-percentage {
        font-size: min(24px, 5vw);
        font-weight: 900;
        color: var(--gold);
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
      }
      .loading-tip {
        font-size: min(12px, 2.5vw);
        color: rgba(255, 255, 255, 0.5);
        margin-top: 30px;
        font-style: italic;
        max-width: 300px;
        line-height: 1.4;
      }

      /* --- ANA OYUN UI --- */
      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, #000 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        padding: 20px;
        justify-content: space-evenly;
        overflow: hidden;
        gap: 0;
        display: none;
      }
      
      /* --- JOYSTICK & UI Bƒ∞RLE≈ûTƒ∞RME --- */
      #ui { 
        position: absolute; 
        top: 15px; 
        left: 15px; 
        right: 15px; 
        z-index: 10; 
        display: none; /* Varsayƒ±lan olarak gizli */
        justify-content: space-between; 
        font-weight: bold; 
        text-shadow: 2px 2px 4px black;
        font-size: min(14px, 3.5vw);
        pointer-events: none; /* Tƒ±klamalarƒ± alta ge√ßir */
      }
      /* UI i√ßindeki butonlarƒ±n tƒ±klanabilir olmasƒ± i√ßin */
      #ui > * { pointer-events: auto; }

      #joystickContainer { 
        position: fixed; 
        bottom: 30px; 
        left: 30px; 
        width: 100px; 
        height: 100px; 
        z-index: 20; 
        display: none; /* Varsayƒ±lan olarak gizli */
        pointer-events: auto;
      }
      #joystickBase { 
        width: 100%; 
        height: 100%; 
        background: rgba(255,255,255,0.1); 
        border: 2px solid rgba(255,255,255,0.3); 
        border-radius: 50%; 
        position: absolute;
      }
      #joystickHandle { 
        position: absolute; 
        top: 50%; 
        left: 50%; 
        width: 50px; 
        height: 50px; 
        background: #ffcc00; 
        border-radius: 50%; 
        transform: translate(-50%, -50%); 
        box-shadow: 0 0 15px #ffcc00; 
      }

      /* --- MODAL ve Dƒ∞ƒûER PENCERELER --- */
      #howToPlayScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.98);
        z-index: 300;
        display: none;
        flex-direction: column;
        align-items: center;
        padding: max(env(safe-area-inset-top), 20px) 20px max(env(safe-area-inset-bottom), 30px) 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overscroll-behavior: contain;
      }
      .close-btn {
        position: absolute;
        top: max(env(safe-area-inset-top), 15px);
        right: 20px;
        font-size: 40px;
        color: var(--red);
        background: none;
        border: none;
        cursor: pointer;
        z-index: 301;
        font-weight: bold;
        line-height: 1;
      }
      .btn-help-open {
        background: transparent;
        border: 1px solid var(--gold);
        color: var(--gold);
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 10px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 5px;
        flex-shrink: 0;
        pointer-events: auto;
      }
      .btn-help-open:before {
        content: "?";
        display: inline-block;
        width: 16px;
        height: 16px;
        background: var(--gold);
        color: black;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 10px;
      }
      .help-container {
        width: 100%;
        max-width: 500px;
        margin-top: 40px;
      }
      .help-card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        width: 100%;
        text-align: left;
        margin-bottom: 20px;
      }
      .help-title {
        color: var(--gold);
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 10px;
        display: block;
        border-bottom: 1px solid rgba(255, 204, 0, 0.3);
        padding-bottom: 8px;
      }
      .help-text {
        color: #ccc;
        font-size: 14px;
        line-height: 1.6;
        margin-bottom: 15px;
      }
      .help-icon {
        margin-right: 5px;
      }
      .warning-text {
        color: var(--disease-red);
        font-weight: bold;
        font-size: 16px;
        text-align: center;
        padding: 10px;
        border: 1px solid var(--disease-red);
        background: rgba(255, 34, 34, 0.1);
        border-radius: 8px;
        margin-top: 20px;
      }
      .custom-modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        max-height: 80vh;
        overflow-y: auto;
        background: #000;
        border: 2px solid var(--gold);
        border-radius: 20px;
        padding: 20px;
        z-index: 200;
        text-align: center;
        box-shadow: 0 0 30px rgba(255, 204, 0, 0.2);
        touch-action: pan-y;
      }
      #endGameModal {
        border-color: var(--neon);
        box-shadow: 0 0 30px rgba(0, 255, 204, 0.4);
      }
      #upgradeModal {
        border-color: var(--neon);
      }
      .modal-input {
        width: 100%;
        padding: 15px;
        margin: 15px 0;
        background: #111;
        border: 1px solid #333;
        color: white;
        text-align: center;
        border-radius: 8px;
        font-size: 16px;
        min-height: 50px;
      }
      .percentage-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }
      .pct-btn {
        background: #222;
        border: 1px solid #444;
        color: var(--gold);
        padding: 12px 0;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        font-size: 14px;
        min-height: 44px;
      }
      .pct-btn:active {
        background: var(--gold);
        color: #000;
      }
      .modal-btn-row {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }
      .modal-btn {
        flex: 1;
        padding: 15px;
        border-radius: 10px;
        border: none;
        font-weight: 900;
        cursor: pointer;
        text-transform: uppercase;
        min-height: 50px;
      }
      .header {
        text-align: center;
        margin-top: env(safe-area-inset-top);
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
      }
      .game-title {
        color: var(--gold);
        font-size: 22px;
        font-weight: 900;
        letter-spacing: 1px;
        text-transform: uppercase;
        margin: 10px 0;
      }
/* --- TRANIUM REAKT√ñR (G√úVENLƒ∞ & MOBƒ∞L UYUMLU VERSƒ∞YON) --- */

/* 1. GENEL AYARLAR (T√ºm Cihazlar ƒ∞√ßin Efektler) */
.tranium-circle {
  position: relative !important;
  border-radius: 50% !important;
  border: 2px solid rgba(255, 204, 0, 0.8) !important;
  
  /* Derinlik ve Parlama Efekti */
  background: radial-gradient(circle at 30% 30%, rgba(255, 204, 0, 0.2), #000) !important;
  box-shadow: 0 0 20px rgba(255, 204, 0, 0.5), inset 0 0 20px rgba(255, 204, 0, 0.2) !important;
  
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  justify-content: center !important;
  
  /* Animasyon */
  animation: reactorPulse 3s infinite ease-in-out !important;
}

/* 2. D√∂nen Halka (Efekt) */
.tranium-circle::before {
  content: "";
  position: absolute;
  top: -6px; left: -6px; right: -6px; bottom: -6px;
  border-radius: 50%;
  border: 1px dashed rgba(255, 204, 0, 0.4);
  border-top-color: transparent;
  animation: spinSlow 10s linear infinite !important;
  pointer-events: none;
}

/* 3. PC VE B√úY√úK EKRANLAR ƒ∞√áƒ∞N BOYUTLAR */
.tranium-circle {
  width: 100px !important;
  height: 100px !important;
  margin: 15px auto !important;
}
.tranium-val {
  font-size: 28px !important;
  font-weight: 900 !important;
  color: #fff !important;
  text-shadow: 0 0 10px var(--gold) !important;
  margin: 0 !important;
  z-index: 2;
}
.tranium-lbl {
  font-size: 10px !important;
  font-weight: 800 !important;
  background: var(--gold) !important;
  color: #000 !important;
  padding: 2px 10px !important;
  border-radius: 8px !important;
  margin-top: -2px !important;
  box-shadow: 0 0 8px rgba(255, 204, 0, 0.8) !important;
  z-index: 2;
  letter-spacing: 1px;
}

/* 4. MOBƒ∞L Cƒ∞HAZLAR ƒ∞√áƒ∞N √ñZEL AYAR (Max Geni≈ülik 600px ise) */
@media (max-width: 600px) {
  .tranium-circle {
    width: 75px !important; /* Mobilde 100px yerine 75px olsun */
    height: 75px !important;
    margin: 5px auto !important;
  }
  
  .tranium-circle::before {
    top: -4px; left: -4px; right: -4px; bottom: -4px; /* Halkayƒ± daralt */
  }

  .tranium-val {
    font-size: 20px !important; /* Yazƒ±yƒ± k√º√ß√ºlt */
  }

  .tranium-lbl {
    font-size: 8px !important; /* Etiketi k√º√ß√ºlt */
    padding: 1px 6px !important;
    margin-top: 0 !important;
  }
}

/* --- ANƒ∞MASYONLAR --- */
@keyframes reactorPulse {
  0%, 100% { box-shadow: 0 0 15px rgba(255, 204, 0, 0.4), inset 0 0 10px rgba(255, 204, 0, 0.2); transform: scale(1); }
  50% { box-shadow: 0 0 25px rgba(255, 204, 0, 0.8), inset 0 0 20px rgba(255, 204, 0, 0.4); transform: scale(1.03); }
}
@keyframes spinSlow {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
      .resource-section {
        width: 100%;
        max-width: 380px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 0 10px;
        flex-shrink: 1;
      }
      .res-card {
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .res-name {
        font-size: 11px;
        color: var(--gold);
        font-weight: bold;
        display: block;
      }
      .res-amount {
        font-size: 20px;
        font-weight: 800;
        display: block;
        margin: 5px 0;
      }
      .res-info {
        font-size: 10px;
        color: var(--neon);
        opacity: 0.9;
      }
      .btn-refine {
        width: 100%;
        max-width: 380px;
        background: var(--gold);
        color: #000;
        border: none;
        padding: 18px;
        border-radius: 12px;
        font-weight: 900;
        cursor: pointer;
        text-transform: uppercase;
        box-shadow: 0 4px 0 #b89600;
        font-size: 14px;
        min-height: 60px;
        margin: 10px 0;
        flex-shrink: 0;
      }
      .btn-refine:disabled {
        background: #333;
        color: #666;
        box-shadow: none;
        transform: translateY(4px);
      }
      .btn-upgrade-menu {
        background: var(--neon);
        color: #000;
        box-shadow: 0 4px 0 #00b894;
        margin-top: 10px;
      }
      .factory-modal-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        width: 100%;
      }
      .fac-card {
        background: rgba(0, 255, 204, 0.03);
        border: 1px solid rgba(0, 255, 204, 0.3);
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        min-height: 120px;
      }
      .fac-header {
        font-size: 10px;
        font-weight: bold;
        color: var(--neon);
        text-align: center;
        margin-bottom: 8px;
      }
      .btn-upgrade {
        background: var(--neon);
        color: #000;
        border: none;
        padding: 12px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 10px;
        cursor: pointer;
        min-height: 44px;
        margin-top: auto;
      }
      .footer {
        width: 100%;
        max-width: 380px;
        text-align: center;
        padding: 15px 10px;
        margin-top: auto;
        margin-bottom: max(env(safe-area-inset-bottom), 20px);
        flex-shrink: 0;
      }
      .energy-info {
        font-size: 16px;
        font-weight: bold;
        color: var(--gold);
        margin-bottom: 15px;
        display: block;
      }
      .btn-start {
        width: 100%;
        background: var(--gold);
        color: #000;
        padding: 20px;
        border-radius: 40px;
        border: none;
        font-size: 20px;
        font-weight: 900;
        cursor: pointer;
        min-height: 70px;
        box-shadow: 0 6px 0 #b89600;
      }
      .reset-link {
        color: var(--neon);
        font-size: 12px;
        text-decoration: none;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid var(--neon);
        border-radius: 8px;
        display: block;
        width: 100%;
        max-width: 250px;
        font-weight: bold;
        margin: 10px 0;
        padding: 10px;
        min-height: 44px;
        flex-shrink: 0;
      }

      @keyframes introFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes loadingFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.7;
        }
        50% {
          opacity: 1;
        }
      }

      /* MEDIA QUERIES */
      @media (max-width: 600px) and (max-height: 850px) {
        #overlay {
          justify-content: space-evenly;
          padding: 10px;
          gap: 0;
          padding-bottom: max(env(safe-area-inset-bottom), 10px);
        }
        .header {
          margin-top: 0;
          margin-bottom: 0;
        }
        .game-title {
          font-size: 18px;
          margin: 2px 0;
        }
        .tranium-circle {
          width: 65px;
          height: 65px;
          margin: 5px auto;
          border-width: 2px;
        }
        .tranium-val {
          font-size: 20px;
        }
        .tranium-lbl {
          font-size: 8px;
        }
        .btn-help-open {
          padding: 4px 12px;
          font-size: 10px;
          margin-bottom: 2px;
          min-height: 25px;
        }
        .reset-link {
          padding: 5px;
          min-height: 30px;
          font-size: 10px;
          margin: 2px 0;
          max-width: 200px;
        }
        .resource-section {
          gap: 8px;
          margin: 2px 0;
        }
        .res-card {
          padding: 8px;
          min-height: 60px;
        }
        .res-name {
          font-size: 10px;
        }
        .res-amount {
          font-size: 16px;
          margin: 2px 0;
        }
        .res-info {
          font-size: 9px;
        }
        .btn-refine {
          padding: 10px;
          min-height: 45px;
          font-size: 12px;
          margin: 8px 0;
        }
        .footer {
          padding: 5px;
          margin-bottom: 5px;
        }
        .energy-info {
          font-size: 12px;
          margin-bottom: 5px;
        }
        .btn-start {
          padding: 10px;
          min-height: 50px;
          font-size: 16px;
        }
        #howToPlayScreen {
          justify-content: center;
          padding: 10px;
          overflow: hidden;
        }
        #howToPlayScreen.header {
          margin-top: 0;
          margin-bottom: 5px;
        }
        #howToPlayScreen.game-title {
          font-size: 16px;
          margin: 0;
        }
        #howToPlayScreen.close-btn {
          font-size: 30px;
          top: 10px;
          right: 15px;
          z-index: 302;
        }
        .help-container {
          margin-top: 5px;
          width: 100%;
        }
        .help-card {
          padding: 10px;
          display: flex;
          flex-direction: column;
          gap: 5px;
        }
        .warning-text {
          font-size: 11px;
          padding: 5px;
          margin-top: 0;
          margin-bottom: 5px;
        }
        .help-title {
          font-size: 11px;
          margin-bottom: 2px;
          padding-bottom: 2px;
          border-bottom-width: 1px;
        }
        .help-text {
          font-size: 10px;
          line-height: 1.2;
          margin-bottom: 4px;
        }
        .help-text:last-child {
          margin-bottom: 0;
        }
        #joystickContainer {
          width: 90px;
          height: 90px;
          left: 15px;
          bottom: 15px;
        }
        #joystickHandle {
          width: 45px;
          height: 45px;
        }
      }
    /* --- REF STATUS FEEDBACK (EKSƒ∞K OLAN KISIM) --- */
#refStatusOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  border-radius: 20px;
  z-index: 10001;
  display: none; /* Varsayƒ±lan gizli */
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.status-icon {
  font-size: 60px;
  margin-bottom: 10px;
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.status-msg {
  font-size: 14px;
  font-weight: 900;
  letter-spacing: 1px;
  text-transform: uppercase;
}

@keyframes popIn {
  0% { transform: scale(0); opacity: 0; }
  80% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); }
}
   /* --- WORKER UPGRADE G√ñRSELLERƒ∞ --- */
.miner-upgrade-img {
    width: 80px;  /* Oyun i√ßi boyuta yakƒ±n, b√ºy√ºk */
    height: 80px;
    object-fit: contain;
    margin: 5px auto;
    image-rendering: pixelated; /* Piksel art bozulmasƒ±n diye */
    filter: drop-shadow(0 0 8px rgba(0,0,0,0.6)); /* Hafif g√∂lge */
    display: block;
}
    /* --- FLOATING TEXT ANIMASYONU --- */
.floating-text {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: 900;
    text-shadow: 0 0 10px rgba(0,0,0,0.8);
    pointer-events: none; /* Tƒ±klamayƒ± engellemesin */
    z-index: 10002; /* Her ≈üeyin √ºst√ºnde */
    animation: floatUpFade 1.5s ease-out forwards;
}

@keyframes floatUpFade {
    0% { opacity: 0; transform: translate(-50%, -40%) scale(0.5); }
    10% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
}
    </style>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
  // Eƒüer Analytics kullanacaksan:
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5ozuYZ7YWoHz6qC4zXO-hDwVEnHCa-6g",
  authDomain: "tranium-6f126.firebaseapp.com",
  databaseURL: "https://tranium-6f126-default-rtdb.firebaseio.com",
  projectId: "tranium-6f126",
  storageBucket: "tranium-6f126.firebasestorage.app",
  messagingSenderId: "570304399178",
  appId: "1:570304399178:web:d83ce14dc3fc91b958e3b3",
  measurementId: "G-6Q23R774CL"
};

  // Firebase'i ba≈ülat
  const app = initializeApp(firebaseConfig);
  
  // Veritabanƒ±nƒ± (Firestore) ba≈ülat
  const db = getFirestore(app);
  
  // Analytics (varsa)
  const analytics = getAnalytics(app);

  // KRƒ∞Tƒ∞K NOKTA: Diƒüer scriptlerden eri≈üebilmek i√ßin window'a ata
  window.firebaseDB = db;
  window.firebaseFunctions = { doc, setDoc, getDoc, updateDoc };
  
  console.log("üî• Firebase ba≈üarƒ±yla y√ºklendi ve ba≈ülatƒ±ldƒ±!");
</script>
  </head>
   <body>
     <div id="transactionOverlay">
  <div class="tx-spinner"></div>
  <div class="tx-text">PROCESSING DATA...</div>
</div>
     <div id="desktop-blocker" style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:red; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
    <h1>ONLY FOR FARCASTER</h1>
    <p>This game can only be played through Farcaster</p>
</div>
    <div id="introOverlay">
      <div class="intro-container">
        <div class="disease-logo">DISEASES GAMES</div>
        <div class="presents-text">PRESENTS</div>
        <div class="game-title-intro">TRANIUM VERSE</div>
        <div class="game-subtitle">TRANIUM VERSE</div>
        
        <button id="enterBtn" onclick="userEnterGame()">START SIMULATION</button>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="loading-container">
        <div class="loading-logo">TRANIUM VERSE</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing Systems</div>
        <div class="loading-percentage">0%</div>
        <div class="loading-progress-container">
          <div class="loading-progress-bar"></div>
        </div>
        <div class="loading-tip">Tip: Collect miners to increase resource production.
Avoid infected enemies!</div>
      </div>
    </div>

    <div id="ui">
      <div id="resUI">‚öôÔ∏è: 0 |
üíé: 0</div>
      <div id="healthUI" style="color: #ff4444">‚ù§Ô∏è: 3</div>
      <div id="energyUI">‚ö°: 10/10</div>
    </div>

    <div id="joystickContainer">
      <div id="joystickBase"></div>
      <div id="joystickHandle"></div>
    </div>

    <div id="endGameModal" class="custom-modal">
      <h2 style="color: var(--neon); margin: 0">FINISH & SUBMIT</h2>
      <p style="font-size: 13px; margin: 15px 0; color: #ddd">
        Your current Tranium will be submitted as your score.
You can start again with energy.
      </p>
      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333; color: white" onclick="closeEndGameConfirmation()">
          CANCEL
        </button>
        <button class="modal-btn" style="background: var(--neon); color: black" onclick="triggerManualEndGame()">
          SUBMIT
        </button>
      </div>
    </div>

    <div id="upgradeModal" class="custom-modal">
  <h2 style="color: var(--neon); margin: 0 0 10px 0">WORKER UPGRADES</h2>
  <p style="font-size: 10px; color: #888; margin: 0 0 15px 0">üíé Payment: Base Network ETH</p>
  
  <div class="factory-modal-grid">
    <div class="fac-card">
      <span class="fac-header">METAL MINER</span>
      
      <img src="https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner1-removebg-preview-49BIGjfxcrYSez39WOvCLyIxeY56q2.webp?pMVT" class="miner-upgrade-img">
      
      <span id="metalFacLevel" style="font-size: 9px; text-align: center; margin-bottom: 3px">Lvl 1</span>
      <span id="metalBuildTime" style="font-size: 8px; text-align: center; margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
      <button id="upMetalFac" class="btn-upgrade" onclick="upgradeFactory('metal')">
        UPGRADE <span id="costMetalFac"></span>
      </button>
    </div>

    <div class="fac-card">
      <span class="fac-header">CRYSTAL MINER</span>
      
      <img src="https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner2-removebg-preview-d2bFviiOsn7cXyHcptbNJtKdHoMuvp.webp?1b6n" class="miner-upgrade-img">
      
      <span id="kristalFacLevel" style="font-size: 9px; text-align: center; margin-bottom: 3px">Lvl 1</span>
      <span id="kristalBuildTime" style="font-size: 8px; text-align: center; margin-bottom: 5px; color: #888">‚è±Ô∏è 2h</span>
      <button id="upKristalFac" class="btn-upgrade" onclick="upgradeFactory('kristal')">
        UPGRADE <span id="costKristalFac"></span>
      </button>
    </div>
  </div>

  <div class="modal-btn-row">
    <button class="modal-btn" style="background: #333; color: white" onclick="closeUpgradeModal()">CLOSE</button>
  </div>
</div>
<div id="refInputModal" class="custom-modal" style="z-index: 9999;">
  <h2 style="color: var(--neon); margin: 0 0 10px 0;">INVITE CODE</h2>
  <p style="font-size: 11px; color: #ccc; margin-bottom: 15px;">
    Enter a friend's code to get <span style="color:var(--gold); font-weight:bold;">+20 TRANIUM</span> instantly!
  </p>
  
  <input type="text" id="refCodeInput" class="modal-input" placeholder="Ex: A1B2C3D" maxlength="9" style="text-transform: uppercase; letter-spacing: 2px; font-weight: bold;">
  
  <div class="modal-btn-row">
    <button class="modal-btn" style="background: #333; color: #aaa; font-size:12px;" onclick="skipRefCode()">SKIP</button>
    <button class="modal-btn" style="background: var(--neon); color: black;" onclick="submitRefCode()">ENTER</button>
  </div>

  <div id="refStatusOverlay">
      <div id="statusIcon" class="status-icon"></div>
      <div id="statusText" class="status-msg"></div>
  </div>
  </div>
</div>
    <div id="swapModal" class="custom-modal">
      <h2 style="color: var(--gold);
margin: 0; font-size: 18px">TRANIUM REFINERY</h2>
      <p style="font-size: 11px; margin: 10px 0;
color: #aaa">Refine Metal & Crystal into Tranium (1:1)</p>

      <div class="percentage-row">
        <button class="pct-btn" onclick="setSwapPct(0.25)">25%</button>
        <button class="pct-btn" onclick="setSwapPct(0.50)">50%</button>
        <button class="pct-btn" onclick="setSwapPct(0.75)">75%</button>
        <button class="pct-btn" onclick="setSwapPct(1.00)">100%</button>
      </div>

      <input type="number" id="swapAmountInput" class="modal-input" placeholder="Enter amount..." min="1" />

      <div class="modal-btn-row">
        <button class="modal-btn" style="background: #333;
color: white" onclick="closeSwapModal()">BACK</button>
        <button class="modal-btn" style="background: var(--gold);
color: black" onclick="executeSwap()">REFINE</button>
      </div>
    </div>

    <div id="howToPlayScreen">
      <button class="close-btn" onclick="closeHowToPlay()">&times;</button>

      <div class="header">
        <h1 class="game-title">HOW TO PLAY</h1>
      </div>

      <div class="help-container">
        <div class="help-card">
          <div class="warning-text">‚ö†Ô∏è DON'T BUY ANY TRANIUM TOKENS:<br />NOT LAUNCHED</div>

          <span class="help-title">üéØ MISSION OBJECTIVE</span>
          <p class="help-text">
            Collect resources and refine Tranium to dominate the Verse. Survive against the infected swarm.
          </p>

          <span class="help-title">‚õèÔ∏è RESOURCES</span>
          <p class="help-text">
            <span class="help-icon">‚öôÔ∏è</span> <b>Metal & Crystal:</b> Produced automatically by miners. Find miners in
            the world to increase production.<br />
            <span class="help-icon">üü°</span> <b>Tranium:</b> The ultimate currency.
Use the "REFINE" button to convert
            Metal and Crystal into Tranium.
</p>

          <span class="help-title">üè≠ FACTORIES</span>
          <p class="help-text">
            Upgrade your Metal and Crystal factories to boost miner efficiency.
Higher levels mean faster production
            speeds per miner.
</p>

          <span class="help-title">‚ö†Ô∏è ENEMIES</span>
          <p class="help-text">
            Avoid the infected (Red Circles).
They will chase you. If they touch you 3 times, the mission fails.
</p>

          <span class="help-title">‚ö° ENERGY SYSTEM</span>
          <p class="help-text">
            Every mission costs 1 Energy.
Energy regenerates over time (1 per hour) even when you are offline.
</p>
        </div>
      </div>
    </div>

    <div id="overlay">
      <div class="header">
        <h1 class="game-title">TRANIUM VERSE</h1>
        <div class="tranium-circle">
          <span id="traniumCount" class="tranium-val">0</span>
          <span class="tranium-lbl">TRANIUM</span>
        </div>
        <button class="btn-help-open" onclick="openHowToPlay()">HOW TO PLAY</button>
      </div>

      <div class="resource-section">
        <div class="res-card">
          <span class="res-name">‚öôÔ∏è METAL</span>
          <span id="metalCount" class="res-amount">0</span>
          <span id="metalWorkers" class="res-info">0 Miners</span>
        </div>
        <div class="res-card">
          <span class="res-name">üíé CRYSTAL</span>
          <span id="kristalCount" class="res-amount">0</span>
          <span id="kristalWorkers" class="res-info">0 Miners</span>
        </div>
      </div>

      <button id="swapBtn" class="btn-refine" onclick="openSwapModal()">Refine Tranium (1:1)</button>

      <div style="height: 40px;"></div>

      <button class="btn-refine btn-upgrade-menu" onclick="openUpgradeModal()">üë∑ WORKER UPGRADES</button>
      <div id="myRefDisplayArea" style="text-align: center; margin-top: 15px; padding: 10px; border: 1px dashed rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(0,0,0,0.3);">
  <span style="font-size: 10px; color: #888; display: block; margin-bottom: 4px;">YOUR REFERRAL CODE</span>
  <span id="myRefCodeText" style="font-size: 16px; font-weight: 900; color: var(--gold); letter-spacing: 2px; cursor: pointer;" onclick="copyRefCode()">LOADING...</span>
  <div style="font-size: 9px; color: var(--neon); margin-top: 3px;">Share to earn +20 Tranium per friend!</div>
</div>

      <div class="footer">
        <span id="energyStatus" class="energy-info">‚ö° ENERGY: 10/10</span>
        <button class="btn-start" onclick="attemptStart()">START MISSION</button>
      </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const WORLD_SIZE = 2500;

      let metal = 0,
        kristal = 0,
        tranium = 0,
        metalWorkers = 0,
        kristalWorkers = 0;
      let metalFacLvl = 1,
        kristalFacLvl = 1,
        energy = 10,
        lastTime = Date.now();
      const BASE_WORKER_SPEED = 0.0001;
      let health = 3,
        isStarted = false,
        isTouching = false;
      let walkCycle = 0,
        camera = { x: 0, y: 0 };
      let player = {
        x: WORLD_SIZE / 2,
        y: WORLD_SIZE / 2,
        speed: 7.5,
        targetX: WORLD_SIZE / 2,
        targetY: WORLD_SIZE / 2,
        flipX: false,
        isMoving: false,
      };
      let lastUpdate = Date.now();
      let workers = [],
        enemies = [];
      let joystickActive = false;
      let joystickCenterX = 0;
      let joystickCenterY = 0;
      let joystickHandleX = 0;
      let joystickHandleY = 0;
      let joystickDirection = { x: 0, y: 0 };
      const JOYSTICK_RADIUS = 60;
      const JOYSTICK_HANDLE_RADIUS = 30;
      let nextEnergyTime = 0;
      let energyTimer = null;
      let energyRegenerationStartTime = 0;

      let totalAssets = 0;
      let loadedAssets = 0;
      let loadingInterval = null;

      let metalFacUpgradeEndTime = 0;
      let kristalFacUpgradeEndTime = 0;

// Global deƒüi≈ükenler
let currentUserID = "test_user_001"; 
let isUserIdentified = false; // Kimlik tespiti yapƒ±ldƒ± mƒ± kontrol√º

// Bu fonksiyonu SADECE bir kere, en ba≈üta √ßalƒ±≈ütƒ±racaƒüƒ±z.
async function identifyUser() {
    if (isUserIdentified) return currentUserID; // Zaten bulduysak tekrar bakma

    try {
        if (window.farcasterSDK) {
            const context = await window.farcasterSDK.context;
            if (context && context.user && context.user.fid) {
                currentUserID = "user_" + context.user.fid;
                console.log("üë§ Farcaster Kullanƒ±cƒ±sƒ± Tanƒ±mlandƒ±:", currentUserID);
            }
        }
    } catch (e) {
        console.warn("Kimlik alƒ±namadƒ±, test modunda devam.");
    }
    
    isUserIdentified = true;
    return currentUserID;
}

      const imgBG = new Image();
      imgBG.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/bg-H8I42XFyjR45PCLXsG4fQp7B323kKw.webp?37vf";
      const imgDayi = new Image();
      imgDayi.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/dayi-removebg-preview-9XEJ3aO8Iwnas0qrRC6kST14YUZeab.webp?yQ69";
      const imgMiner1 = new Image();
      imgMiner1.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner1-removebg-preview-49BIGjfxcrYSez39WOvCLyIxeY56q2.webp?pMVT";
      const imgMiner2 = new Image();
      imgMiner2.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/miner2-removebg-preview-d2bFviiOsn7cXyHcptbNJtKdHoMuvp.webp?1b6n";
      const imgInfected = new Image();
      imgInfected.src =
        "https://remix.gg/blob/87995662-1e06-43e7-9408-0e20e9de2c7e/infect-removebg-preview-5HhmhH4V5DqNbYNXhiFg3o9Z0RkEIj.webp?uN63";

      function showBlockingLoader() {
    document.getElementById("transactionOverlay").style.display = "flex";
}

      function hideBlockingLoader() {
    document.getElementById("transactionOverlay").style.display = "none";
}
      
      function openHowToPlay() {
        document.getElementById("howToPlayScreen").style.display = "flex";
      }
      function closeHowToPlay() {
        document.getElementById("howToPlayScreen").style.display = "none";
      }

      function openUpgradeModal() {
        document.getElementById("upgradeModal").style.display = "block";
      }
      function closeUpgradeModal() {
        document.getElementById("upgradeModal").style.display = "none";
      }

      function openEndGameConfirmation() {
        document.getElementById("endGameModal").style.display = "block";
      }
      function closeEndGameConfirmation() {
        document.getElementById("endGameModal").style.display = "none";
      }
      function triggerManualEndGame() {
        closeEndGameConfirmation();
        if (window.isMiniApp && window.farcasterSDK) {
          console.log("Game Over! Score: " + Math.floor(tranium));
          alert("Game Over! Your score: " + Math.floor(tranium) + " TRANIUM");
          if (window.farcasterSDK.actions && window.farcasterSDK.actions.close) {
            window.farcasterSDK.actions.close();
          }
        } else {
          alert("Game Over Triggered! Score sent: " + Math.floor(tranium));
          location.reload();
        }
      }

      function openSwapModal() {
        document.getElementById("swapModal").style.display = "block";
        document.getElementById("swapAmountInput").value = "";
      }
      function closeSwapModal() {
        document.getElementById("swapModal").style.display = "none";
      }
      function setSwapPct(pct) {
        let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));
        document.getElementById("swapAmountInput").value = Math.floor(maxRefine * pct);
      }
      async function executeSwap() {
    let inputVal = document.getElementById("swapAmountInput").value;
    if (!inputVal || inputVal.trim() === "") {
         alert("L√ºtfen ge√ßerli bir miktar girin.");
         return;
    }
    
    let amount = parseInt(inputVal);
    let maxRefine = Math.min(Math.floor(metal), Math.floor(kristal));

    if (!isNaN(amount) && amount > 0 && amount <= maxRefine) {
      // 1. √ñNCE PERDEYƒ∞ ƒ∞NDƒ∞R
      closeSwapModal(); // K√º√ß√ºk pencereyi kapat
      showBlockingLoader(); // B√ºy√ºk y√ºkleniyor ekranƒ±nƒ± a√ß

      // 2. VERƒ∞LERƒ∞ G√úNCELLE
      tranium += amount;
      metal -= amount;
      kristal -= amount;

      // 3. VERƒ∞TABANINA KESƒ∞N KAYIT YAPILMASINI BEKLE
      await saveData(true); 
      // 4. EKRANI G√úNCELLE VE PERDEYƒ∞ KALDIR
      updateUI();
      hideBlockingLoader();
      showFloatingText(`+${amount} TRANIUM`, "#ffcc00");
    } else {
      alert("Ge√ßersiz miktar veya yetersiz kaynak!");
    }
}

    
      async function setupRealtimeListener() {
    console.log("üì° Realtime Baƒülantƒ± Kuruluyor...");
    
    // BURASI KRƒ∞Tƒ∞K: √ñnce kimliƒüin kesinle≈ümesini bekle
    await identifyUser(); 

    if (!window.firebaseDB || !window.firebaseFunctions) {
        initHub();
        return;
    }

    const { doc, onSnapshot, setDoc } = window.firebaseFunctions; // setDoc'u da ekledim
    const db = window.firebaseDB;
        
    try {
        const docRef = doc(db, "players", currentUserID);

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // --- STANDART VERƒ∞LERƒ∞ √áEK ---
                let savedMetal = parseFloat(data.metal) || 0;
                let savedKristal = parseFloat(data.kristal) || 0;
                let savedLastTime = parseInt(data.lastTime) || Date.now();
                tranium = parseInt(data.tranium) || 0;
                metalWorkers = parseInt(data.metalWorkers) || 0;
                kristalWorkers = parseInt(data.kristalWorkers) || 0;
                metalFacLvl = parseInt(data.metalFacLvl) || 1;
                kristalFacLvl = parseInt(data.kristalFacLvl) || 1;
                
                const serverEnergy = (data.energy !== undefined) ? parseInt(data.energy) : 10;
                if (Math.abs(serverEnergy - energy) > 0) energy = serverEnergy;
                nextEnergyTime = parseInt(data.nextEnergyTime) || 0;
                energyRegenerationStartTime = parseInt(data.energyRegenerationStartTime) || 0;
                metalFacUpgradeEndTime = parseInt(data.metalFacUpgradeEndTime) || 0;
                kristalFacUpgradeEndTime = parseInt(data.kristalFacUpgradeEndTime) || 0;

                // --- OFFLINE KAZAN√á ---
                if (!window.hasInitialLoadCompleted) {
                    const now = Date.now();
                    const secondsPassed = (now - savedLastTime) / 1000;
                    if (secondsPassed > 10) {
                        const metalMultiplier = Math.pow(2, metalFacLvl - 1);
                        const kristalMultiplier = Math.pow(2, kristalFacLvl - 1);
                        const offlineMetalGain = secondsPassed * (metalWorkers * BASE_WORKER_SPEED * metalMultiplier);
                        const offlineKristalGain = secondsPassed * (kristalWorkers * BASE_WORKER_SPEED * kristalMultiplier);
                        if (offlineMetalGain > 0 || offlineKristalGain > 0) {
                            savedMetal += offlineMetalGain;
                            savedKristal += offlineKristalGain;
                            alert(`WELCOME!\n\nOFFLINE EARNINGS:\n‚öôÔ∏è +${Math.floor(offlineMetalGain)} Metal\nüíé +${Math.floor(offlineKristalGain)} Kristal`);
                        }
                    }
                }
                metal = savedMetal;
                kristal = savedKristal;

                // --- REF Sƒ∞STEMƒ∞ D√úZELTƒ∞LMƒ∞≈û MANTIK ---
                const refActionTaken = data.refActionTaken || false;
                let myRefCode = data.myRefCode;
                const refTextEl = document.getElementById("myRefCodeText");

                if (refTextEl) {
                    if (myRefCode) {
                        // Zaten kodu var
                        refTextEl.innerText = myRefCode;
                        window.currentUserRefCode = myRefCode;
                    } else if (refActionTaken) {
                        // ƒ∞≈ülem yapmƒ±≈ü (SKIP demi≈ü) ama kodu yok -> ≈ûƒ∞MDƒ∞ OLU≈ûTUR
                        myRefCode = generateRefCode();
                        refTextEl.innerText = myRefCode;
                        window.currentUserRefCode = myRefCode;
                    } else {
                        // Hen√ºz i≈ülem yapmamƒ±≈ü -> BEKLE
                        refTextEl.innerText = "WAITING...";
                    }
                }

                // Pop-up Kontrol√º: Daha √∂nce i≈ülem yapmadƒ±ysa a√ß
                if (!refActionTaken && !window.refModalShown) {
                    setTimeout(() => {
                        document.getElementById("refInputModal").style.display = "block";
                    }, 2500);
                    window.refModalShown = true;
                }

                updateUI();
                if (!window.hasInitialLoadCompleted) {
                    updateOfflineEnergyRegeneration();
                    initHub();
                    window.hasInitialLoadCompleted = true;
                }

            } else {
                // --- YENƒ∞ KULLANICI ---
                console.log("üÜï Yeni kullanƒ±cƒ±.");
                energy = 10;
                
                // Yeni kullanƒ±cƒ±ya hemen kod olu≈üturmuyoruz, √∂nce sorsun.
                if (!window.refModalShown) {
                    setTimeout(() => {
                        document.getElementById("refInputModal").style.display = "block";
                    }, 2500);
                    window.refModalShown = true;
                }

                if (!window.hasInitialLoadCompleted) {
                    initHub();
                    window.hasInitialLoadCompleted = true;
                }
                saveData(true);
            }
        }, (error) => console.error(error));
    } catch (error) {
        console.error(error);
        initHub();
    }
}

      function startIntro() {
        const introOverlay = document.getElementById("introOverlay");
        introOverlay.style.display = "flex";
        
        // Show the Enter button after a short delay
        setTimeout(() => {
           const btn = document.getElementById("enterBtn");
           if(btn) btn.style.display = "block";
        }, 800);
      }

// √ñNCEKƒ∞ HALI YERƒ∞NE BU KODU KULLAN

async function enableNotifications() {
    console.log("üîî Bildirim sistemi ba≈ülatƒ±lƒ±yor...");

    // 1. SDK Yoksa √áƒ±k (PC vs.)
    if (!window.farcasterSDK || !window.farcasterSDK.actions) return;

    try {
        // 2. CONTEXT AL (Kimlik Tespiti)
        const context = await window.farcasterSDK.context;
        
        // Eƒüer kimlik geldiyse Global ID'yi g√ºncelle
        if (context && context.user && context.user.fid) {
            currentUserID = "user_" + context.user.fid;
            console.log("üë§ Kimlik Tespit Edildi:", currentUserID);
        }

        // 3. ƒ∞Zƒ∞N ƒ∞STE (Pencere A√ßƒ±lƒ±r)
        const result = await window.farcasterSDK.actions.addFrame();

        // 4. TOKEN GELDƒ∞ Mƒ∞?
        if (result && result.notificationDetails) {
            const token = result.notificationDetails.token;
            const url = result.notificationDetails.url;

            console.log("‚úÖ Token Alƒ±ndƒ±:", token);

            // Veritabanƒ± baƒülantƒ±larƒ±nƒ± hazƒ±rla
            const db = window.firebaseDB;
            const { doc, setDoc } = window.firebaseFunctions;

            // 5. DATABASE'E YAZ (KRƒ∞Tƒ∞K KISIM)
            // merge: true -> Var olan veriyi (Referans kodu, Metal, Kristal) KORUR.
            // Sadece notificationToken alanƒ±nƒ± ekler/g√ºnceller.
            await setDoc(doc(db, "players", currentUserID), {
                notificationToken: token,
                notificationUrl: url,
                lastTokenUpdate: Date.now()
            }, { merge: true });

            console.log("üíæ Token DB'ye i≈ülendi.");
        } 

    } catch (error) {
        console.error("‚ùå Bildirim Hatasƒ±:", error);
    }
}



window.testNotifications = async function() {
    console.log("üß™ Manuel bildirim testi ba≈ülatƒ±lƒ±yor...");
    await enableNotifications();
    console.log("‚úÖ Test tamamlandƒ±, Console'u kontrol et");
};
      
      function userEnterGame() {
    console.log("üéÆ Oyuna giri≈ü tetiklendi.");

   
    const introOverlay = document.getElementById("introOverlay");
    if(introOverlay) introOverlay.style.display = "none";
    
   
    startLoading();

    // 3. Bildirimleri ARKAPLANDA etkinle≈ütir (Oyunu bekletmez)
    enableNotifications().then(() => {
        console.log("üîî Bildirim s√ºreci tamam.");
    });
}

      function startLoading() {
        const loadingOverlay = document.getElementById("loadingOverlay");
        const progressBar = document.querySelector(".loading-progress-bar");
        const percentageText = document.querySelector(".loading-percentage");
        const loadingText = document.querySelector(".loading-text");

        loadingOverlay.style.display = "flex";

        let progress = 0;
        const loadingMessages = ["Initializing...", "Connecting to Verse...", "Loading Assets...", "Syncing Energy..."];
        let messageIndex = 0;

        loadingInterval = setInterval(() => {
          if (progress < 100) {
            progress += Math.random() * 10 + 5;
            if (progress > 100) progress = 100;

            if (progress % 15 < 5 && messageIndex < loadingMessages.length - 1) {
              messageIndex = Math.min(Math.floor(progress / 15), loadingMessages.length - 1);
              loadingText.textContent = loadingMessages[messageIndex];
            }

            progressBar.style.width = progress + "%";
            percentageText.textContent = Math.floor(progress) + "%";
          }
        }, 150);
        loadAssets();
      }

      function loadAssets() {
        totalAssets = 5;
        const images = [imgBG, imgDayi, imgMiner1, imgMiner2, imgInfected];

        images.forEach((img) => {
          if (img.complete) {
            assetLoaded();
          } else {
            img.onload = assetLoaded;
            img.onerror = assetLoaded;
          }
        });
      }

      function assetLoaded() {
        loadedAssets++;
        if (loadedAssets >= totalAssets) {
          setTimeout(completeLoading, 500);
        }
      }

      function completeLoading() {
    clearInterval(loadingInterval);
    const progressBar = document.querySelector(".loading-progress-bar");
    const percentageText = document.querySelector(".loading-percentage");
    const loadingText = document.querySelector(".loading-text");

    progressBar.style.width = "100%";
    percentageText.textContent = "100%";
    loadingText.textContent = "Connecting Database..."; 

    setTimeout(() => {
        document.getElementById("loadingOverlay").style.display = "none";
        document.getElementById("overlay").style.display = "flex";
        setupRealtimeListener();
    }, 1000);
}
      function updateOfflineEnergyRegeneration() {
        const now = Date.now();
        if (energy < 10 && energyRegenerationStartTime > 0) {
          const timePassed = now - energyRegenerationStartTime;
          const energyToAdd = Math.floor(timePassed / 3600000);

          if (energyToAdd > 0) {
            const newEnergy = Math.min(10, energy + energyToAdd);
            const addedEnergy = newEnergy - energy;

            if (addedEnergy > 0) {
              energy = newEnergy;
              energyRegenerationStartTime = now - (timePassed % 3600000);
              if (energy >= 10) {
                energyRegenerationStartTime = 0;
                nextEnergyTime = 0;
              } else {
                nextEnergyTime = energyRegenerationStartTime + 3600000;
              }

              saveData();
              updateUI();
            }
          } else if (nextEnergyTime > 0 && nextEnergyTime <= now) {
            if (energy < 10) {
              energy++;
              updateEnergyTimers();
              saveData();
              updateUI();
            }
          }
        } else if (energy < 10 && energyRegenerationStartTime === 0) {
          updateEnergyTimers();
        }
      }

      function updateEnergyTimers() {
        const now = Date.now();
        if (energy < 10) {
          if (energyRegenerationStartTime === 0) {
            energyRegenerationStartTime = now;
          }

          const timeSinceStart = now - energyRegenerationStartTime;
          const energyGained = Math.floor(timeSinceStart / 3600000);
          const nextEnergyIn = 3600000 - (timeSinceStart % 3600000);
          nextEnergyTime = now + nextEnergyIn;
          if (energy >= 10) {
            energyRegenerationStartTime = 0;
            nextEnergyTime = 0;
          }
        } else {
          energyRegenerationStartTime = 0;
          nextEnergyTime = 0;
        }

        saveData();
      }

      function updateEnergyCountdown() {
        const energyStatus = document.getElementById("energyStatus");
        const energyUI = document.getElementById("energyUI");
        if (!energyStatus || !energyUI) return;

        const now = Date.now();
        if (energy >= 10) {
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (FULL)`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
          energyRegenerationStartTime = 0;
          nextEnergyTime = 0;
          return;
        }

        if (energyRegenerationStartTime === 0) {
          updateEnergyTimers();
        }

        if (nextEnergyTime > 0 && now >= nextEnergyTime) {
          if (energy < 10) {
            energy++;
            updateEnergyTimers();
            saveData();
            updateUI();
          }
        }

        if (nextEnergyTime > now) {
          const timeLeft = nextEnergyTime - now;
          const minutesLeft = Math.floor(timeLeft / 60000);
          const secondsLeft = Math.floor((timeLeft % 60000) / 1000);

          const formattedMinutes = minutesLeft.toString().padStart(2, "0");
          const formattedSeconds = secondsLeft.toString().padStart(2, "0");

          const currentEnergyBeingRegenerated = energy + 1;
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Next ${currentEnergyBeingRegenerated}/10 in ${formattedMinutes}:${formattedSeconds})`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
        } else {
          energyStatus.innerHTML = `‚ö° ENERGY: ${energy}/10 (Next energy ready!)`;
          energyUI.innerHTML = `‚ö°: ${energy}/10`;
        }
      }

      function startEnergyCountdown() {
        if (energyTimer) {
          clearInterval(energyTimer);
        }

        updateOfflineEnergyRegeneration();
        updateEnergyCountdown();
        energyTimer = setInterval(updateEnergyCountdown, 1000);
      }

      function checkUpgradeProgress() {
        const now = Date.now();
        if (metalFacUpgradeEndTime > 0 && now >= metalFacUpgradeEndTime) {
          metalFacLvl++;
          metalFacUpgradeEndTime = 0;
          updateUI();
          saveData();
        }

        if (kristalFacUpgradeEndTime > 0 && now >= kristalFacUpgradeEndTime) {
          kristalFacLvl++;
          kristalFacUpgradeEndTime = 0;
          updateUI();
          saveData();
        }
      }

      const PAYMENT_ADDRESS = "0x3cCAF6612D0e134c14aa148f7F668a717DA645Fe";
      const BASE_ETH_COST = 0.0005;
      const BASE_UPGRADE_TIME = 2 * 60 * 60 * 1000;
      const BASE_CHAIN_ID = 8453;
      function getUpgradeCost(level) {
        return BASE_ETH_COST * Math.pow(2, level - 1);
      }

      function getUpgradeTime(level) {
        return BASE_UPGRADE_TIME * Math.pow(2, level - 1);
      }

      function formatTimeHours(ms) {
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        return `${hours}h ${minutes}m`;
      }

const PROJECT_ID = '2c7a5c244856e6edb4c52e0d4e61fadb'; 

let appKitModal = null;
let appKitAdapter = null;


async function initWalletSystem() {
    if (!window.AppKitLib) {
        console.log("‚ö†Ô∏è AppKit k√ºt√ºphanesi hen√ºz hazƒ±r deƒüil, bekleniyor...");
        setTimeout(initWalletSystem, 1000);
        return;
    }

    if (appKitModal) return;

    try {
        const { createAppKit, EthersAdapter, networks } = window.AppKitLib;

        const metadata = {
            name: 'Tranium Verse',
            description: 'Resource Mining Game',
            url: 'https://tranium-xi.vercel.app', 
            icons: ['https://tranium-xi.vercel.app/preview.jpg']
        };

        appKitModal = createAppKit({
            adapters: [new EthersAdapter()],
            networks,
            metadata,
            projectId: PROJECT_ID,
            features: {
                analytics: true 
            }
        });
        console.log("‚úÖ PC C√ºzdan Sistemi (AppKit) Hazƒ±r");
    } catch (e) {
        console.error("AppKit Ba≈ülatma Hatasƒ±:", e);
    }
}

document.addEventListener('DOMContentLoaded', initWalletSystem);
window.addEventListener('load', initWalletSystem);


async function sendETHPayment(amountETH) {
    console.log("üöÄ √ñdeme s√ºreci ba≈ülatƒ±lƒ±yor...");
    const PAYMENT_ADDRESS = "0x3cCAF6612D0e134c14aa148f7F668a717DA645Fe";

    try {
        let signer;
        let provider;

        if (window.farcasterSDK && window.farcasterSDK.wallet && window.farcasterSDK.wallet.ethProvider) {
            console.log("üì± Mobil Ortam: Farcaster Provider");
            const ethProvider = window.farcasterSDK.wallet.ethProvider;
            provider = new ethers.BrowserProvider(ethProvider);
            
            await provider.send("eth_requestAccounts", []);
            
            const network = await provider.getNetwork();
            if (Number(network.chainId) !== 8453) {
                 try {
                    await ethProvider.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }], 
                    });
                } catch (e) {
                    alert("L√ºtfen c√ºzdan aƒüƒ±nƒ±zƒ± Base Network yapƒ±n.");
                    return false;
                }
            }
            signer = await provider.getSigner();
        } 
        
        else {
            console.log("üíª PC Ortamƒ±: AppKit");
            
            if (!window.AppKitLib) {
                alert("Sistem hazƒ±rlanƒ±yor, l√ºtfen 3 saniye sonra tekrar deneyin.");
                initWalletSystem(); 
                return false;
            }

            if (!appKitModal) {
                await initWalletSystem();
                if(!appKitModal) {
                    alert("Baƒülantƒ± mod√ºl√º y√ºklenemedi. Sayfayƒ± yenileyip tekrar deneyin.");
                    return false;
                }
            }

            if (!appKitModal.getIsConnected()) {
                await appKitModal.open();
                return new Promise((resolve) => {
                    const checkInterval = setInterval(async () => {
                        if (appKitModal.getIsConnected()) {
                            clearInterval(checkInterval);
                            setTimeout(async () => {
                                resolve(await proceedWithPayment(amountETH));
                            }, 1000);
                        }
                    }, 1000);
                });
            }
            
            const walletProvider = appKitModal.getProvider();
            if (!walletProvider) {
                alert("C√ºzdan saƒülayƒ±cƒ±sƒ± bulunamadƒ±. L√ºtfen tekrar baƒülayƒ±n.");
                return false;
            }
            provider = new ethers.BrowserProvider(walletProvider);
            signer = await provider.getSigner();
        }

        return await executeTransaction(signer, amountETH, PAYMENT_ADDRESS);

    } catch (error) {
        console.error("√ñdeme Ba≈ülatma Hatasƒ±:", error);
        alert("Hata: " + (error.message || "Bilinmeyen hata"));
        return false;
    }
}

async function proceedWithPayment(amountETH) {
    return await sendETHPayment(amountETH);
}

async function executeTransaction(signer, amountETH, toAddress) {
    try {
        const amountWei = ethers.parseEther(amountETH.toString());
        console.log("üí∏ ƒ∞≈ülem g√∂nderiliyor... Miktar:", amountETH);

        const tx = await signer.sendTransaction({
            to: toAddress,
            value: amountWei,
            gasLimit: 21000 //
        });

        console.log("‚úÖ TX Hash:", tx.hash);
        alert("ƒ∞≈ülem Ba≈üarƒ±lƒ±! Onay bekleniyor...");
        return true;

    } catch (error) {
        console.error("TX Hatasƒ±:", error);
        
        let msg = error.message || "";
        
        if (msg.includes("insufficient funds") || error.code === "INSUFFICIENT_FUNDS") {
            alert("YETERSƒ∞Z BAKƒ∞YE: C√ºzdanƒ±nƒ±zda i≈ülem √ºcreti (Gas) ve √∂deme i√ßin yeterli ETH yok.");
        } else if (msg.includes("rejected") || error.code === 4001) {
            alert("ƒ∞≈ülemi reddettiniz.");
        } else if (msg.includes("estimateGas") || msg.includes("missing revert data")) {
            // Gas limit eklememize raƒümen bu hatayƒ± alƒ±yorsa, kesinlikle bakiye yetersizdir.
            alert("ƒ∞≈ûLEM BA≈ûARISIZ: L√ºtfen Base aƒüƒ±nda ETH bakiyenizi kontrol edin.");
        } else {
            alert("√ñdeme Hatasƒ±: " + msg.slice(0, 50) + "...");
        }
        return false;
    }
}
      async function upgradeFactory(type) {
        let currentLevel;
        let btnId; 

        if (type === "metal") {
          if (metalFacUpgradeEndTime > Date.now()) {
            alert("≈ûu an zaten geli≈ütirme yapƒ±lƒ±yor!");
            return;
          }
          currentLevel = metalFacLvl;
          btnId = "upMetalFac";
        } else if (type === "kristal") {
          if (kristalFacUpgradeEndTime > Date.now()) {
            alert("≈ûu an zaten geli≈ütirme yapƒ±lƒ±yor!");
            return;
          }
          currentLevel = kristalFacLvl;
          btnId = "upKristalFac";
        }

        const ethCost = getUpgradeCost(currentLevel);
        const upgradeTime = getUpgradeTime(currentLevel);
        
        const btn = document.getElementById(btnId);
        if (!btn) return;

        const originalText = btn.innerHTML;
        btn.innerHTML = "‚ö° C√úZDAN..."; 
        btn.disabled = true; 

        const paymentSuccess = await sendETHPayment(ethCost);
        
        if (!paymentSuccess) {
          btn.innerHTML = originalText;
          btn.disabled = false;
          return;
        }

        showBlockingLoader();

        if (type === "metal") {
          metalFacUpgradeEndTime = Date.now() + upgradeTime;
        } else if (type === "kristal") {
          kristalFacUpgradeEndTime = Date.now() + upgradeTime;
        }

        await saveData(true); 

        updateUI();
        hideBlockingLoader();
        alert("‚úÖ ƒ∞≈ülem G√∂nderildi! ƒ∞n≈üaat ba≈ülƒ±yor.");
      }
      function formatTime(ms) {
        if (ms <= 0) return "00:00";
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        return `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      }

      window.initHub = function() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.imageRendering = "pixelated";

        const now = Date.now();
        const secondsPassed = Math.floor((now - lastTime) / 1000);
        processMining(secondsPassed);
        checkUpgradeProgress();
        updateUI();
        startEnergyCountdown();
        for (let i = 0; i < 50; i++) spawnWorker();
        for (let i = 0; i < 15; i++) spawnEnemy();
        requestAnimationFrame(gameLoop);
        setInterval(saveData, 3000);

        setInterval(checkUpgradeProgress, 1000);
        initJoystick();
        window.initHub = function() {
        setInterval(checkUpgradeProgress, 1000);
        initJoystick();

          const updateInteraction = () => { lastInteractionTime = Date.now(); };
       }
      }
   function initJoystick() {
        const joystickContainer = document.getElementById("joystickContainer");
        const rect = joystickContainer.getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
        joystickCenterY = rect.top + rect.height / 2;
        joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;

        joystickContainer.addEventListener("touchstart", handleJoystickStart, { passive: false });
        joystickContainer.addEventListener("touchmove", handleJoystickMove, { passive: false });
        joystickContainer.addEventListener("touchend", handleJoystickEnd, { passive: false });

        joystickContainer.addEventListener("mousedown", handleJoystickStart);
        document.addEventListener("mousemove", handleJoystickMove);
        document.addEventListener("mouseup", handleJoystickEnd);
      }
      
        const forceSave = () => {
            if (Date.now() - lastInteractionTime < 60000) {
                saveData(); 
                // Not: save i≈ülemi asenkron olduƒüu i√ßin kapanƒ±rken %100 garanti edilemez 
                // ama ≈üansƒ±mƒ±zƒ± √ßok arttƒ±rƒ±r.
            }
        };

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                console.log("üôà Uygulama gizlendi - Acil kayƒ±t alƒ±nƒ±yor...");
                forceSave();
            }
        });

        window.addEventListener('beforeunload', () => {
            console.log("‚ùå Sekme kapanƒ±yor - Acil kayƒ±t...");
            forceSave();
        });

      function handleJoystickStart(e) {
        e.preventDefault();
        joystickActive = true;
        const joystickContainer = document.getElementById("joystickContainer");
        const rect = joystickContainer.getBoundingClientRect();
        joystickCenterX = rect.left + rect.width / 2;
        joystickCenterY = rect.top + rect.height / 2;

        updateJoystickPosition(e);
      }

      function handleJoystickMove(e) {
        if (!joystickActive) return;
        e.preventDefault();
        updateJoystickPosition(e);
      }

      function handleJoystickEnd(e) {
        if (!joystickActive) return;
        e.preventDefault();
        joystickActive = false;

        joystickHandleX = joystickCenterX;
        joystickHandleY = joystickCenterY;
        joystickDirection = { x: 0, y: 0 };

        updateJoystickVisual();
        player.isMoving = false;
      }

      function updateJoystickPosition(e) {
        let clientX, clientY;
        if (e.type.includes("touch")) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }

        const dx = clientX - joystickCenterX;
        const dy = clientY - joystickCenterY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        const limitedDistance = Math.min(distance, JOYSTICK_RADIUS);
        const angle = Math.atan2(dy, dx);
        joystickHandleX = joystickCenterX + Math.cos(angle) * limitedDistance;
        joystickHandleY = joystickCenterY + Math.sin(angle) * limitedDistance;

        joystickDirection.x = limitedDistance > 0 ? dx / distance : 0;
        joystickDirection.y = limitedDistance > 0 ? dy / distance : 0;

        updateJoystickVisual();
        player.isMoving = true;
      }

      function updateJoystickVisual() {
        const joystickHandle = document.getElementById("joystickHandle");
        if (joystickHandle) {
          const joystickContainer = document.getElementById("joystickContainer");
          const rect = joystickContainer.getBoundingClientRect();
          const x = joystickHandleX - rect.left - JOYSTICK_HANDLE_RADIUS;
          const y = joystickHandleY - rect.top - JOYSTICK_HANDLE_RADIUS;

          joystickHandle.style.transform = `translate(${x}px, ${y}px)`;
          if (joystickActive) {
            joystickHandle.style.background = "rgba(255, 204, 0, 1)";
            joystickHandle.style.boxShadow = "0 0 20px rgba(255, 204, 0, 0.8)";
          } else {
            joystickHandle.style.background = "rgba(255, 204, 0, 0.9)";
            joystickHandle.style.boxShadow = "0 0 15px rgba(255, 204, 0, 0.5)";
          }
        }
      }

      function updateUI() {
        // Yardƒ±mcƒ±lar
        const setText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        // YENƒ∞: HTML yazabilmek i√ßin bu yardƒ±mcƒ±yƒ± ekledik
        const setHTML = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };
        const setDisabled = (id, value) => { const el = document.getElementById(id); if (el) el.disabled = value; };

        // Temel Deƒüerler
        setText("traniumCount", tranium);
        setText("metalCount", Math.floor(metal));
        setText("kristalCount", Math.floor(kristal));
        
        // --- BURASI G√úNCELLENDƒ∞: Daha ≈üƒ±k g√∂r√ºn√ºm ---
        const metalMultiplier = Math.pow(2, metalFacLvl - 1);
        const kristalMultiplier = Math.pow(2, kristalFacLvl - 1);
        
        const metalRate = (metalWorkers * BASE_WORKER_SPEED * metalMultiplier).toFixed(4);
        const kristalRate = (kristalWorkers * BASE_WORKER_SPEED * kristalMultiplier).toFixed(4);

        // Metal ƒ∞≈ü√ßi Bilgisi (Sol taraf: Sayƒ±, Saƒü taraf: Hƒ±z)
        setHTML(
          "metalWorkers",
          `<span style="color:white">üë∑ ${metalWorkers}</span> 
           <span style="color:var(--gold); font-size:11px">‚ö°${metalRate}/s</span>`
        );

        // Kristal ƒ∞≈ü√ßi Bilgisi
        setHTML(
          "kristalWorkers",
          `<span style="color:white">üë∑ ${kristalWorkers}</span> 
           <span style="color:var(--neon); font-size:11px">‚ö°${kristalRate}/s</span>`
        );

        setText("metalFacLevel", `Lvl ${metalFacLvl}`);
        setText("kristalFacLevel", `Lvl ${kristalFacLvl}`);
        
        const metalEthCost = getUpgradeCost(metalFacLvl);
        const kristalEthCost = getUpgradeCost(kristalFacLvl);
        const metalBuildTime = getUpgradeTime(metalFacLvl);
        const kristalBuildTime = getUpgradeTime(kristalFacLvl);
        
        setText("costMetalFac", `Œû${metalEthCost} ETH`);
        setText("costKristalFac", `Œû${kristalEthCost} ETH`);
        setText("metalBuildTime", `‚è±Ô∏è ${formatTimeHours(metalBuildTime)}`);
        setText("kristalBuildTime", `‚è±Ô∏è ${formatTimeHours(kristalBuildTime)}`);
        setText("resUI", `‚öôÔ∏è: ${Math.floor(metal)} | üíé: ${Math.floor(kristal)}`);
        setText("healthUI", "‚ù§Ô∏è: " + health);

        updateEnergyCountdown();

        // Buton Durumlarƒ± (Upgrade S√ºreleri)
        const upMetalFacBtn = document.getElementById("upMetalFac");
        const now = Date.now();
        if (metalFacUpgradeEndTime > now) {
          const remainingTime = metalFacUpgradeEndTime - now;
          upMetalFacBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(remainingTime)}`;
          upMetalFacBtn.disabled = true;
        } else {
          upMetalFacBtn.innerHTML = `UPGRADE <span id="costMetalFac">Œû${metalEthCost} ETH</span>`;
          upMetalFacBtn.disabled = false;
        }

        const upKristalFacBtn = document.getElementById("upKristalFac");
        if (kristalFacUpgradeEndTime > now) {
          const remainingTime = kristalFacUpgradeEndTime - now;
          upKristalFacBtn.innerHTML = `‚è≥ UPGRADING... ${formatTime(remainingTime)}`;
          upKristalFacBtn.disabled = true;
        } else {
          upKristalFacBtn.innerHTML = `UPGRADE <span id="costKristalFac">Œû${kristalEthCost} ETH</span>`;
          upKristalFacBtn.disabled = false;
        }

        setDisabled("swapBtn", Math.min(Math.floor(metal), Math.floor(kristal)) <= 0);
      }

     
async function saveData(force = false) {
    if (!window.firebaseDB || !window.firebaseFunctions) return;

    const { doc, setDoc } = window.firebaseFunctions;
    const db = window.firebaseDB;

    // UI'dan veya globalden g√ºncel kodu al
    let currentRefCodeToSave = window.currentUserRefCode;
    if (!currentRefCodeToSave) {
        const uiText = document.getElementById("myRefCodeText").innerText;
        if (uiText && uiText !== "LOADING..." && uiText !== "WAITING...") {
            currentRefCodeToSave = uiText;
        }
    }

    const gameData = {
        metal: metal,
        kristal: kristal,
        tranium: tranium,
        
        // Varsa kodu kaydet, yoksa dokunma
        ...(currentRefCodeToSave && { myRefCode: currentRefCodeToSave }),
        // SKIP tu≈üuna basƒ±ldƒ±ysa bunu kaydet
        ...(window.tempRefActionTaken && { refActionTaken: true }),
        
        metalWorkers: metalWorkers,
        kristalWorkers: kristalWorkers,
        metalFacLvl: metalFacLvl,
        kristalFacLvl: kristalFacLvl,
        energy: energy,
        lastTime: Date.now(),
        notif4hSent: false, 
        notif6hSent: false,
        nextEnergyTime: nextEnergyTime,
        energyRegenerationStartTime: energyRegenerationStartTime,
        metalFacUpgradeEndTime: metalFacUpgradeEndTime,
        kristalFacUpgradeEndTime: kristalFacUpgradeEndTime
    };

    try {
        await setDoc(doc(db, "players", currentUserID), gameData, { merge: true });
    } catch (e) {
        console.error("Kayƒ±t hatasƒ±:", e);
    }
}

      function spawnWorker() {
        const isM = Math.random() > 0.5;
        workers.push({
          x: 100 + Math.random() * (WORLD_SIZE - 200),
          y: 100 + Math.random() * (WORLD_SIZE - 200),
          img: isM ? imgMiner1 : imgMiner2,
          type: isM ? "metal" : "kristal",
        });
      }

      function spawnEnemy() {
        enemies.push({
          x: Math.random() * WORLD_SIZE,
          y: Math.random() * WORLD_SIZE,
          isChasing: false,
          spawnTime: Date.now(),
          currentSpeed: 3.8,
        });
      }

// --- PAR√áACIK EFEKTƒ∞ (PARTICLE SYSTEM) ---
let particles = []; // Par√ßacƒ±klarƒ± tutacak liste

// --- PAR√áACIK EFEKTƒ∞ OLU≈ûTURMA (G√ºncellenmi≈ü) ---
function createExplosion(x, y, color) {
    // Par√ßacƒ±k sayƒ±sƒ±nƒ± 12'den 20'ye √ßƒ±kardƒ±k daha dolgun g√∂r√ºns√ºn
    for (let i = 0; i < 20; i++) {
        particles.push({
            x: x,
            y: y,
            // Hƒ±z aralƒ±ƒüƒ±nƒ± artƒ±rdƒ±k (-8 ile +8 arasƒ± rastgele hƒ±z)
            vx: (Math.random() - 0.5) * 16, 
            vy: (Math.random() - 0.5) * 16,
            // √ñm√ºrleri rastgele olsun (0.8 ile 1.2 arasƒ±)
            life: Math.random() * 0.4 + 0.8, 
            // Boyut varyasyonu ekleyelim (4 ile 7 arasƒ± yarƒ±√ßap)
            size: Math.random() * 3 + 4,
            color: color
        });
    }
}

function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.04; // Her karede biraz s√∂n
        
        if (p.life <= 0) {
            particles.splice(i, 1); // √ñmr√º biteni sil
        }
    }
}

// --- PAR√áACIKLARI √áƒ∞ZME (Yeni ≈ûekil: Parlayan Retro Elmas) ---
function drawParticles() {
    particles.forEach(p => {
        ctx.save();
        // √ñm√ºr azaldƒ±k√ßa s√∂n√ºkle≈üsin
        ctx.globalAlpha = p.life; 
        
        // Hafif bir parlama efekti ekleyelim
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 10; 
        ctx.fillStyle = p.color;

        // --- ELMAS ≈ûEKLƒ∞ √áƒ∞Zƒ∞Mƒ∞ (Kare yerine) ---
        ctx.beginPath();
        ctx.moveTo(p.x, p.y - p.size); // √úst u√ß
        ctx.lineTo(p.x + p.size, p.y); // Saƒü u√ß
        ctx.lineTo(p.x, p.y + p.size); // Alt u√ß
        ctx.lineTo(p.x - p.size, p.y); // Sol u√ß
        ctx.closePath();
        ctx.fill();
        // ----------------------------------------

        ctx.restore();
    });
}

// --- FLOATING TEXT (DOM) ---
function showFloatingText(text, color) {
    const el = document.createElement("div");
    el.className = "floating-text";
    el.innerText = text;
    el.style.color = color;
    document.body.appendChild(el);
    
    // Animasyon bitince (1.5sn) HTML'den temizle
    setTimeout(() => {
        el.remove();
    }, 1500);
}
      
     async function attemptStart() {
        if (energy > 0) {
          // 1. EKRANI Kƒ∞Lƒ∞TLE (Blocking Loader)
          showBlockingLoader();

          // 2. ENERJƒ∞ VE CANI AYARLA
          energy--;
          health = 3;
          updateEnergyTimers();
          
          // --- KRƒ∞Tƒ∞K EKLEME: SAHAYI SIFIRLA VE YENƒ∞DEN DOLDUR ---
          workers = []; // Eski listeyi sil
          enemies = []; // Eski d√º≈ümanlarƒ± sil
          
          // 50 Tane Yeni Madenci Koy
          for (let i = 0; i < 50; i++) spawnWorker();
          
          // 15 Tane Yeni D√º≈üman Koy
          for (let i = 0; i < 15; i++) spawnEnemy();
          // -------------------------------------------------------

          // 3. KESƒ∞N KAYIT AL (FORCE SAVE)
          await saveData(true); 
          
          // 4. EKRANI G√úNCELLE, Y√úKLEMEYƒ∞ KAPAT VE BA≈ûLA
          updateUI();
          hideBlockingLoader();

          document.getElementById("overlay").style.display = "none";
          document.getElementById("ui").style.display = "flex";
          document.getElementById("ui").style.opacity = "1";
          document.getElementById("joystickContainer").style.display = "block";
          
          // Oyuncu her ba≈üladƒ±ƒüƒ±nda merkeze d√∂ns√ºn (ƒ∞stersen kaldƒ±rabilirsin)
          player.x = WORLD_SIZE / 2;
          player.y = WORLD_SIZE / 2;
          player.targetX = player.x;
          player.targetY = player.y;
          player.isMoving = false;

          isStarted = true;
        } else {
          alert("Not enough energy! Wait for energy to regenerate.");
        }
      }
      function processMining(dtSec) {      
        const metalMultiplier = Math.pow(2, metalFacLvl - 1);
        const kristalMultiplier = Math.pow(2, kristalFacLvl - 1);

        const metalGain = dtSec * (metalWorkers * BASE_WORKER_SPEED * metalMultiplier);
        const kristalGain = dtSec * (kristalWorkers * BASE_WORKER_SPEED * kristalMultiplier);

        metal += metalGain;
        kristal += kristalGain;

        if (!isStarted) updateUI();
      }

      window.update = function(dt) {
        // 1. Par√ßacƒ±klarƒ± ve Madenciliƒüi G√ºncelle
        updateParticles(); 
        processMining(dt);
        checkUpgradeProgress();
        
        if (!isStarted) return;
        
        // 2. Oyuncu Hareketi (Joystick veya Tƒ±klama)
        if (joystickActive) {
          const moveSpeed = player.speed;
          player.x += joystickDirection.x * moveSpeed;
          player.y += joystickDirection.y * moveSpeed;
          player.flipX = joystickDirection.x < 0;
          player.isMoving = true;
          walkCycle += 0.35;
        } else {
          if (isTouching) {
            let dx = player.targetX - player.x,
              dy = player.targetY - player.y,
              dist = Math.hypot(dx, dy);
            if (dist > 5) {
              player.x += (dx / dist) * player.speed;
              player.y += (dy / dist) * player.speed;
              player.flipX = dx < 0;
              player.isMoving = true;
              walkCycle += 0.35;
            } else player.isMoving = false;
          }
        }

        // 3. Harita Sƒ±nƒ±rlarƒ± ve Kamera
        player.x = Math.max(50, Math.min(WORLD_SIZE - 50, player.x));
        player.y = Math.max(50, Math.min(WORLD_SIZE - 50, player.y));
        camera.x = Math.max(0, Math.min(WORLD_SIZE - canvas.width, player.x - canvas.width / 2));
        camera.y = Math.max(0, Math.min(WORLD_SIZE - canvas.height, player.y - canvas.height / 2));

        for (let i = workers.length - 1; i >= 0; i--) {
            let w = workers[i];
            if (Math.hypot(player.x - w.x, player.y - w.y) < 70) {
                
                // A) Efekti Olu≈ütur
                let pColor = (w.type === "metal") ? "#ffcc00" : "#00ffff";
                createExplosion(w.x, w.y, pColor);

                // B) Kaynaƒüƒ± Ekle
                if (w.type === "metal") metalWorkers++;
                else kristalWorkers++;
                
                // C) Listeden Sil ve UI G√ºncelle
                workers.splice(i, 1);
                updateUI();
            }
        }

        // 5. D√º≈üman Mantƒ±ƒüƒ±
        const now = Date.now();
        enemies.forEach((en, i) => {
          if (en.isChasing && now - en.chaseStartTime > 5000) {
            enemies.splice(i, 1);
            spawnEnemy();
            return;
          }
          let d = Math.hypot(player.x - en.x, player.y - en.y);
          if (d < 400 && !en.isChasing) {
            en.isChasing = true;
            en.chaseStartTime = now;
          }
          if (en.isChasing) {
            en.currentSpeed += 0.005;
            en.x += ((player.x - en.x) / d) * en.currentSpeed;
            en.y += ((player.y - en.y) / d) * en.currentSpeed;
          }
          if (d < 50) {
            health--;
            updateUI();
            enemies.splice(i, 1);
            spawnEnemy();
            if (health <= 0) {
              isStarted = false;
              saveData();
              endGame();
            }
          }
        });
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        // Kamera takibi burada yapƒ±lƒ±yor
        ctx.translate(-camera.x, -camera.y);
        
        // 1. Arkaplan
        if (imgBG.complete) ctx.drawImage(imgBG, 0, 0, WORLD_SIZE, WORLD_SIZE);
        
        // 2. Madenciler
        workers.forEach((w) => {
          ctx.save();
          ctx.shadowBlur = 10;
          ctx.shadowColor = w.type === "metal" ? "#ffcc00" : "#00ffff";
          ctx.drawImage(w.img, w.x - 40, w.y - 40, 80, 80);
          ctx.restore();
        });

        // 3. D√º≈ümanlar (ƒ∞√ßindeki drawParticles silindi)
        enemies.forEach((en) => {
          ctx.save();
          ctx.shadowBlur = 20;
          ctx.shadowColor = "red";
          ctx.fillStyle = "rgba(255, 0, 0, 0.25)";
          ctx.beginPath();
          ctx.arc(en.x, en.y, 45, 0, Math.PI * 2);
          ctx.fill();
          if (en.isChasing) {
            let tr = 5000 - (Date.now() - en.chaseStartTime);
            if (tr < 1000) ctx.globalAlpha = tr / 1000;
          }
          ctx.drawImage(imgInfected, en.x - 40, en.y - 50, 80, 100);
          ctx.restore();
        });

        // 4. EFEKTLER (D√º≈ümanlardan sonra, oyuncudan √∂nce)
        drawParticles(); 

        // 5. Oyuncu (Player)
        ctx.save();
        let bounce = player.isMoving ? Math.abs(Math.sin(walkCycle)) * 14 : 0;
        ctx.translate(player.x, player.y - bounce);
        if (player.flipX) ctx.scale(-1, 1);
        ctx.drawImage(imgDayi, -50, -60, 100, 120);
        ctx.restore();
        
        ctx.restore(); // Kamera translate restore
      }

      function gameLoop() {
        let now = Date.now();
        let dt = (now - lastUpdate) / 1000;
        lastUpdate = now;
        update(dt);
        draw();
        requestAnimationFrame(gameLoop);
      }

      const setTarget = (e) => {
        if (joystickActive) return;
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
        const cy = e.touches ? e.touches[0].clientY - rect.top : e.clientY - rect.top;

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        player.targetX = cx * scaleX + camera.x;
        player.targetY = cy * scaleY + camera.y;
        player.isMoving = true;
      };

      window.addEventListener("mousedown", (e) => {
        const joystickRect = document.getElementById("joystickContainer").getBoundingClientRect();
        if (
          e.clientX >= joystickRect.left &&
          e.clientX <= joystickRect.right &&
          e.clientY >= joystickRect.top &&
          e.clientY <= joystickRect.bottom
        ) {
          return;
        }

        isTouching = true;
        setTarget(e);
      });
      window.addEventListener("mousemove", (e) => {
        if (isTouching && !joystickActive) setTarget(e);
      });
      window.addEventListener("mouseup", () => {
        isTouching = false;
        if (!joystickActive) player.isMoving = false;
      });
      window.addEventListener(
        "touchstart",
        (e) => {
          const joystickRect = document.getElementById("joystickContainer").getBoundingClientRect();
          const touchX = e.touches[0].clientX;
          const touchY = e.touches[0].clientY;

          if (
            touchX >= joystickRect.left &&
            touchX <= joystickRect.right &&
            touchY >= joystickRect.top &&
            touchY <= joystickRect.bottom
          ) {
            return;
          }

          isTouching = true;
          setTarget(e);
        },
        { passive: false },
      );
      window.addEventListener(
        "touchmove",
        (e) => {
          e.preventDefault();
          if (isTouching && !joystickActive) setTarget(e);
        },
        { passive: false },
      );
      window.addEventListener("touchend", () => {
        isTouching = false;
        if (!joystickActive) player.isMoving = false;
      });
      function endGame() {
        document.getElementById("overlay").style.display = "flex";
        document.getElementById("ui").style.display = "none";
        document.getElementById("joystickContainer").style.display = "none";
        if (energyTimer) {
          clearInterval(energyTimer);
          energyTimer = null;
        }

        startEnergyCountdown();
        
        console.log("Game Over! Score: " + Math.floor(tranium));
      }

      // Initial call to setup the intro screen
      window.onload = function() {
        console.log("üöÄ App Loaded. Triggering Farcaster SDK...");
        
   
      };
      // --- REFERANS Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI ---

// Rastgele Ref Kodu Olu≈üturucu (5 Karakter)
function generateRefCode() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let result = "";
    for (let i = 0; i < 7; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Ref Kodunu Kopyalama
function copyRefCode() {
    const code = document.getElementById("myRefCodeText").innerText;
    if (code && code !== "LOADING...") {
        navigator.clipboard.writeText(code).then(() => {
            alert("Code Copied: " + code);
        });
    }
}

async function skipRefCode() {
    showBlockingLoader();
    
    // 1. Kendi kodunu olu≈ütur
    const newRefCode = generateRefCode();
    
    // 2. Veritabanƒ±na "se√ßim yapƒ±ldƒ±" (refActionTaken) bilgisini i≈üle
    const db = window.firebaseDB;
    const { doc, updateDoc } = window.firebaseFunctions;
    const myRef = doc(db, "players", currentUserID);

    try {
        await updateDoc(myRef, {
            refActionTaken: true, // Bir daha sorma
            myRefCode: newRefCode, // Kodunu ver
            usedRefCode: false
        });

        // 3. UI G√ºncelle
        document.getElementById("refInputModal").style.display = "none";
        const refTextEl = document.getElementById("myRefCodeText");
        if (refTextEl) refTextEl.innerText = newRefCode;
        window.currentUserRefCode = newRefCode;

        hideBlockingLoader();
    } catch (e) {
        console.error("Skip Error:", e);
        // Hata olursa (√∂rn: yeni kullanƒ±cƒ± updateDoc yapamazsa)
        hideBlockingLoader();
        document.getElementById("refInputModal").style.display = "none";
        window.currentUserRefCode = newRefCode;
        window.tempRefActionTaken = true; 
        saveData(true); // saveData ile yedekten kaydet
    }
}

// "ENTER" Butonuna Basƒ±lƒ±nca (Ref Kodu Kullanma)
// YARDIMCI FONKSƒ∞YON: Durum G√∂ster (Ye≈üil Tik veya Kƒ±rmƒ±zƒ± √áarpƒ±)
function showRefFeedback(type, message) {
    const overlay = document.getElementById("refStatusOverlay");
    const icon = document.getElementById("statusIcon");
    const text = document.getElementById("statusText");
    
    overlay.style.display = "flex";
    
    if (type === 'success') {
        icon.innerHTML = "‚úÖ";
        icon.style.textShadow = "0 0 20px #00ff00";
        text.style.color = "#00ff00";
        text.innerHTML = message || "SUCCESS!";
    } else {
        icon.innerHTML = "‚ùå";
        icon.style.textShadow = "0 0 20px #ff0000";
        text.style.color = "#ff4444";
        text.innerHTML = message || "ERROR!";
    }

    // 1 Saniye sonra ne olacaƒüƒ±nƒ± y√∂neten Promise
    return new Promise(resolve => setTimeout(() => {
        overlay.style.display = "none";
        resolve();
    }, 1200)); // Animasyon rahat g√∂r√ºns√ºn diye 1.2 sn
}

// G√úNCELLENMƒ∞≈û SUBMIT FONKSƒ∞YONU

      // YARDIMCI FONKSƒ∞YON: Durum G√∂ster (Ye≈üil Tik veya Kƒ±rmƒ±zƒ± √áarpƒ±)
function showRefFeedback(type, message) {
    const overlay = document.getElementById("refStatusOverlay");
    const icon = document.getElementById("statusIcon");
    const text = document.getElementById("statusText");
    
    // Eƒüer HTML'de bu elemanlar yoksa hata vermesin diye kontrol
    if(!overlay || !icon || !text) {
        console.error("Feedback elemanlarƒ± HTML'de bulunamadƒ±!");
        if(type === 'error') alert(message);
        return Promise.resolve();
    }
    
    overlay.style.display = "flex";
    
    if (type === 'success') {
        icon.innerHTML = "‚úÖ";
        icon.style.textShadow = "0 0 20px #00ff00";
        text.style.color = "#00ff00";
        text.innerHTML = message || "SUCCESS!";
    } else {
        icon.innerHTML = "‚ùå";
        icon.style.textShadow = "0 0 20px #ff0000";
        text.style.color = "#ff4444";
        text.innerHTML = message || "ERROR!";
    }

    // 1 Saniye sonra ne olacaƒüƒ±nƒ± y√∂neten Promise
    return new Promise(resolve => setTimeout(() => {
        overlay.style.display = "none";
        resolve();
    }, 1200)); 
}
      async function submitRefCode() {
    const inputCode = document.getElementById("refCodeInput").value.trim().toUpperCase();
    const myCode = document.getElementById("myRefCodeText").innerText;

    if (!inputCode) {
        await showRefFeedback('error', 'ENTER CODE');
        return;
    }
    if (inputCode === myCode) {
        await showRefFeedback('error', 'YOUR CODE!');
        return;
    }

    showBlockingLoader(); // B√ºy√ºk y√ºkleme ekranƒ±nƒ± a√ß

    try {
        const db = window.firebaseDB;
        const { collection, query, where, getDocs, updateDoc, doc } = window.firebaseFunctions;

        // 1. Bu kod kime ait?
        const usersRef = collection(db, "players");
        const q = query(usersRef, where("myRefCode", "==", inputCode));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
            hideBlockingLoader();
            // Alert yerine bizim √∂zel feedback fonksiyonumuz
            await showRefFeedback('error', 'INVALID CODE');
            return;
        }

        // 2. Kod ge√ßerli, sahibini bulduk
        let referrerId = "";
        let referrerCurrentTranium = 0;

        querySnapshot.forEach((doc) => {
            referrerId = doc.id;
            referrerCurrentTranium = parseFloat(doc.data().tranium) || 0;
        });

        // 3. √ñd√ºlleri Daƒüƒ±t
        const referrerRef = doc(db, "players", referrerId);
        await updateDoc(referrerRef, {
            tranium: referrerCurrentTranium + 20
        });

        // Benim verilerimi g√ºncelle
        tranium += 20; 
        
        const myRef = doc(db, "players", currentUserID);
        const newRefCode = generateRefCode(); // Kod girdikten sonra benim kodumu olu≈ütur
        
        await updateDoc(myRef, {
            refActionTaken: true,
            usedRefCode: true,
            myRefCode: newRefCode,
            tranium: tranium
        });
        
        // 4. ƒ∞≈ülem Tamam - UI G√ºncelle
        updateUI();
        hideBlockingLoader();
        
        // Kendi kodunu ekrana yaz
        document.getElementById("myRefCodeText").innerText = newRefCode;
        window.currentUserRefCode = newRefCode;

        // BA≈ûARILI FEEDBACK (Ye≈üil Tik)
        await showRefFeedback('success', '+20 TRANIUM');
        
        // Feedback bittikten sonra modalƒ± tamamen kapat
        document.getElementById("refInputModal").style.display = "none";

    } catch (error) {
        console.error("Ref Error:", error);
        hideBlockingLoader();
        await showRefFeedback('error', 'NET ERROR');
    }
}
    </script>
    <script>
      (function () {
        const fpsBox = document.createElement("div");
        fpsBox.id = "pc-fps-counter";
        fpsBox.style.cssText =
          "position:fixed; top:60px; left:10px; color:#00ffcc; font-family:monospace; font-size:11px; font-weight:bold; z-index:2147483647; background:rgba(0,0,0,0.6); padding:4px 8px; border:1px solid #00ffcc; border-radius:4px; pointer-events:none; display:none;";
        fpsBox.innerHTML = "FPS:...";
        document.body.appendChild(fpsBox);

        function lockPlayerSpeed() {
          try {
            if (typeof player !== "undefined" && player.speed !== 7.0) {
              player.speed = 7.0;
              Object.defineProperty(player, "speed", {
                value: 7.0,
                writable: false,
                configurable: true,
              });
            }
          } catch (e) {}
        }

        const originalInitHub = window.initHub;
        window.initHub = function () {
          if (originalInitHub) originalInitHub();

          const cvs = document.getElementById("gameCanvas");
          if (cvs) {
            let targetWidth = window.innerWidth;
            let targetHeight = window.innerHeight;

            if (targetWidth > 1920) {
              const ratio = window.innerHeight / window.innerWidth;
              targetWidth = 1920;
              targetHeight = 1920 * ratio;
            }

            cvs.width = targetWidth;
            cvs.height = targetHeight;
            cvs.style.width = "100vw";
            cvs.style.height = "100vh";
            cvs.style.transform = "translate3d(0,0,0)";
            cvs.style.imageRendering = "pixelated";
          }

          if (!("ontouchstart" in window) && navigator.maxTouchPoints === 0) {
            const joyContainer = document.getElementById("joystickContainer");
            if (joyContainer) joyContainer.style.display = "none";
            const style = document.createElement("style");
            style.innerHTML = "#joystickContainer { display: none!important; }";
            document.head.appendChild(style);
          }

          lockPlayerSpeed();
          fpsBox.style.display = "block";
          console.log("‚úÖ TURBO MODE: Player 7.0 | Enemy Max 6.6");
        };

        let lastTime = performance.now();
        let frameCount = 0;
        let lastFpsTime = performance.now();
        const targetFPS = 60;
        const frameDelay = 1000 / targetFPS;
        const originalRAF = window.requestAnimationFrame;
        function secureGameLoop() {
          originalRAF(secureGameLoop);

          const now = performance.now();
          const elapsed = now - lastTime;

          if (elapsed < frameDelay) return;
          lastTime = now - (elapsed % frameDelay);
          if (typeof player !== "undefined") {
            if (player.speed !== 7.0) player.speed = 7.0;
          }

          if (typeof enemies !== "undefined" && Array.isArray(enemies)) {
            enemies.forEach((en) => {
              if (en.currentSpeed > 6.6) {
                en.currentSpeed = 6.6;
              }
            });
          }

          frameCount++;
          if (now - lastFpsTime >= 1000) {
            fpsBox.innerHTML = "FPS: " + frameCount;
            frameCount = 0;
            lastFpsTime = now;
          }

          if (typeof window.update === "function" && typeof window.draw === "function") {
            window.update(0.016);
            window.draw();
          }
        }

        window.gameLoop = function () {};
        secureGameLoop();
      })();
    </script>
     // Bu kodu </body> kapanƒ±≈üƒ±ndan √∂nce ekleyin
<script>
    // Emergency splash screen remover
    setTimeout(() => {
        if (typeof sdk !== 'undefined' && sdk.actions && sdk.actions.ready) {
            sdk.actions.ready();
            console.log("üö® EMERGENCY: Force-ready sent");
        }
        
        // Fallback: window.parent'e mesaj g√∂nder (Farcaster √∂zel)
        try {
            window.parent.postMessage({
                type: 'ready',
                data: { ready: true }
            }, '*');
        } catch(e) {}
        
        // Fallback 2: URL'de ready parametresi
        if (window.location.search.includes('splash=1')) {
            window.history.replaceState({}, '', window.location.pathname);
        }
    }, 2000);

  
</script>
  </body>
</html>
